<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="300">
  <title>Claude Command Center</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #040409;
      --bg-secondary: #0a0a12;
      --bg-card: rgba(10, 12, 22, 0.85);
      --bg-hover: rgba(255,255,255,0.04);
      --bg-glass: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.07);
      --border-glow: rgba(0, 217, 255, 0.4);
      --text-primary: #eaeaf2;
      --text-secondary: #8a8a9a;
      --text-muted: #4a4a5a;
      --accent-primary: #00d9ff;
      --accent-red: #ff4d6a;
      --accent-orange: #ff7b54;
      --accent-yellow: #ffcc00;
      --accent-cyan: #00d9ff;
      --accent-green: #00ff88;
      --accent-purple: #b14eff;
      --gradient-primary: linear-gradient(135deg, #00d9ff, #00ff88);
      --gradient-accent: linear-gradient(135deg, #ff4d6a, #ff7b54);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      --glow-cyan: 0 0 24px rgba(0, 217, 255, 0.25), 0 0 48px rgba(0, 217, 255, 0.1);
      --glow-green: 0 0 24px rgba(0, 255, 136, 0.25), 0 0 48px rgba(0, 255, 136, 0.1);
      --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated background with ambient lighting */
    .bg-grid {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(0, 217, 255, 0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(0, 255, 136, 0.03) 0%, transparent 50%),
        linear-gradient(rgba(0, 217, 255, 0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 217, 255, 0.015) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 80px 80px, 80px 80px;
      pointer-events: none;
      z-index: 0;
      animation: gridPulse 12s ease-in-out infinite;
    }

    @keyframes gridPulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    /* Navigation */
    .nav {
      display: flex;
      align-items: center;
      background: rgba(4, 4, 9, 0.92);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 1px 0 rgba(0, 217, 255, 0.06), 0 4px 16px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(32px) saturate(1.3);
      -webkit-backdrop-filter: blur(32px) saturate(1.3);
      padding: 0 1.5rem;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.5rem 0;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .nav-brand-group {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .nav-logo {
      width: 32px;
      height: 32px;
      background: var(--gradient-primary);
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 0 12px rgba(0, 217, 255, 0.3), 0 0 4px rgba(0, 255, 136, 0.2);
    }

    .nav-title {
      font-size: 1.15rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .nav-tabs {
      display: flex;
      flex: 1;
      gap: 0.125rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .nav-tabs::-webkit-scrollbar {
      display: none;
    }

    .nav-tabs {
      padding: 0 0.5rem;
      scroll-padding: 0 2rem;
    }

    .nav-tab {
      padding: 1rem 0.75rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-bottom: 2px solid transparent;
      position: relative;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .nav-tab.active {
      color: var(--accent-cyan);
      border-bottom-color: var(--accent-cyan);
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
      background: rgba(0, 217, 255, 0.06);
      border-radius: 8px 8px 0 0;
      position: relative;
    }

    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 2px;
      background: var(--accent-cyan);
      box-shadow: 0 0 8px rgba(0, 217, 255, 0.6);
      border-radius: 2px;
    }

    .nav-tab .badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent-cyan);
      color: var(--bg-primary);
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 700;
    }

    .nav-actions {
      display: flex;
      gap: 0.75rem;
      padding: 0 0.5rem;
      flex-shrink: 0;
    }

    .nav-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.3s;
      letter-spacing: 0.3px;
    }

    .nav-btn:hover {
      background: rgba(0, 217, 255, 0.1);
      border-color: var(--border-glow);
      color: var(--accent-cyan);
      box-shadow: var(--glow-cyan);
    }

    /* Main Content */
    .main {
      position: relative;
      z-index: 1;
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .tab-content { display: none; animation: fadeIn 0.25s ease; }
    .tab-content.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.75rem;
      margin-bottom: 1.5rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: visible;
      backdrop-filter: blur(12px) saturate(1.2);
      -webkit-backdrop-filter: blur(12px) saturate(1.2);
      box-shadow: var(--card-shadow);
    }

    .card:hover {
      border-color: var(--border-glow);
      box-shadow: var(--glow-cyan), inset 0 1px 0 rgba(255,255,255,0.05);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .card h3 {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .card-badge {
      background: rgba(0, 217, 255, 0.08);
      color: var(--accent-cyan);
      padding: 0.3rem 0.875rem;
      border-radius: 20px;
      font-size: 0.65rem;
      font-weight: 600;
      border: 1px solid rgba(0, 217, 255, 0.15);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    /* Stagger entrance animation for stat cards */
    .stats-row .stat-card,
    .cost-hero .cost-card {
      animation: cardEntrance 0.5s ease backwards;
    }
    .stats-row .stat-card:nth-child(1), .cost-hero .cost-card:nth-child(1) { animation-delay: 0s; }
    .stats-row .stat-card:nth-child(2), .cost-hero .cost-card:nth-child(2) { animation-delay: 0.06s; }
    .stats-row .stat-card:nth-child(3), .cost-hero .cost-card:nth-child(3) { animation-delay: 0.12s; }
    .stats-row .stat-card:nth-child(4), .cost-hero .cost-card:nth-child(4) { animation-delay: 0.18s; }
    .stats-row .stat-card:nth-child(5) { animation-delay: 0.24s; }
    .stats-row .stat-card:nth-child(6) { animation-delay: 0.30s; }

    @keyframes cardEntrance {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Proactive Panel (Phase 4 - ProactiveVA) */
    .proactive-panel {
      margin-bottom: 1.5rem;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .proactive-card {
      background: linear-gradient(135deg, rgba(72,219,251,0.08), rgba(74,222,128,0.08));
      border-color: rgba(72,219,251,0.3);
    }

    .proactive-card:hover {
      border-color: rgba(72,219,251,0.5);
      box-shadow: 0 0 30px rgba(72,219,251,0.15);
    }

    .proactive-badge {
      background: rgba(72,219,251,0.2) !important;
      color: var(--accent-cyan) !important;
    }

    .suggestions-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }

    .suggestion-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-item:hover {
      background: rgba(72,219,251,0.1);
      border-color: rgba(72,219,251,0.3);
      transform: translateY(-2px);
    }

    .suggestion-type {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent-cyan);
      margin-bottom: 0.25rem;
    }

    .suggestion-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .suggestion-desc {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Stats Grid */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(160deg, rgba(12, 14, 24, 0.95), rgba(6, 6, 12, 0.95));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px) saturate(1.2);
      -webkit-backdrop-filter: blur(12px) saturate(1.2);
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.04);
    }

    .stat-card:hover {
      border-color: var(--border-glow);
      box-shadow: var(--glow-cyan), 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.06);
      transform: translateY(-2px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.4), rgba(0, 255, 136, 0.4), transparent);
    }

    .stat-card:nth-child(1):hover { border-color: rgba(0, 217, 255, 0.4); }
    .stat-card:nth-child(2):hover { border-color: rgba(0, 255, 136, 0.4); }
    .stat-card:nth-child(3):hover { border-color: rgba(255, 123, 84, 0.4); }
    .stat-card:nth-child(4):hover { border-color: rgba(177, 78, 255, 0.4); }
    .stat-card:nth-child(5):hover { border-color: rgba(255, 204, 0, 0.4); }
    .stat-card:nth-child(6):hover { border-color: rgba(255, 77, 106, 0.4); }

    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at top left, rgba(0, 217, 255, 0.04), transparent 60%);
      pointer-events: none;
    }

    .stat-card .icon {
      width: 44px;
      height: 44px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .stat-card .stat-value,
    .stat-card .value {
      font-size: clamp(1.4rem, 2.5vw, 2.1rem);
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1;
      font-family: 'JetBrains Mono', monospace;
      filter: drop-shadow(0 0 8px rgba(0, 217, 255, 0.15));
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .stat-card .stat-label,
    .stat-card .label {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .stat-card .trend {
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      font-size: 0.75rem;
      padding: 0.3rem 0.625rem;
      border-radius: 8px;
      font-weight: 600;
    }

    .stat-card .trend.up { background: rgba(0, 255, 136, 0.15); color: var(--accent-green); }
    .stat-card .trend.down { background: rgba(255, 77, 106, 0.15); color: var(--accent-red); }

    /* Model tag label (used in cost tab cards) */
    .model-tag {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--tag-color, var(--accent-cyan));
      margin-bottom: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 8px;
      background: color-mix(in srgb, var(--tag-color, var(--accent-cyan)) 12%, transparent);
      border: 1px solid color-mix(in srgb, var(--tag-color, var(--accent-cyan)) 25%, transparent);
      display: inline-block;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
    }

    .chart-container {
      height: 280px;
      position: relative;
      padding: 0.5rem 0.25rem;
    }

    /* Token Display */
    .token-bar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      padding: 1rem 0;
    }

    .token-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      text-align: center;
      min-width: 130px;
    }

    .token-item .value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .token-item .label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 0.25rem;
    }

    /* Memory Tab */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Fixed 4 columns */
      gap: 1.5rem;
    }

    @media (max-width: 1600px) {
      .memory-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .memory-section { margin-bottom: 0; }

    .memory-item {
      background: var(--bg-secondary);
      border-left: 3px solid var(--accent-cyan);
      padding: 1.125rem 1.5rem;
      margin-bottom: 0.875rem;
      border-radius: 0 14px 14px 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .memory-item:hover {
      background: rgba(0, 217, 255, 0.05);
      transform: translateX(8px);
      border-left-color: var(--accent-green);
    }

    .memory-item .content {
      color: var(--text-primary);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .memory-item .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.875rem;
    }

    .memory-item .time {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .memory-item .tags { display: flex; gap: 0.4rem; flex-wrap: wrap; }

    .tag {
      background: rgba(0, 217, 255, 0.1);
      color: var(--accent-cyan);
      padding: 0.25rem 0.7rem;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      border: 1px solid rgba(0, 217, 255, 0.2);
    }

    .tag.cyan { background: rgba(0, 217, 255, 0.1); color: var(--accent-cyan); border-color: rgba(0, 217, 255, 0.2); }
    .tag.green { background: rgba(0, 255, 136, 0.1); color: var(--accent-green); border-color: rgba(0, 255, 136, 0.2); }
    .tag.yellow { background: rgba(255, 204, 0, 0.1); color: var(--accent-yellow); border-color: rgba(255, 204, 0, 0.2); }

    /* Activity Tab */
    .activity-container {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 1.5rem;
    }

    @media (max-width: 1000px) {
      .activity-container { grid-template-columns: 1fr; }
    }

    .activity-timeline {
      background: var(--bg-secondary);
      border-radius: 16px;
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    .activity-item {
      display: flex;
      align-items: center;
      padding: 0.875rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .activity-item:hover {
      background: rgba(0, 217, 255, 0.03);
    }

    .activity-item .time {
      color: var(--text-muted);
      width: 85px;
      flex-shrink: 0;
    }

    .activity-item .type {
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      width: 75px;
      text-align: center;
      flex-shrink: 0;
      margin-right: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .activity-item .type.write { background: rgba(0, 255, 136, 0.12); color: var(--accent-green); border: 1px solid rgba(0, 255, 136, 0.2); }
    .activity-item .type.edit { background: rgba(255, 204, 0, 0.12); color: var(--accent-yellow); border: 1px solid rgba(255, 204, 0, 0.2); }
    .activity-item .type.bash { background: rgba(0, 217, 255, 0.12); color: var(--accent-cyan); border: 1px solid rgba(0, 217, 255, 0.2); }
    .activity-item .type.session { background: rgba(177, 78, 255, 0.12); color: var(--accent-purple); border: 1px solid rgba(177, 78, 255, 0.2); }

    .activity-item .detail {
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .activity-sidebar .card { margin-bottom: 1rem; }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 4px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 5px;
      background: var(--bg-secondary);
      position: relative;
      transition: all 0.2s;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 1;
    }

    .heatmap-cell::after {
      content: attr(data-hour);
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: var(--text-muted);
    }

    .heatmap-cell:nth-child(6n)::after { display: block; }
    .heatmap-cell:not(:nth-child(6n))::after { display: none; }

    /* Cost Tab */
    .cost-hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cost-card {
      background: linear-gradient(160deg, rgba(12, 14, 24, 0.95), rgba(6, 6, 12, 0.95));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.04);
    }

    .cost-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.4), rgba(0, 255, 136, 0.4), transparent);
    }

    .cost-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at top center, rgba(0, 217, 255, 0.04), transparent 60%);
      pointer-events: none;
    }

    .cost-card:hover {
      border-color: var(--border-glow);
      box-shadow: var(--glow-cyan), 0 8px 32px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }

    .cost-card .amount {
      font-size: clamp(1.6rem, 3vw, 2.75rem);
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 12px rgba(0, 217, 255, 0.2));
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cost-card.savings .amount {
      background: linear-gradient(135deg, #00ff88, #00d9ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .cost-card.savings::before {
      background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.5), rgba(0, 217, 255, 0.5), transparent);
    }

    .cost-card .label {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-top: 0.75rem;
      font-weight: 500;
    }

    .efficiency-bar {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .efficiency-track {
      height: 20px;
      background: linear-gradient(90deg, rgba(255, 77, 106, 0.4), rgba(255, 77, 106, 0.2));
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 77, 106, 0.2);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .efficiency-fill {
      height: 100%;
      background: linear-gradient(90deg, rgba(0, 255, 136, 0.7), rgba(0, 217, 255, 0.7));
      border-radius: 10px;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      right: 0;
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.3);
    }

    .efficiency-label {
      display: flex;
      justify-content: space-between;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Projects Tab */
    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 1.5rem;
    }

    .project-card {
      background: linear-gradient(135deg, rgba(13, 13, 20, 0.9), rgba(5, 5, 8, 0.9));
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.75rem;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .project-card:hover {
      border-color: var(--border-glow);
      box-shadow: var(--glow-cyan);
      transform: translateY(-3px);
    }

    .project-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 3px;
      height: 100%;
    }

    .project-card.os-app::before { background: var(--accent-cyan); }
    .project-card.career::before { background: var(--accent-green); }
    .project-card.research::before { background: var(--accent-yellow); }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .project-name {
      font-size: 1.3rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .project-status {
      padding: 0.35rem 0.875rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .project-status.active {
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent-green);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .project-stack {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 1.25rem;
    }

    .project-stats {
      display: flex;
      gap: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border);
    }

    .project-stat .value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent-cyan);
      font-family: 'JetBrains Mono', monospace;
    }

    .project-stat .label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Commands Tab */
    .commands-section {
      margin-bottom: 2.5rem;
    }

    .commands-section h4 {
      font-size: 1rem;
      color: var(--accent-cyan);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }

    .commands-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }

    .command-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.125rem 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.625rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .command-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-2px);
      background: rgba(0, 217, 255, 0.03);
    }

    .command-card code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.1);
      padding: 0.45rem 0.9rem;
      border-radius: 8px;
      word-break: break-word;
      max-width: 100%;
      border: 1px solid rgba(0, 217, 255, 0.15);
    }

    .command-card .desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* Observatory Styles */
    .sessions-list, .top-commands-list, .failure-patterns-list, .file-activity-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .session-item, .command-item, .failure-item, .file-item, .command-row {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .command-row .command-rank {
      color: var(--text-muted);
      font-size: 0.85rem;
      min-width: 2.5rem;
    }

    .command-row .command-name {
      flex: 1;
      color: var(--accent-cyan);
      font-family: var(--font-mono);
    }

    .command-row .command-count {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .session-item:hover, .command-item:hover, .failure-item:hover, .file-item:hover, .command-row:hover {
      border-color: var(--border-glow);
      background: rgba(0, 217, 255, 0.02);
    }

    .session-item .session-info {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .session-item .session-outcome {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .session-item .session-outcome.success { color: var(--accent-green); }
    .session-item .session-outcome.partial { color: var(--accent-yellow); }
    .session-item .session-outcome.error { color: var(--accent-red); }
    .session-item .session-outcome.abandoned { color: var(--text-muted); }
    .session-item .session-outcome.research { color: var(--accent-purple); }

    .session-item .session-note {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .session-item .session-quality {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      color: var(--accent-yellow);
    }

    .assessment-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .assessment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .assessment-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .assessment-value {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
    }

    .git-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.25rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .git-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .git-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .git-stat-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-align: center;
    }

    .no-data {
      color: var(--text-muted);
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem;
      font-style: italic;
    }

    .no-data code {
      color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-style: normal;
    }

    /* Search Box */
    .search-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.875rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.875rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s;
    }

    .search-box:focus-within {
      border-color: var(--border-glow);
      box-shadow: var(--glow-cyan);
    }

    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .search-box input::placeholder { color: var(--text-muted); }

    /* Keyboard Shortcuts */
    kbd {
      background: rgba(0, 217, 255, 0.08);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 6px;
      padding: 0.25rem 0.6rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent-cyan);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0, 217, 255, 0.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0, 217, 255, 0.5); }

    /* Live indicator */
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-size: 0.75rem;
      color: var(--accent-green);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: livePulse 2s ease-in-out infinite;
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
    }

    @keyframes livePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 0.625rem 2rem;
      color: var(--text-muted);
      font-size: 0.7rem;
      border-top: 1px solid rgba(255,255,255,0.04);
      background: rgba(4, 4, 9, 0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      position: sticky;
      bottom: 0;
      z-index: 99;
    }

    .footer kbd {
      margin: 0 0.2rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
    }

    /* Co-Evolution Tab Styles */
    .coevo-status {
      display: flex;
      flex-direction: column;
      gap: 1.125rem;
      padding: 1.25rem;
    }

    .coevo-config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .coevo-config-item:hover {
      border-color: var(--border-glow);
    }

    .config-label {
      color: var(--text-secondary);
    }

    .config-value {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .patterns-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .pattern-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg-hover);
      border-radius: 8px;
      border-left: 3px solid var(--accent-cyan);
    }

    .pattern-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .pattern-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .pattern-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .pattern-confidence {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      padding: 0.25rem 0.75rem;
      background: rgba(72, 219, 251, 0.1);
      border: 1px solid var(--accent-cyan);
      border-radius: 4px;
      color: var(--accent-cyan);
    }

    #coevo .stat-card {
      border-top: 2px solid var(--accent-cyan);
    }

    /* Context Efficiency Tab Styles */
    .top-packs-list, .pack-combos-list, .pack-inventory-list {
      display: flex;
      flex-direction: column;
      gap: 0.875rem;
      padding: 1.25rem;
    }

    .pack-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .pack-item:hover {
      border-color: var(--border-glow);
      background: var(--bg-hover);
    }

    .pack-info {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .pack-name {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .pack-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.825rem;
      color: var(--text-secondary);
    }

    .pack-stats {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .pack-stat {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .pack-stat-value {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-green);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .pack-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .combo-item {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1.125rem 1.25rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .combo-item:hover {
      border-color: var(--border-glow);
    }

    .combo-packs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .combo-pack-tag {
      padding: 0.375rem 0.875rem;
      background: rgba(0, 217, 255, 0.1);
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--accent-cyan);
    }

    .combo-stats {
      display: flex;
      gap: 2rem;
      font-size: 0.85rem;
    }

    .combo-stat {
      display: flex;
      gap: 0.5rem;
      color: var(--text-secondary);
    }

    .combo-stat-value {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent-green);
      font-weight: 600;
    }

    /* Routing Styles */
    .routing-progress {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 1rem 0;
    }

    .progress-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .progress-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-primary);
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--glow-cyan);
    }

    .routing-targets {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem 0;
    }

    .target-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .target-item:hover {
      background: var(--bg-hover);
      border-color: var(--border-glow);
    }

    .target-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      flex: 1;
    }

    .target-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 600;
      margin-right: 1rem;
    }

    .target-status {
      font-size: 1.2rem;
    }

    /* Session Window Panel */
    .session-window-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .session-progress-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .session-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      min-width: 120px;
    }

    .session-progress-bar {
      flex: 1;
      height: 12px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .session-progress-fill {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 5px;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
    }

    .session-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-cyan);
      min-width: 50px;
      text-align: right;
    }

    .session-stats-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .session-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 1rem;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-width: 80px;
    }

    .session-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .session-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 0.25rem;
    }

    .session-recommendations {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .session-rec {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
      background: rgba(0, 217, 255, 0.1);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 6px;
      color: var(--accent-cyan);
    }

    .tier-comfortable { background: rgba(0, 255, 136, 0.15); border-color: var(--accent-green); }
    .tier-moderate { background: rgba(255, 204, 0, 0.15); border-color: var(--accent-yellow); }
    .tier-low { background: rgba(255, 123, 84, 0.15); border-color: var(--accent-orange); }
    .tier-critical { background: rgba(255, 77, 106, 0.15); border-color: var(--accent-red); }

    /* 10X POWER DASHBOARD */
    .power-dashboard {
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.05), rgba(177, 78, 255, 0.05));
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .power-dashboard::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple), var(--accent-green));
    }

    .power-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }

    .power-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .power-modes {
      display: flex;
      gap: 0.5rem;
    }

    .power-mode-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .power-mode-btn:hover {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .power-mode-btn.active {
      background: rgba(0, 217, 255, 0.15);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .power-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 1200px) {
      .power-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .power-grid { grid-template-columns: 1fr; }
    }

    .power-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .power-card:hover {
      border-color: rgba(0, 217, 255, 0.2);
      box-shadow: 0 0 12px rgba(0, 217, 255, 0.06);
    }

    .power-card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .power-card-header h4 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .power-icon {
      font-size: 1rem;
    }

    .cognitive-mode {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .mode-indicator {
      font-size: 1.2rem;
    }

    .mode-indicator.morning { color: #ffcc00; }
    .mode-indicator.peak { color: #00ff88; }
    .mode-indicator.dip { color: #ff7b54; }
    .mode-indicator.evening { color: #00d9ff; }
    .mode-indicator.deep_night { color: #b14eff; }

    .cognitive-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .session-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .session-progress {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .session-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .memory-stat {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .memory-stat span:first-child {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .memory-stat small {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .agent-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
      font-size: 0.85rem;
    }

    .agent-indicator {
      font-size: 0.9rem;
    }

    .agent-indicator.running { color: var(--accent-green); }
    .agent-indicator.stopped { color: var(--text-muted); }

    .power-recommendations {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 204, 0, 0.08);
      border: 1px solid rgba(255, 204, 0, 0.2);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav class="nav">
    <div class="nav-brand">
      <div class="nav-logo">C</div>
      <div class="nav-brand-group">
        <div class="nav-title">Command Center</div>
        <div id="live-slot"></div>
      </div>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">Overview</button>
      <button class="nav-tab" data-tab="memory">Memory</button>
      <button class="nav-tab" data-tab="activity">Activity</button>
      <button class="nav-tab" data-tab="cost">Cost</button>
      <button class="nav-tab" data-tab="projects">Projects</button>
      <button class="nav-tab" data-tab="commands">Commands</button>
      <button class="nav-tab" data-tab="routing">Routing</button>
      <button class="nav-tab" data-tab="coevo">Co-Evo</button>
      <button class="nav-tab" data-tab="context-efficiency">Packs</button>
      <button class="nav-tab" data-tab="session-outcomes">Outcomes</button>
      <button class="nav-tab" data-tab="productivity">Productivity</button>
      <button class="nav-tab" data-tab="tool-analytics">Tools</button>
      <button class="nav-tab" data-tab="supermemory">Supermem</button>
      <button class="nav-tab" data-tab="cognitive">Cognitive</button>
      <button class="nav-tab" data-tab="infrastructure">Infra</button>
      <button class="nav-tab" data-tab="autonomy">Autonomy</button>
      <button class="nav-tab" data-tab="velocity">Velocity</button>
    </div>
    <div class="nav-actions">
      <button class="nav-btn" onclick="location.reload()">Refresh</button>
    </div>
  </nav>

  <main class="main">
    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
      <div class="stats-row" id="statsRow"></div>

      <!-- PROACTIVE SUGGESTIONS (Phase 4 - ProactiveVA) -->
      <div id="proactivePanel" class="proactive-panel" style="display:none;">
        <div class="card proactive-card">
          <div class="card-header">
            <h3><span id="proactiveIcon">üéØ</span> <span id="proactiveTitle">Proactive Suggestions</span></h3>
            <span class="card-badge proactive-badge" id="proactivePattern">Detecting...</span>
          </div>
          <div class="proactive-content">
            <p id="proactiveContext" style="color:var(--text-secondary);margin-bottom:1rem;"></p>
            <div id="proactiveSuggestions" class="suggestions-list"></div>
          </div>
        </div>
      </div>

      <!-- 10X POWER DASHBOARD -->
      <div class="power-dashboard" id="powerDashboard">
        <div class="power-header">
          <h2>10x Power Dashboard</h2>
          <div class="power-modes">
            <button class="power-mode-btn active" data-mode="quick">Quick</button>
            <button class="power-mode-btn" data-mode="full">Full</button>
            <button class="power-mode-btn" data-mode="boost">Boost</button>
          </div>
        </div>
        <div class="power-grid">
          <!-- Cognitive State -->
          <div class="power-card cognitive-card">
            <div class="power-card-header">
              <span class="power-icon">üß†</span>
              <h4>Cognitive State</h4>
            </div>
            <div class="power-card-body" id="cognitiveState">
              <div class="cognitive-mode">
                <span class="mode-indicator" id="cogModeIndicator">‚óè</span>
                <span id="cogModeLabel">Loading...</span>
              </div>
              <div class="cognitive-details">
                <span class="energy-label">Energy: <strong id="cogEnergy">--</strong></span>
                <span class="best-for">Best for: <strong id="cogBestFor">--</strong></span>
              </div>
            </div>
          </div>

          <!-- Session Status -->
          <div class="power-card session-card">
            <div class="power-card-header">
              <span class="power-icon">üìä</span>
              <h4>Session Status</h4>
            </div>
            <div class="power-card-body" id="sessionStatus">
              <div class="session-bar">
                <div class="session-progress" id="sessionProgress" style="width:0%"></div>
              </div>
              <div class="session-details">
                <span>Position: <strong id="sessionPosition">--%</strong></span>
                <span>Budget: <strong id="sessionBudget">--</strong></span>
              </div>
            </div>
          </div>

          <!-- Supermemory Quick -->
          <div class="power-card memory-card">
            <div class="power-card-header">
              <span class="power-icon">üß¨</span>
              <h4>Supermemory</h4>
            </div>
            <div class="power-card-body" id="memoryQuick">
              <div class="memory-stat">
                <span id="memoryDue">0</span>
                <small>items due</small>
              </div>
              <div class="memory-stat">
                <span id="memoryTotal">0</span>
                <small>total memories</small>
              </div>
            </div>
          </div>

          <!-- Autonomous Agents -->
          <div class="power-card agents-card">
            <div class="power-card-header">
              <span class="power-icon">ü§ñ</span>
              <h4>Autonomous Agents</h4>
            </div>
            <div class="power-card-body" id="agentsStatus">
              <div class="agent-row">
                <span class="agent-indicator" id="ralphIndicator">‚óã</span>
                <span>Ralph TUI: <strong id="ralphStatus">Not running</strong></span>
              </div>
              <div class="agent-row">
                <span class="agent-indicator" id="bgIndicator">‚óã</span>
                <span>Background: <strong id="bgAgents">0 active</strong></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Latest Session -->
        <div class="power-recommendations" id="latestSessionBar" style="margin-bottom:0.5rem;background:rgba(0,217,255,0.04);border-color:rgba(0,217,255,0.12);">
          <span class="power-icon">‚ö°</span>
          <span id="latestSessionInfo" style="font-size:0.78rem;color:var(--text-secondary);">Waiting for session data...</span>
        </div>

        <!-- Recommendations -->
        <div class="power-recommendations" id="powerRecommendations">
          <span class="power-icon">üí°</span>
          <span id="recommendationText">Loading recommendations...</span>
        </div>

        <!-- Full Mode Panels (hidden by default) -->
        <div class="power-extended" id="powerExtended" style="display:none;">
          <div class="power-grid" style="margin-top:1rem;">
            <!-- Error Prevention -->
            <div class="power-card">
              <div class="power-card-header">
                <span class="power-icon">üõ°Ô∏è</span>
                <h4>Error Prevention</h4>
              </div>
              <div class="power-card-body" id="errorPrevention">
                <div class="agent-row">
                  <span>Auto-fix rate:</span>
                  <strong id="autoFixRate">--</strong>
                </div>
                <div class="agent-row">
                  <span>Recent fixes:</span>
                  <strong id="recentFixes">--</strong>
                </div>
              </div>
            </div>

            <!-- Observatory -->
            <div class="power-card">
              <div class="power-card-header">
                <span class="power-icon">üî≠</span>
                <h4>Observatory</h4>
              </div>
              <div class="power-card-body" id="observatoryQuick">
                <div class="agent-row">
                  <span>Sessions (7d):</span>
                  <strong id="obsSessions">--</strong>
                </div>
                <div class="agent-row">
                  <span>Success rate:</span>
                  <strong id="obsSuccess">--</strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Boost Mode Panels (hidden by default) -->
        <div class="power-boost" id="powerBoost" style="display:none;">
          <div class="power-grid" style="margin-top:1rem;">
            <!-- Context Packs -->
            <div class="power-card">
              <div class="power-card-header">
                <span class="power-icon">üì¶</span>
                <h4>Context Packs</h4>
              </div>
              <div class="power-card-body" id="contextPacks">
                <div class="agent-row">
                  <span>Active packs:</span>
                  <strong id="activePacks">--</strong>
                </div>
                <div class="agent-row">
                  <span>Tokens saved:</span>
                  <strong id="tokensSaved">--</strong>
                </div>
              </div>
            </div>

            <!-- Model Routing -->
            <div class="power-card">
              <div class="power-card-header">
                <span class="power-icon">üéØ</span>
                <h4>Model Routing</h4>
              </div>
              <div class="power-card-body" id="modelRouting">
                <div class="agent-row">
                  <span>Recommended:</span>
                  <strong id="recommendedModel">--</strong>
                </div>
                <div class="agent-row">
                  <span>DQ Score:</span>
                  <strong id="dqScore">--</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Messages Over Time</h3>
            <span class="card-badge">All Time</span>
          </div>
          <div class="chart-container"><canvas id="messagesChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Tool Usage</h3>
            <span class="card-badge">By Day</span>
          </div>
          <div class="chart-container"><canvas id="toolsChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Token Consumption</h3>
            <span class="card-badge">By Model</span>
          </div>
          <div class="chart-container"><canvas id="tokensChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Activity by Hour</h3>
            <span class="card-badge">Sessions</span>
          </div>
          <div class="chart-container"><canvas id="hourChart"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Token Breakdown</h3>
          <span class="card-badge" id="modelBadge">Opus 4.6</span>
        </div>
        <div class="token-bar" id="tokenBreakdown"></div>
      </div>
    </div>

    <!-- MEMORY TAB -->
    <div id="memory" class="tab-content">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="memTotalItems">‚Äî</div>
          <div class="stat-label">Total Knowledge</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memFactCount">‚Äî</div>
          <div class="stat-label">Facts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memDecisionCount">‚Äî</div>
          <div class="stat-label">Decisions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memPatternCount">‚Äî</div>
          <div class="stat-label">Patterns</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memProjectCount">‚Äî</div>
          <div class="stat-label">Projects</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="memTagCount">‚Äî</div>
          <div class="stat-label">Unique Tags</div>
        </div>
      </div>

      <!-- Knowledge Distribution + Top Tags -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üìä Knowledge Distribution</h3>
            <span class="card-badge" id="memDistBadge">By Type</span>
          </div>
          <div class="chart-container"><canvas id="memDistChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>üè∑Ô∏è Top Tags</h3>
            <span class="card-badge" id="memTagBadge">All Types</span>
          </div>
          <div class="chart-container"><canvas id="memTagChart"></canvas></div>
        </div>
      </div>

      <!-- Monthly Growth + Tag by Type -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üìà Knowledge Growth</h3>
            <span class="card-badge" id="memGrowthBadge">Monthly</span>
          </div>
          <div class="chart-container"><canvas id="memGrowthChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>üß¨ Tags by Knowledge Type</h3>
            <span class="card-badge">Breakdown</span>
          </div>
          <div class="chart-container"><canvas id="memTagTypeChart"></canvas></div>
        </div>
      </div>

      <!-- Interactive Memory Chat -->
      <div class="card" style="margin-bottom:1rem;">
        <div class="card-header">
          <h3>üí¨ Ask Your Memory</h3>
          <span class="card-badge" id="memChatBadge">5,591 searchable</span>
        </div>
        <div id="memChatMessages" style="min-height:60px;max-height:400px;overflow-y:auto;padding:0.75rem;display:flex;flex-direction:column;gap:0.5rem;">
          <div style="color:var(--text-muted);font-size:0.85rem;padding:1rem;text-align:center;">
            Ask anything about your decisions, facts, patterns, learnings, or error solutions.<br>
            <span style="font-size:0.75rem;opacity:0.6;">Searches knowledge.json (semantic) + supermemory.db (FTS) + sessions (keyword)</span>
          </div>
        </div>
        <div style="display:flex;gap:0.5rem;padding:0.75rem;border-top:1px solid rgba(255,255,255,0.06);">
          <select id="memChatSource" style="background:var(--bg-glass);border:1px solid rgba(255,255,255,0.1);color:var(--text-secondary);border-radius:6px;padding:0.4rem 0.6rem;font-size:0.8rem;">
            <option value="all">All Sources</option>
            <option value="knowledge">Knowledge</option>
            <option value="supermemory">Supermemory</option>
            <option value="sessions">Sessions</option>
          </select>
          <input type="text" id="memChatInput" placeholder="What did I decide about...?" style="flex:1;background:var(--bg-glass);border:1px solid rgba(255,255,255,0.1);color:var(--text-primary);border-radius:6px;padding:0.5rem 0.75rem;font-size:0.85rem;outline:none;" />
          <button id="memChatSend" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:white;border-radius:6px;padding:0.5rem 1rem;cursor:pointer;font-size:0.85rem;font-weight:600;white-space:nowrap;">Search</button>
        </div>
      </div>

      <!-- Filter Search + Item Lists -->
      <div class="search-box">
        <span>üîç</span>
        <input type="text" id="memorySearch" placeholder="Filter displayed memories...">
      </div>
      <div class="memory-grid">
        <div class="card memory-section">
          <div class="card-header">
            <h3>üìã Decisions</h3>
            <span class="card-badge" id="decisionCount">0</span>
          </div>
          <div id="memoryDecisions" style="max-height:400px;overflow-y:auto;"></div>
        </div>
        <div class="card memory-section">
          <div class="card-header">
            <h3>üìå Facts</h3>
            <span class="card-badge" id="factCount">0</span>
          </div>
          <div id="memoryFacts" style="max-height:400px;overflow-y:auto;"></div>
        </div>
        <div class="card memory-section">
          <div class="card-header">
            <h3>üîÑ Patterns</h3>
            <span class="card-badge" id="patternCount">0</span>
          </div>
          <div id="memoryPatterns" style="max-height:400px;overflow-y:auto;"></div>
        </div>
        <div class="card memory-section">
          <div class="card-header">
            <h3>üìÅ Project Context</h3>
            <span class="card-badge" id="projectMemCount">0</span>
          </div>
          <div id="memoryProjects" style="max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- ACTIVITY TAB -->
    <div id="activity" class="tab-content">
      <div class="stats-row">
        <div class="stat-card">
          <div class="icon">üìù</div>
          <div class="value" id="todayActions">0</div>
          <div class="label">All-Time Actions</div>
        </div>
        <div class="stat-card">
          <div class="icon">‚úèÔ∏è</div>
          <div class="value" id="todayWrites">0</div>
          <div class="label">Files Written</div>
        </div>
        <div class="stat-card">
          <div class="icon">üîß</div>
          <div class="value" id="todayEdits">0</div>
          <div class="label">Files Edited</div>
        </div>
        <div class="stat-card">
          <div class="icon">üíª</div>
          <div class="value" id="todayBash">0</div>
          <div class="label">Bash Commands</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily Tool Activity</h3>
            <span class="card-badge" id="toolDaysCount">0 days</span>
          </div>
          <div class="chart-container"><canvas id="dailyToolActivityChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Tool Breakdown</h3>
            <span class="card-badge" id="toolTotalCount">0 total</span>
          </div>
          <div class="chart-container"><canvas id="toolBreakdownChart"></canvas></div>
        </div>
      </div>

      <div class="activity-container">
        <div class="card">
          <div class="card-header">
            <h3>Today's Timeline</h3>
            <span class="card-badge" id="activityCount">0 entries</span>
          </div>
          <div class="activity-timeline" id="activityLog"></div>
        </div>
        <div class="activity-sidebar">
          <div class="card">
            <div class="card-header">
              <h3>Hour Heatmap</h3>
            </div>
            <div class="heatmap-grid" id="heatmapGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- COST TAB -->
    <div id="cost" class="tab-content">
      <div class="cost-hero">
        <div class="cost-card">
          <div class="amount" id="costApiValue">$0</div>
          <div class="label">API Value (All Time)</div>
        </div>
        <div class="cost-card">
          <div class="amount" id="costSubscription">$0</div>
          <div class="label">Subscription Paid</div>
        </div>
        <div class="cost-card savings">
          <div class="amount" id="costRoi">0x</div>
          <div class="label">ROI Multiplier</div>
        </div>
        <div class="cost-card savings">
          <div class="amount" id="costSaved">$0</div>
          <div class="label">Cache Savings</div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="model-tag" style="--tag-color: var(--accent-red);">Opus</div>
          <div class="value" id="costOpus">$0</div>
          <div class="label" id="costOpusPct">0%</div>
        </div>
        <div class="stat-card">
          <div class="model-tag" style="--tag-color: var(--accent-cyan);">Sonnet</div>
          <div class="value" id="costSonnet">$0</div>
          <div class="label" id="costSonnetPct">0%</div>
        </div>
        <div class="stat-card">
          <div class="model-tag" style="--tag-color: var(--accent-yellow);">Haiku</div>
          <div class="value" id="costHaiku">$0</div>
          <div class="label" id="costHaikuPct">0%</div>
        </div>
        <div class="stat-card">
          <div class="model-tag" style="--tag-color: var(--accent-green);">Avg/Day</div>
          <div class="value" id="costAvgDay">$0</div>
          <div class="label" id="costDaysCount">0 days</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Cache Efficiency</h3>
          <span class="card-badge" id="efficiencyPercent">0%</span>
        </div>
        <div class="efficiency-bar">
          <div class="efficiency-track">
            <div class="efficiency-fill" id="efficiencyFill" style="width: 0%"></div>
          </div>
          <div class="efficiency-label">
            <span id="cacheMissLabel">0% Cache Miss (Paid)</span>
            <span id="cacheHitLabel">100% Cache Hit (Free)</span>
          </div>
        </div>
        <div class="efficiency-details" style="display: flex; justify-content: space-between; margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted);">
          <span>Input Tokens: <span id="inputTokensDisplay">0</span></span>
          <span>Output Tokens: <span id="outputTokensDisplay">0</span></span>
          <span>Cache Read: <span id="cacheReadDisplay">0</span></span>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily API Cost vs Subscription</h3>
            <span class="card-badge">Per-Model Pricing</span>
          </div>
          <div class="chart-subtitle" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Opus $5/$25, Sonnet $3/$15, Haiku $1/$5 per MTok (in/out) + cache reads | $200/mo subscription line</div>
          <div class="chart-container"><canvas id="costChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Cost by Model</h3>
            <span class="card-badge">All Time</span>
          </div>
          <div class="chart-subtitle" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Stacked daily cost showing which model drives spend</div>
          <div class="chart-container"><canvas id="modelCostChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Token Distribution</h3>
            <span class="card-badge">All Models</span>
          </div>
          <div class="chart-container"><canvas id="efficiencyChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Cumulative ROI</h3>
            <span class="card-badge" id="roiBadge">0x</span>
          </div>
          <div class="chart-subtitle" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Running total: API value vs subscription cost over time</div>
          <div class="chart-container"><canvas id="roiChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- PROJECTS TAB -->
    <div id="projects" class="tab-content">
      <div class="stats-row" id="projectsStatsRow"></div>

      <!-- Project Charts -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Lines of Code by Project</h3>
            <span class="card-badge" id="projLinesBadge">Top 10</span>
          </div>
          <div class="chart-container"><canvas id="projLinesChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>File Type Distribution</h3>
            <span class="card-badge" id="projFilesBadge">All Projects</span>
          </div>
          <div class="chart-container"><canvas id="projFilesChart"></canvas></div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Recent Activity (7d)</h3>
            <span class="card-badge">Commits</span>
          </div>
          <div class="chart-container"><canvas id="projActivityChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Total Commits by Project</h3>
            <span class="card-badge" id="projCommitsBadge">All Time</span>
          </div>
          <div class="chart-container"><canvas id="projCommitsChart"></canvas></div>
        </div>
      </div>

      <!-- Project Cards Grid -->
      <div class="projects-grid" id="projectsList"></div>
    </div>

    <!-- COMMANDS TAB -->
    <div id="commands" class="tab-content">
      <div class="stats-row" id="commandsStatsRow"></div>
      <div class="search-box" style="margin-bottom:1rem;">
        <span>üîç</span>
        <input type="text" id="commandSearch" placeholder="Search commands..." />
      </div>
      <div class="commands-section">
        <h4>üöÄ Quick Start</h4>
        <div class="commands-grid">
          <div class="command-card"><code>cx</code><div class="desc">Start Claude tmux session</div></div>
          <div class="command-card"><code>ccc</code><div class="desc">Open Command Center (this dashboard)</div></div>
          <div class="command-card"><code>cterm</code><div class="desc">Terminal dashboard</div></div>
          <div class="command-card"><code>ccost</code><div class="desc">Cost tracker</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>ü§ñ Model Selection</h4>
        <div class="commands-grid">
          <div class="command-card"><code>cq "..."</code><div class="desc">Haiku 4.5 ‚Äî quick questions ($1/$5 in/out)</div></div>
          <div class="command-card"><code>cc</code><div class="desc">Sonnet 4.5 ‚Äî standard coding ($3/$15 in/out)</div></div>
          <div class="command-card"><code>co</code><div class="desc">Opus 4.6 ‚Äî complex reasoning ($5/$25 in/out)</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>‚ö° Quick Actions</h4>
        <div class="commands-grid">
          <div class="command-card"><code>q "..."</code><div class="desc">Quick question, no session</div></div>
          <div class="command-card"><code>explain ...</code><div class="desc">Explain any concept</div></div>
          <div class="command-card"><code>fixcmd</code><div class="desc">Fix last failed command</div></div>
          <div class="command-card"><code>cfix</code><div class="desc">Fix the last error in Claude</div></div>
          <div class="command-card"><code>ctest</code><div class="desc">Run tests and fix failures</div></div>
          <div class="command-card"><code>ccheck</code><div class="desc">Multi-repo test + lint (all projects)</div></div>
          <div class="command-card"><code>ruff-check</code><div class="desc">Python lint (researchgravity)</div></div>
          <div class="command-card"><code>cbuild</code><div class="desc">Run build and fix errors</div></div>
          <div class="command-card"><code>cgit</code><div class="desc">PR workflow (/pr skill)</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>‚ö° Session Optimizer</h4>
        <div class="commands-grid">
          <div class="command-card"><code>session-status</code><div class="desc">Quick session status</div></div>
          <div class="command-card"><code>session-dash</code><div class="desc">Full session dashboard</div></div>
          <div class="command-card"><code>session-window</code><div class="desc">Window position details</div></div>
          <div class="command-card"><code>session-predict</code><div class="desc">Predict next window</div></div>
          <div class="command-card"><code>session-budget</code><div class="desc">Budget status</div></div>
          <div class="command-card"><code>session-reserve N</code><div class="desc">Reserve N Opus tasks</div></div>
          <div class="command-card"><code>session-queue-add</code><div class="desc">Add task to queue</div></div>
          <div class="command-card"><code>session-queue-list</code><div class="desc">View task queue</div></div>
          <div class="command-card"><code>session-optimize</code><div class="desc">Run optimization pass</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>üéØ Routing System</h4>
        <div class="commands-grid">
          <div class="command-card"><code>routing-dash</code><div class="desc">Routing dashboard</div></div>
          <div class="command-card"><code>routing-report N</code><div class="desc">N-day metrics report</div></div>
          <div class="command-card"><code>routing-targets</code><div class="desc">Check target metrics</div></div>
          <div class="command-card"><code>routing-help</code><div class="desc">Quick reference docs</div></div>
          <div class="command-card"><code>ab-test</code><div class="desc">A/B test analyzer</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>‚öôÔ∏è Co-Evolution</h4>
        <div class="commands-grid">
          <div class="command-card"><code>coevo-analyze</code><div class="desc">Analyze patterns</div></div>
          <div class="command-card"><code>coevo-propose</code><div class="desc">Propose mutations</div></div>
          <div class="command-card"><code>coevo-apply</code><div class="desc">Apply approved mutations</div></div>
          <div class="command-card"><code>coevo-rollback</code><div class="desc">Rollback last change</div></div>
          <div class="command-card"><code>coevo-dashboard</code><div class="desc">Co-evo dashboard</div></div>
          <div class="command-card"><code>meta-analyzer</code><div class="desc">Full meta-analyzer</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>üî≠ Observatory</h4>
        <div class="commands-grid">
          <div class="command-card"><code>obs N</code><div class="desc">N-day unified report</div></div>
          <div class="command-card"><code>obs-help</code><div class="desc">Observatory help</div></div>
          <div class="command-card"><code>elite-status</code><div class="desc">Elite mode status</div></div>
          <div class="command-card"><code>cost-report N</code><div class="desc">Cost report (N days)</div></div>
          <div class="command-card"><code>productivity-report N</code><div class="desc">Productivity metrics</div></div>
          <div class="command-card"><code>tool-stats N</code><div class="desc">Tool success rates</div></div>
          <div class="command-card"><code>command-stats N</code><div class="desc">Command usage stats</div></div>
          <div class="command-card"><code>git-stats N</code><div class="desc">Git activity</div></div>
          <div class="command-card"><code>session-analyze-recent</code><div class="desc">Analyze recent sessions</div></div>
          <div class="command-card"><code>feedback-loop</code><div class="desc">Run feedback loop</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>üì¶ Git Automation</h4>
        <div class="commands-grid">
          <div class="command-card"><code>gsave "msg"</code><div class="desc">Stage all + commit</div></div>
          <div class="command-card"><code>gsync</code><div class="desc">Pull, commit, push</div></div>
          <div class="command-card"><code>gcheckpoint</code><div class="desc">Checkpoint with optional push</div></div>
          <div class="command-card"><code>gquick</code><div class="desc">Auto-generate commit message</div></div>
          <div class="command-card"><code>gbranch name</code><div class="desc">Create and switch branch</div></div>
          <div class="command-card"><code>glog</code><div class="desc">Recent commits (compact)</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>üî¨ Research</h4>
        <div class="commands-grid">
          <div class="command-card"><code>research "topic"</code><div class="desc">Start research session</div></div>
          <div class="command-card"><code>rlog URL</code><div class="desc">Log URL to session</div></div>
          <div class="command-card"><code>rstatus</code><div class="desc">Check research status</div></div>
          <div class="command-card"><code>rsearch query</code><div class="desc">Search archives</div></div>
          <div class="command-card"><code>prefetch</code><div class="desc">Load project context</div></div>
          <div class="command-card"><code>prefetch-pattern</code><div class="desc">Pattern-based prefetch</div></div>
          <div class="command-card"><code>prefetch-suggest</code><div class="desc">Suggest relevant context</div></div>
          <div class="command-card"><code>rclip</code><div class="desc">Log URL from clipboard</div></div>
        </div>
      </div>

      <div class="commands-section">
        <h4>üìä Monitoring</h4>
        <div class="commands-grid">
          <div class="command-card"><code>today</code><div class="desc">Today's activity</div></div>
          <div class="command-card"><code>cl</code><div class="desc">Live activity log (tail -f)</div></div>
          <div class="command-card"><code>clog</code><div class="desc">Full activity log</div></div>
          <div class="command-card"><code>cstats</code><div class="desc">Session stats</div></div>
          <div class="command-card"><code>checkpoint</code><div class="desc">Save session checkpoint</div></div>
        </div>
      </div>
    </div>

    <!-- ROUTING TAB -->
    <div id="routing" class="tab-content">
      <div class="stats-row" id="routingStatsRow">
        <div class="stat-card">
          <div class="stat-value" id="routingQueries">‚Äî</div>
          <div class="stat-label">Total Queries</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="routingDqScore">‚Äî</div>
          <div class="stat-label">Avg DQ Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="routingCostSavings">‚Äî</div>
          <div class="stat-label">Cost Savings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="routingAccuracy">‚Äî</div>
          <div class="stat-label">Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="routingDomains">‚Äî</div>
          <div class="stat-label">Expertise Domains</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="routingModels">‚Äî</div>
          <div class="stat-label">Models Active</div>
        </div>
      </div>

      <!-- DQ Score Components + Performance Targets -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üß¨ DQ Score Components</h3>
            <span class="card-badge" id="dqComponentsBadge">Weighted</span>
          </div>
          <div style="padding:1rem;">
            <div style="display:flex;gap:1rem;margin-bottom:1rem;">
              <div style="flex:1;text-align:center;background:var(--bg-glass);border-radius:8px;padding:0.75rem;">
                <div style="font-size:1.3rem;font-weight:700;color:#00ff88;" id="dqValidity">‚Äî</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">Validity (40%)</div>
              </div>
              <div style="flex:1;text-align:center;background:var(--bg-glass);border-radius:8px;padding:0.75rem;">
                <div style="font-size:1.3rem;font-weight:700;color:#48dbfb;" id="dqSpecificity">‚Äî</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">Specificity (30%)</div>
              </div>
              <div style="flex:1;text-align:center;background:var(--bg-glass);border-radius:8px;padding:0.75rem;">
                <div style="font-size:1.3rem;font-weight:700;color:#b14eff;" id="dqCorrectness">‚Äî</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">Correctness (30%)</div>
              </div>
            </div>
            <div class="progress-item">
              <div class="progress-header">
                <span class="progress-label">Composite DQ</span>
                <span class="progress-value" id="dqComposite">‚Äî</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="dqCompositeBar" style="width:0%;background:linear-gradient(90deg,#00ff88,#48dbfb,#b14eff);"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>‚ö° Performance Targets</h3>
            <span class="card-badge" id="targetsMetBadge">‚Äî</span>
          </div>
          <div class="routing-targets">
            <div class="target-item">
              <span class="target-label">Routing Accuracy</span>
              <span class="target-value" id="accuracyTarget">‚Äî</span>
              <span class="target-status" id="accuracyStatus">‚è≥</span>
            </div>
            <div class="target-item">
              <span class="target-label">Cost Reduction</span>
              <span class="target-value" id="costTarget">‚Äî</span>
              <span class="target-status" id="costStatus">‚è≥</span>
            </div>
            <div class="target-item">
              <span class="target-label">Latency (p95)</span>
              <span class="target-value" id="latencyTarget">‚Äî</span>
              <span class="target-status" id="latencyStatus">‚è≥</span>
            </div>
            <div class="target-item">
              <span class="target-label">DQ Score</span>
              <span class="target-value" id="dqTarget">‚Äî</span>
              <span class="target-status" id="dqStatus">‚è≥</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily DQ Trend + Queries by Model -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üìà Daily DQ Score & Complexity</h3>
            <span class="card-badge" id="routingDqTrendBadge">Dual Axis</span>
          </div>
          <div class="chart-container"><canvas id="routingDqTrendChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>üìä Daily Queries by Model</h3>
            <span class="card-badge" id="routingModelTrendBadge">Stacked</span>
          </div>
          <div class="chart-container"><canvas id="routingModelTrendChart"></canvas></div>
        </div>
      </div>

      <!-- Model Complexity + Expertise Domains -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üéØ Model Complexity Ranges</h3>
            <span class="card-badge">Min/Avg/Max</span>
          </div>
          <div class="chart-container"><canvas id="routingComplexityChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>üß† Expertise Domain Routing</h3>
            <span class="card-badge" id="expertiseBadge">Domains</span>
          </div>
          <div class="chart-container"><canvas id="routingExpertiseChart"></canvas></div>
        </div>
      </div>

      <!-- Model Distribution + Success Rates -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>üîµ Model Distribution</h3>
            <span class="card-badge">By Count</span>
          </div>
          <div class="chart-container"><canvas id="modelDistChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>‚úÖ Model Success Rates</h3>
            <span class="card-badge" id="modelSuccessBadge">From Outcomes</span>
          </div>
          <div id="modelSuccessGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;padding:1rem;">
            <p class="empty-state" style="grid-column:span 3;">Calculating from session outcomes...</p>
          </div>
        </div>
      </div>

      <!-- Expertise Domain Detail -->
      <div class="card">
        <div class="card-header">
          <h3>üéì Expertise Routing Detail</h3>
          <span class="card-badge" id="expertiseCountBadge">‚Äî</span>
        </div>
        <div id="expertiseDetailGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:0.75rem;padding:1rem;">
          <p class="empty-state">Loading expertise data...</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>üöÄ Routing Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>routing-dash</code><div class="desc">View routing dashboard</div></div>
          <div class="command-card"><code>routing-report 7</code><div class="desc">Weekly performance report</div></div>
          <div class="command-card"><code>exp-detect "query"</code><div class="desc">Detect domain & expertise</div></div>
          <div class="command-card"><code>exp-route "query" 0.5</code><div class="desc">Route with complexity</div></div>
          <div class="command-card"><code>routing-targets</code><div class="desc">Check target metrics</div></div>
          <div class="command-card"><code>exp-stats</code><div class="desc">Expertise routing stats</div></div>
        </div>
      </div>
    </div>

    <!-- CO-EVOLUTION TAB -->
    <div id="coevo" class="tab-content">
      <!-- 6 stat cards -->
      <div class="stats-row" id="coevoStatsRow">
        <div class="stat-card green">
          <div class="stat-value" id="coevoCacheEfficiency">‚Äî</div>
          <div class="stat-label">Cache Efficiency</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="coevoDqScore">‚Äî</div>
          <div class="stat-label">DQ Score</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="coevoDominantPattern">‚Äî</div>
          <div class="stat-label">Dominant Pattern</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="coevoModsApplied">‚Äî</div>
          <div class="stat-label">Mods Applied</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value" id="coevoTotalSessions">‚Äî</div>
          <div class="stat-label">Total Sessions</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="coevoTopPct">‚Äî</div>
          <div class="stat-label">Top Pattern %</div>
        </div>
      </div>

      <!-- Meta-Vengine Status + Pattern Distribution -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Meta-Vengine Status</h3>
            <span class="card-badge" id="coevoStatusBadge">Active</span>
          </div>
          <div style="padding:1rem;">
            <div class="coevo-status">
              <div class="coevo-config-item">
                <span class="config-label">Auto-Apply</span>
                <span class="config-value" id="coevoAutoApply">‚Äî</span>
              </div>
              <div class="coevo-config-item">
                <span class="config-label">Min Confidence</span>
                <span class="config-value" id="coevoMinConfidence">‚Äî</span>
              </div>
              <div class="coevo-config-item">
                <span class="config-label">Last Analysis</span>
                <span class="config-value" id="coevoLastAnalysis">‚Äî</span>
              </div>
            </div>
            <div style="margin-top:1rem;border-top:1px solid var(--border);padding-top:1rem;">
              <div style="font-weight:600;color:var(--text-primary);margin-bottom:0.5rem;font-size:0.85rem;">Evolution Weights</div>
              <div id="coevoWeights" style="display:flex;flex-direction:column;gap:0.4rem;"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Pattern Distribution</h3>
            <span class="card-badge" id="patternCount">0</span>
          </div>
          <div class="chart-container"><canvas id="patternChart"></canvas></div>
        </div>
      </div>

      <!-- Charts row 2: Weekly Pattern Trends + Daily Pattern Activity -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Weekly Pattern Trends</h3>
            <span class="card-badge" id="patternTrendsWeeks">0 weeks</span>
          </div>
          <div class="chart-container"><canvas id="patternTrendsChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Daily Pattern Activity</h3>
            <span class="card-badge" id="patternDailyBadge">21 Days</span>
          </div>
          <div class="chart-container"><canvas id="patternDailyChart"></canvas></div>
        </div>
      </div>

      <!-- All-time stats + Detected patterns list -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>All-Time Pattern Stats</h3>
            <span class="card-badge" id="patternTotalSessions">0 sessions</span>
          </div>
          <div id="patternStatsGrid" class="stats-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;padding:1rem;">
            <p class="empty-state" style="grid-column:span 2;">Run backfill-patterns.py to populate</p>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Detected Patterns</h3>
          </div>
          <div id="patternsList" class="patterns-list" style="padding:1rem;max-height:350px;overflow-y:auto;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Co-Evolution Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>meta-analyzer analyze</code><div class="desc">Run pattern analysis</div></div>
          <div class="command-card"><code>meta-analyzer propose</code><div class="desc">Generate modification proposals</div></div>
          <div class="command-card"><code>meta-analyzer apply &lt;id&gt;</code><div class="desc">Apply a modification</div></div>
          <div class="command-card"><code>meta-analyzer rollback &lt;id&gt;</code><div class="desc">Revert a modification</div></div>
          <div class="command-card"><code>meta-analyzer dashboard</code><div class="desc">View effectiveness metrics</div></div>
          <div class="command-card"><code>prefetch --pattern &lt;type&gt;</code><div class="desc">Load pattern-aware context</div></div>
        </div>
      </div>
    </div>

    <!-- CONTEXT EFFICIENCY TAB -->
    <div id="context-efficiency" class="tab-content">
      <!-- 6 stat cards -->
      <div class="stats-row" id="contextEfficiencyStatsRow">
        <div class="stat-card green">
          <div class="stat-value" id="totalSessions">0</div>
          <div class="stat-label">Sessions Optimized</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="totalTokenSavings">0</div>
          <div class="stat-label">Tokens Saved</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="totalCostSavings">$0.00</div>
          <div class="stat-label">Cost Savings</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="avgReduction">0%</div>
          <div class="stat-label">Avg Reduction</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value" id="totalPacks">0</div>
          <div class="stat-label">Total Packs</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="totalPackTokens">0</div>
          <div class="stat-label">Pack Tokens</div>
        </div>
      </div>

      <!-- Charts row 1: Daily Sessions + Cost Savings | Daily Token Savings -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily Sessions & Cost Savings</h3>
            <span class="card-badge" id="packDaysBadge">All Days</span>
          </div>
          <div class="chart-container"><canvas id="packSessionCostChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Daily Token Savings</h3>
            <span class="card-badge" id="packTokenTrendBadge">Trend</span>
          </div>
          <div class="chart-container"><canvas id="savingsTrendChart"></canvas></div>
        </div>
      </div>

      <!-- Charts row 2: Pack Inventory by Type | Pack Token Sizes -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Pack Inventory by Type</h3>
            <span class="card-badge" id="packInventoryCount">0</span>
          </div>
          <div class="chart-container"><canvas id="packTypeChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Pack Token Sizes</h3>
          </div>
          <div class="chart-container"><canvas id="packSizeChart"></canvas></div>
        </div>
      </div>

      <!-- Top packs + Pack inventory list -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Top Performing Packs</h3>
            <span class="card-badge" id="topPacksCount">0</span>
          </div>
          <div id="topPacksList" class="top-packs-list" style="padding:1rem;"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Pack Inventory</h3>
          </div>
          <div id="packInventoryList" class="pack-inventory-list" style="padding:1rem;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Pack Management Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>python3 build_packs.py --create</code><div class="desc">Create new pack</div></div>
          <div class="command-card"><code>python3 select_packs.py --auto</code><div class="desc">Auto-select packs</div></div>
          <div class="command-card"><code>python3 pack_metrics.py --stats</code><div class="desc">View statistics</div></div>
          <div class="command-card"><code>python3 build_packs.py --list</code><div class="desc">List all packs</div></div>
          <div class="command-card"><code>prefetch-packs --inject</code><div class="desc">Inject into session</div></div>
          <div class="command-card"><code>pack-metrics --dashboard-data</code><div class="desc">Export dashboard data</div></div>
        </div>
      </div>
    </div>

    <!-- SESSION OUTCOMES TAB (Tab 10) -->
    <div id="session-outcomes" class="tab-content">
      <!-- SESSION WINDOW PANEL - Current session state -->
      <div id="sessionPanel" class="card" style="margin-bottom:1.5rem;">
        <div class="card-header">
          <h3>‚ö° Session Window</h3>
          <span class="card-badge" id="sessionTierBadge">‚Äî</span>
        </div>
        <div class="session-window-content">
          <div class="session-progress-row">
            <span class="session-label">Window Position</span>
            <div class="session-progress-bar">
              <div class="session-progress-fill" id="sessionProgressFill" style="width:0%"></div>
            </div>
            <span class="session-value" id="sessionPosition">0%</span>
          </div>
          <div class="session-stats-row">
            <div class="session-stat">
              <span class="session-stat-value" id="sessionRemaining">‚Äî</span>
              <span class="session-stat-label">Remaining</span>
            </div>
            <div class="session-stat">
              <span class="session-stat-value" id="sessionOpus">‚Äî</span>
              <span class="session-stat-label">Opus</span>
            </div>
            <div class="session-stat">
              <span class="session-stat-value" id="sessionSonnet">‚Äî</span>
              <span class="session-stat-label">Sonnet</span>
            </div>
            <div class="session-stat">
              <span class="session-stat-value" id="sessionHaiku">‚Äî</span>
              <span class="session-stat-label">Haiku</span>
            </div>
            <div class="session-stat">
              <span class="session-stat-value" id="sessionBudget">‚Äî</span>
              <span class="session-stat-label">Budget Used</span>
            </div>
            <div class="session-stat">
              <span class="session-stat-value" id="sessionQueue">‚Äî</span>
              <span class="session-stat-label">Queue</span>
            </div>
          </div>
          <div class="session-recommendations" id="sessionRecommendations"></div>
        </div>
      </div>

      <div class="stats-row" id="sessionOutcomesStatsRow">
        <div class="stat-card">
          <div class="stat-value" id="sessionTotalCount">‚Äî</div>
          <div class="stat-label">Total Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sessionSuccessRate">‚Äî</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sessionAvgMessages">‚Äî</div>
          <div class="stat-label">Avg Messages</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sessionMarathon">‚Äî</div>
          <div class="stat-label">Marathon (100+)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sessionTotalMessages">‚Äî</div>
          <div class="stat-label">Total Messages</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Outcome Distribution</h3>
            <span class="card-badge" id="outcomeDistBadge">0 Sessions</span>
          </div>
          <div class="chart-container"><canvas id="outcomeDonutChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Quality Distribution</h3>
            <span class="card-badge">1-5 Stars</span>
          </div>
          <div class="chart-container"><canvas id="qualityBarChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily Sessions</h3>
            <span class="card-badge" id="dailySessionsDays">0 days</span>
          </div>
          <div class="chart-container"><canvas id="dailySessionsChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Success Rate Over Time</h3>
            <span class="card-badge">Daily Trend</span>
          </div>
          <div class="chart-container"><canvas id="successRateTrendChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Sessions by Model</h3>
            <span class="card-badge">Per Day</span>
          </div>
          <div class="chart-container"><canvas id="modelSessionsChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Session Size Distribution</h3>
            <span class="card-badge" id="sizeTotalBadge">All Time</span>
          </div>
          <div class="chart-container"><canvas id="sizeDistChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Success Rate by Model</h3>
            <span class="card-badge">All Time</span>
          </div>
          <div class="chart-container"><canvas id="modelSuccessChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Quality Trend</h3>
            <span class="card-badge">Rolling Average</span>
          </div>
          <div class="chart-container"><canvas id="qualityTrendChart"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Recent Sessions</h3>
          <span class="card-badge" id="recentSessionsCount">0</span>
        </div>
        <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid var(--border);">
              <th style="padding: 10px; text-align: left; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Date</th>
              <th style="padding: 10px; text-align: left; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Model</th>
              <th style="padding: 10px; text-align: left; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Outcome</th>
              <th style="padding: 10px; text-align: right; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Msgs</th>
              <th style="padding: 10px; text-align: right; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Tools</th>
              <th style="padding: 10px; text-align: center; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 0.8rem;">Quality</th>
            </tr>
          </thead>
          <tbody id="recentSessionsTable">
            <tr><td colspan="6" style="text-align:center; padding: 20px; color: var(--text-secondary);">Loading sessions...</td></tr>
          </tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- PRODUCTIVITY TAB (Tab 11) -->
    <div id="productivity" class="tab-content">
      <div class="stats-row" id="productivityStatsRow">
        <div class="stat-card">
          <div class="stat-value" id="prodTotalTools">0</div>
          <div class="stat-label">All-Time Tool Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prodScore">0%</div>
          <div class="stat-label">Productivity Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prodWriteOps">0</div>
          <div class="stat-label">Write Operations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prodReadOps">0</div>
          <div class="stat-label">Read Operations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prodPeakDay">‚Äî</div>
          <div class="stat-label">Peak Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="prodActiveDays">0</div>
          <div class="stat-label">Active Days</div>
        </div>
      </div>

      <!-- Per-model breakdown -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Bash Commands</div>
          <div id="prodBashCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan);">0</div>
          <div id="prodBashPct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Edit + Write</div>
          <div id="prodEditWriteCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
          <div id="prodEditWritePct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Search (Grep + Glob)</div>
          <div id="prodSearchCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-purple);">0</div>
          <div id="prodSearchPct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Productivity Score Trend</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="productivityScoreChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Read vs Write Over Time</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="readWriteChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily Tool Volume</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="velocityChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Tool Category Mix</h3>
            <span class="card-badge">All-Time Distribution</span>
          </div>
          <div class="chart-container"><canvas id="toolMixChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>File Activity</h3>
            <span class="card-badge">Most Modified</span>
          </div>
          <div id="fileActivityList" class="file-activity-list">
            <div class="no-data">No file activity data available.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Productivity Assessment</h3>
          </div>
          <div id="productivityAssessment" class="assessment-panel">
            <div class="assessment-item">
              <div class="assessment-label">Current Mode:</div>
              <div class="assessment-value" id="productivityMode">‚Äî</div>
            </div>
            <div class="assessment-item">
              <div class="assessment-label">Recommendation:</div>
              <div class="assessment-value" id="productivityReco">‚Äî</div>
            </div>
            <div class="assessment-item">
              <div class="assessment-label">Write Intensity:</div>
              <div class="assessment-value" id="productivityWriteIntensity">‚Äî</div>
            </div>
            <div class="assessment-item">
              <div class="assessment-label">Best Day:</div>
              <div class="assessment-value" id="productivityBestDay">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Productivity Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>productivity-report 7</code><div class="desc">Weekly productivity metrics</div></div>
          <div class="command-card"><code>obs 30</code><div class="desc">30-day unified report</div></div>
          <div class="command-card"><code>tool-stats 30</code><div class="desc">30-day tool success rates</div></div>
        </div>
      </div>
    </div>

    <!-- TOOL ANALYTICS TAB (Tab 12) -->
    <div id="tool-analytics" class="tab-content">
      <div class="stats-row" id="toolAnalyticsStatsRow">
        <div class="stat-card">
          <div class="stat-value" id="taTotalCalls">0</div>
          <div class="stat-label">All-Time Tool Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="taUniqueTools">0</div>
          <div class="stat-label">Unique Tools</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="taSuccessRate">0%</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="taTotalFailures">0</div>
          <div class="stat-label">Total Failures</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="taAvgDaily">0</div>
          <div class="stat-label">Avg/Day</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="taTopTool">‚Äî</div>
          <div class="stat-label">Top Tool</div>
        </div>
      </div>

      <!-- Tool category breakdown -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Core (Bash/Read/Edit/Write)</div>
          <div id="taCoreCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan);">0</div>
          <div id="taCorePct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Search (Grep/Glob)</div>
          <div id="taSearchCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-purple);">0</div>
          <div id="taSearchPct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Advanced (Task/Web/MCP/Other)</div>
          <div id="taAdvancedCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
          <div id="taAdvancedPct" style="font-size: 0.8rem; color: var(--text-secondary);">0%</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Tool Usage Distribution</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="commandUsageChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Success Rate by Tool</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="toolSuccessChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily Tool Volume</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="toolDailyVolumeChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Tool Category Trend</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="toolTrendChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Git Commits</h3>
            <span class="card-badge">Last 30 Days</span>
          </div>
          <div class="chart-container"><canvas id="gitCommitsChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Git Repos</h3>
            <span class="card-badge">Commit Distribution</span>
          </div>
          <div class="chart-container"><canvas id="gitReposChart"></canvas></div>
        </div>
      </div>

      <!-- Git stats row -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Total Commits</div>
          <div id="gitCommitCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Repos Active</div>
          <div id="gitRepoCount" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Insertions</div>
          <div id="gitInsertions" style="font-size: 1.8rem; font-weight: 700; color: rgba(0, 230, 118, 0.9);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Deletions</div>
          <div id="gitDeletions" style="font-size: 1.8rem; font-weight: 700; color: rgba(233, 69, 96, 0.9);">0</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Failure Patterns</h3>
            <span class="card-badge" id="failurePatternsCount">0</span>
          </div>
          <div id="failurePatternsList" class="failure-patterns-list">
            <div class="no-data" style="padding: 20px; text-align: center; color: var(--text-secondary);">No failures detected</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Commands</h3>
          </div>
          <div class="commands-grid">
            <div class="command-card"><code>tool-stats 30</code><div class="desc">30-day tool success rates</div></div>
            <div class="command-card"><code>git-stats 30</code><div class="desc">30-day git metrics</div></div>
            <div class="command-card"><code>command-stats 30</code><div class="desc">Command usage stats</div></div>
          </div>
        </div>
      </div>

      <!-- Expertise Routing Heatmap -->
      <div class="charts-grid" style="margin-top:1rem;">
        <div class="card" style="grid-column:span 2;">
          <div class="card-header">
            <h3>Expertise Routing Heatmap</h3>
            <span class="card-badge" id="taExpertiseBadge">Loading...</span>
          </div>
          <div id="expertiseHeatmap" style="padding:1rem;"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Complexity Distribution</h3>
          </div>
          <div id="expertiseComplexity" style="padding:1rem;"></div>
        </div>
      </div>
    </div>

    <!-- SUPERMEMORY TAB -->
    <div id="supermemory" class="tab-content">
      <div class="stats-row" id="supermemoryStats">
        <div class="stat-card">
          <div class="stat-value" id="smMemoryItems">‚Äî</div>
          <div class="stat-label">Memory Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="smLearnings">‚Äî</div>
          <div class="stat-label">Learnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="smReviewTotal">‚Äî</div>
          <div class="stat-label">Total Reviews</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="smReviewDue">‚Äî</div>
          <div class="stat-label">Reviews Due</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="smErrorPatterns">‚Äî</div>
          <div class="stat-label">Error Patterns</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="smProjects">‚Äî</div>
          <div class="stat-label">Projects Tracked</div>
        </div>
      </div>

      <!-- Source + status row -->
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Daily Syncs</div>
          <div id="smSourceDaily" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Session Outcomes</div>
          <div id="smSourceOutcome" style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Error Captures</div>
          <div id="smSourceError" style="font-size: 1.8rem; font-weight: 700; color: rgba(233, 69, 96, 0.9);">0</div>
        </div>
        <div class="card" style="padding: 16px; text-align: center;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">Status</div>
          <div id="supermemoryStatus" style="font-size: 1.4rem; font-weight: 700; color: var(--accent-green);">‚Äî</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Memory Growth</h3>
            <span class="card-badge">Last 30 Days</span>
          </div>
          <div class="chart-container"><canvas id="smGrowthChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Project Distribution</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="smProjectChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Learning Categories</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="smCategoryChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Review Queue by Category</h3>
            <span class="card-badge" id="smReviewBadge">0 due</span>
          </div>
          <div class="chart-container"><canvas id="smReviewChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <!-- Review Queue List -->
        <div class="card">
          <div class="card-header">
            <h3>Review Queue</h3>
            <span class="card-badge" id="smReviewDueBadge">0 due</span>
          </div>
          <div class="card-body">
            <div id="smReviewList" style="max-height: 350px; overflow-y: auto;">
              <p style="color: var(--text-muted);">No items due for review</p>
            </div>
          </div>
        </div>

        <!-- Automations Status -->
        <div class="card">
          <div class="card-header">
            <h3>Automations</h3>
          </div>
          <div class="card-body">
            <table style="width: 100%; border-collapse: collapse;" id="smAutomationsTable">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem;">Automation</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem;">Status</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem;">Trigger</th>
                </tr>
              </thead>
              <tbody id="smAutomationsBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="charts-grid">
        <!-- Recent Learnings -->
        <div class="card">
          <div class="card-header">
            <h3>Recent Learnings</h3>
          </div>
          <div class="card-body">
            <div id="smLearningsList" style="max-height: 350px; overflow-y: auto;">
              <p style="color: var(--text-muted);">No learnings recorded</p>
            </div>
          </div>
        </div>

        <!-- Error Patterns -->
        <div class="card">
          <div class="card-header">
            <h3>Error Patterns</h3>
            <span class="card-badge" id="smErrorCount">0</span>
          </div>
          <div class="card-body">
            <div id="smErrorsList" style="max-height: 350px; overflow-y: auto;">
              <p style="color: var(--text-muted);">No error patterns recorded</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Commands -->
      <div class="card">
        <div class="card-header">
          <h3>Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>sm stats</code><div class="desc">Memory statistics</div></div>
          <div class="command-card"><code>sm context</code><div class="desc">Generate session context</div></div>
          <div class="command-card"><code>sm errors "text"</code><div class="desc">Find past error solutions</div></div>
          <div class="command-card"><code>sm review</code><div class="desc">Spaced repetition review</div></div>
          <div class="command-card"><code>sm sync</code><div class="desc">Sync all data sources</div></div>
          <div class="command-card"><code>sm-due</code><div class="desc">Check review items due</div></div>
        </div>
      </div>
    </div>

    <!-- COGNITIVE OS TAB -->
    <div id="cognitive" class="tab-content">
      <div class="stats-row" id="cognitiveStatsRow">
        <div class="stat-card">
          <div class="stat-value" id="cognitiveMode">‚Äî</div>
          <div class="stat-label">Current Mode</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cognitiveEnergy">‚Äî</div>
          <div class="stat-label">Energy Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cognitiveFlow">‚Äî</div>
          <div class="stat-label">Flow State</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cognitiveFate">‚Äî</div>
          <div class="stat-label">Session Fate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cogFateAccuracy">‚Äî</div>
          <div class="stat-label">Fate Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="cogRoutingTotal">‚Äî</div>
          <div class="stat-label">Routing Decisions</div>
        </div>
      </div>

      <!-- Today's Cognitive Brief -->
      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <h3>Today's Cognitive Brief</h3>
          <span class="card-badge" id="cognitiveDay">‚Äî</span>
        </div>
        <div style="padding:1rem;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem;">
            <div style="background:var(--bg-glass);padding:1rem;border-radius:8px;">
              <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:0.5rem;">RECOMMENDED TASKS</div>
              <div id="cognitiveRecommendedTasks" style="color:var(--text-primary);font-size:0.9rem;">‚Äî</div>
            </div>
            <div style="background:var(--bg-glass);padding:1rem;border-radius:8px;">
              <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:0.5rem;">RECOMMENDED MODEL</div>
              <div id="cognitiveRecommendedModel" style="color:var(--accent-cyan);font-size:0.9rem;font-weight:600;">‚Äî</div>
            </div>
            <div style="background:var(--bg-glass);padding:1rem;border-radius:8px;">
              <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:0.5rem;">PEAK HOURS</div>
              <div id="cognitivePeakHours" style="color:var(--accent-yellow);font-size:0.9rem;">‚Äî</div>
            </div>
            <div style="background:var(--bg-glass);padding:1rem;border-radius:8px;">
              <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:0.5rem;">FLOW SCORE</div>
              <div id="cogFlowScore" style="color:var(--accent-green);font-size:0.9rem;font-weight:600;">‚Äî</div>
            </div>
          </div>
          <div id="cognitiveWarnings" style="color:var(--accent-orange);font-size:0.85rem;"></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Weekly Energy Map</h3>
            <span class="card-badge">By Day</span>
          </div>
          <div id="weeklyEnergyMap" style="padding:1rem;">
            <div style="display:flex;flex-direction:column;gap:0.5rem;" id="energyBars"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Flow State History</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="flowChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Model Routing Distribution</h3>
            <span class="card-badge">All-Time (SQLite)</span>
          </div>
          <div class="chart-container"><canvas id="cognitiveRoutingChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Fate Prediction Accuracy</h3>
            <span class="card-badge">Daily Trend</span>
          </div>
          <div class="chart-container"><canvas id="fateAccuracyChart"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Daily DQ Score Trend</h3>
            <span class="card-badge">All-Time</span>
          </div>
          <div class="chart-container"><canvas id="dqScoreTrendChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Fate Predictions</h3>
            <span class="card-badge">Distribution</span>
          </div>
          <div class="chart-container"><canvas id="fateDistChart"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>cos state</code><div class="desc">Current cognitive mode</div></div>
          <div class="command-card"><code>cos flow</code><div class="desc">Flow state detection</div></div>
          <div class="command-card"><code>cos fate</code><div class="desc">Session outcome prediction</div></div>
          <div class="command-card"><code>cos route "task"</code><div class="desc">Cognitive model routing</div></div>
          <div class="command-card"><code>cos weekly</code><div class="desc">Weekly energy map</div></div>
          <div class="command-card"><code>cos schedule "tasks"</code><div class="desc">Task scheduling suggestions</div></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- SELF-HEALING / AUTO-RECOVERY SECTION -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

      <div style="margin:2rem 0 1rem;padding:1rem 0;border-top:1px solid var(--border);">
        <h2 style="font-size:1.3rem;font-weight:600;color:var(--accent-green);display:flex;align-items:center;gap:0.5rem;">
          ü©π Self-Healing Engine
          <span style="font-size:0.7rem;background:rgba(0,255,136,0.1);color:var(--accent-green);padding:3px 8px;border-radius:4px;">AUTO-RECOVERY</span>
        </h2>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-top:0.5rem;">Automatic error detection and remediation ‚Äî 94% coverage, 70% auto-fixed</p>
      </div>

      <div class="stats-row" id="recoveryStatsRow">
        <div class="stat-card green">
          <div class="stat-value" id="recoveryTotal">‚Äî</div>
          <div class="stat-label">Total Attempts</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="recoveryAutoFix">‚Äî</div>
          <div class="stat-label">Auto-Fixed</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="recoverySuccess">‚Äî</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="recoveryCoverage">94%</div>
          <div class="stat-label">Error Coverage</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Recovery by Category</h3>
            <span class="card-badge">Distribution</span>
          </div>
          <div class="chart-container"><canvas id="recoveryCategoryChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Auto-Fix vs Suggest</h3>
            <span class="card-badge">Action Types</span>
          </div>
          <div class="chart-container"><canvas id="recoveryTypeChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Recovery Timeline</h3>
            <span class="card-badge">Last 7 Days</span>
          </div>
          <div class="chart-container"><canvas id="recoveryTimelineChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Success by Category</h3>
            <span class="card-badge">Rates</span>
          </div>
          <div class="chart-container"><canvas id="recoverySuccessChart"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Recovery Matrix</h3>
          <span class="card-badge">Actions</span>
        </div>
        <div style="padding:1rem;overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
            <thead>
              <tr style="border-bottom:1px solid var(--border);">
                <th style="text-align:left;padding:0.75rem;color:var(--text-secondary);">Category</th>
                <th style="text-align:center;padding:0.75rem;color:var(--text-secondary);">Errors</th>
                <th style="text-align:left;padding:0.75rem;color:var(--text-secondary);">Auto-Fix Actions</th>
                <th style="text-align:left;padding:0.75rem;color:var(--text-secondary);">Suggest-Only</th>
              </tr>
            </thead>
            <tbody id="recoveryMatrixBody">
              <tr><td colspan="4" style="padding:1rem;text-align:center;color:var(--text-muted);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Recent Recovery Actions</h3>
          <span class="card-badge" id="recentRecoveryCount">0</span>
        </div>
        <div id="recentRecoveryList" style="padding:1rem;max-height:300px;overflow-y:auto;">
          <div style="color:var(--text-muted);text-align:center;">No recent recoveries</div>
        </div>
      </div>

      <!-- MULTI-AGENT COORDINATION SECTION -->
      <div class="section-header" style="margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: var(--cyan); margin: 0; font-size: 1.1rem;">ü§ñ Multi-Agent Coordination</h2>
      </div>

      <div class="stats-row" id="coordinatorStatsRow">
        <div class="stat-card cyan">
          <div class="stat-value" id="coordActiveAgents">0</div>
          <div class="stat-label">Active Agents</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="coordCompletedAgents">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="coordFileLocks">0</div>
          <div class="stat-label">File Locks</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="coordTotalCost">$0</div>
          <div class="stat-label">Coord Cost</div>
        </div>
      </div>

      <div class="stats-row">
        <div class="card" style="flex: 1">
          <div class="card-header">
            <h3>Agent Registry</h3>
            <span class="badge" id="coordRegistryBadge">0 agents</span>
          </div>
          <div class="content-box" id="coordAgentList" style="max-height: 200px; overflow-y: auto;">
            <p class="empty-state">No active agents</p>
          </div>
        </div>
        <div class="card" style="flex: 1">
          <div class="card-header">
            <h3>File Locks</h3>
            <span class="badge" id="coordLocksBadge">0 locks</span>
          </div>
          <div class="content-box" id="coordLockList" style="max-height: 200px; overflow-y: auto;">
            <p class="empty-state">No active file locks</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Recent Coordinations</h3>
        </div>
        <div class="table-container">
          <table class="data-table" id="coordHistoryTable">
            <thead>
              <tr>
                <th>Task ID</th>
                <th>Task</th>
                <th>Strategy</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody id="coordHistoryBody">
              <tr><td colspan="6" class="empty-state">No coordination history</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Coordination Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>coord status</code><div class="desc">View system status</div></div>
          <div class="command-card"><code>coord research "task"</code><div class="desc">Parallel research</div></div>
          <div class="command-card"><code>coord implement "task"</code><div class="desc">Parallel build</div></div>
          <div class="command-card"><code>coord full "task"</code><div class="desc">Full pipeline</div></div>
          <div class="command-card"><code>coord-cleanup</code><div class="desc">Clean stale data</div></div>
          <div class="command-card"><code>coord-agents</code><div class="desc">List agents</div></div>
        </div>
      </div>

      <!-- ACTIVE CLAUDE SESSIONS SECTION -->
      <div class="section-header" style="margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: var(--purple); margin: 0; font-size: 1.1rem;">üíª Active Claude Sessions</h2>
      </div>

      <div class="stats-row" id="sessionsStatsRow">
        <div class="stat-card purple">
          <div class="stat-value" id="sessionsActiveCount">0</div>
          <div class="stat-label">Running</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="sessionsTotalRuntime">0m</div>
          <div class="stat-label">Total Runtime</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="sessionsOpusCount">0</div>
          <div class="stat-label">Opus</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="sessionsSonnetCount">0</div>
          <div class="stat-label">Sonnet</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Running Sessions</h3>
          <span class="badge" id="sessionsListBadge">0 sessions</span>
        </div>
        <div class="table-container">
          <table class="data-table" id="sessionsTable">
            <thead>
              <tr>
                <th>PID</th>
                <th>Model</th>
                <th>Runtime</th>
                <th>CPU %</th>
                <th>Memory</th>
                <th>Working Dir</th>
              </tr>
            </thead>
            <tbody id="sessionsTableBody">
              <tr><td colspan="6" class="empty-state">No active sessions</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Session History</h3>
          <span class="badge" id="sessionHistoryBadge">0 sessions</span>
        </div>
        <div class="table-container">
          <table class="data-table" id="sessionHistoryTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Messages</th>
                <th>Tools</th>
                <th>Model</th>
                <th>Outcome</th>
              </tr>
            </thead>
            <tbody id="sessionHistoryBody">
              <tr><td colspan="6" class="empty-state">No session history</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- RECOVERY SECTION -->
      <div class="section-header" style="margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: var(--green); margin: 0; font-size: 1.1rem;">ü©π Auto-Recovery</h2>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Recovery Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>recover-status</code><div class="desc">View recovery statistics</div></div>
          <div class="command-card"><code>recover-test git</code><div class="desc">Test git recovery</div></div>
          <div class="command-card"><code>recover-test lock</code><div class="desc">Test lock recovery</div></div>
          <div class="command-card"><code>recover-test perms</code><div class="desc">Test permission recovery</div></div>
        </div>
      </div>
    </div>

    <!-- INFRASTRUCTURE TAB -->
    <div id="infrastructure" class="tab-content">
      <!-- 6 stat cards -->
      <div class="stats-row" id="infraStatsRow">
        <div class="stat-card green">
          <div class="stat-value" id="infraStatus">‚Äî</div>
          <div class="stat-label">System Status</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="infraDaemons">‚Äî</div>
          <div class="stat-label">Daemons Active</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="infraHeartbeat">‚Äî</div>
          <div class="stat-label">Last Heartbeat</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-value" id="infraHealed">‚Äî</div>
          <div class="stat-label">Auto-Healed (24h)</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-value" id="infraSelfHealRuns">‚Äî</div>
          <div class="stat-label">Self-Heal Runs</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="infraRecoveryRate">‚Äî</div>
          <div class="stat-label">Recovery Rate</div>
        </div>
      </div>

      <!-- Daemon grid + Protection layers -->
      <div class="charts-grid">
        <div class="card" style="grid-column:span 2;">
          <div class="card-header">
            <h3>Daemon Status</h3>
            <span class="card-badge" id="infraDaemonBadge">Watchdog</span>
          </div>
          <div id="daemonGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;padding:1rem;"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Protection Layers</h3>
          </div>
          <div style="padding:1rem;">
            <div style="display:flex;flex-direction:column;gap:0.5rem;" id="protectionLayers">
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;">
                <span style="font-size:1.2rem;">1</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--accent-cyan);">Watchdog</div>
                  <div style="font-size:0.75rem;color:var(--text-secondary);">Every 60s ‚Äî monitors all daemons</div>
                </div>
                <span id="watchdogStatus" style="color:var(--accent-green);">‚óè</span>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;">
                <span style="font-size:1.2rem;">2</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--accent-green);">KeepAlive</div>
                  <div style="font-size:0.75rem;color:var(--text-secondary);">launchd auto-restarts watchdog</div>
                </div>
                <span style="color:var(--accent-green);">‚óè</span>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;">
                <span style="font-size:1.2rem;">3</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--accent-yellow);">Bootstrap</div>
                  <div style="font-size:0.75rem;color:var(--text-secondary);">Login ‚Äî loads everything</div>
                </div>
                <span id="bootstrapStatus" style="color:var(--accent-green);">‚óè</span>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;">
                <span style="font-size:1.2rem;">4</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--accent-purple);">Wake Hook</div>
                  <div style="font-size:0.75rem;color:var(--text-secondary);">Sleep ‚Äî triggers bootstrap</div>
                </div>
                <span id="wakeStatus" style="color:var(--accent-green);">‚óè</span>
              </div>
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;">
                <span style="font-size:1.2rem;">5</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--accent-orange);">Self-Heal</div>
                  <div style="font-size:0.75rem;color:var(--text-secondary);">Every 6h ‚Äî deep health check</div>
                </div>
                <span id="selfHealStatus" style="color:var(--accent-green);">‚óè</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts row 1: Watchdog Activity + Daemon Heal Distribution -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Watchdog Activity</h3>
            <span class="card-badge" id="watchdogDaysBadge">All Days</span>
          </div>
          <div class="chart-container"><canvas id="watchdogActivityChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Daemon Heal Distribution</h3>
            <span class="card-badge" id="totalHealsBadge">0</span>
          </div>
          <div class="chart-container"><canvas id="daemonHealChart"></canvas></div>
        </div>
      </div>

      <!-- Charts row 2: Self-Heal Health + Data Freshness -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Self-Heal Health Checks</h3>
            <span class="card-badge" id="selfHealRunsBadge">0</span>
          </div>
          <div class="chart-container"><canvas id="selfHealChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Data Freshness</h3>
          </div>
          <div class="chart-container"><canvas id="dataFreshnessChart"></canvas></div>
        </div>
      </div>

      <!-- Healing events + Daemon health bars -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Recent Healing Events</h3>
            <span class="card-badge" id="healingCount">0</span>
          </div>
          <div id="healingEvents" style="padding:1rem;max-height:350px;overflow-y:auto;"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Daemon Health</h3>
            <span class="card-badge" id="uptimeBadge">Live</span>
          </div>
          <div id="daemonHealthBars" style="padding:1rem;"></div>
        </div>
      </div>

      <!-- Healing stats + Most healed -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3>Healing Stats</h3>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1rem;">
            <div style="text-align:center;padding:1rem;background:var(--bg-glass);border-radius:8px;">
              <div style="font-size:1.8rem;font-weight:700;color:var(--accent-green);" id="healingTotal">0</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Total Heals</div>
            </div>
            <div style="text-align:center;padding:1rem;background:var(--bg-glass);border-radius:8px;">
              <div style="font-size:1.8rem;font-weight:700;color:var(--accent-cyan);" id="healingToday">0</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Today</div>
            </div>
            <div style="text-align:center;padding:1rem;background:var(--bg-glass);border-radius:8px;">
              <div style="font-size:1.8rem;font-weight:700;color:var(--accent-yellow);" id="healingAvgDay">0</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Avg/Day</div>
            </div>
            <div style="text-align:center;padding:1rem;background:var(--bg-glass);border-radius:8px;">
              <div style="font-size:1.8rem;font-weight:700;color:var(--accent-purple);" id="healingSuccessRate">100%</div>
              <div style="font-size:0.75rem;color:var(--text-secondary);">Success Rate</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Most Healed Daemons</h3>
          </div>
          <div id="mostHealedDaemons" style="padding:1rem;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Infrastructure Commands</h3>
        </div>
        <div class="commands-grid">
          <div class="command-card"><code>ccc-status</code><div class="desc">Full infrastructure status</div></div>
          <div class="command-card"><code>ccc-fix</code><div class="desc">Auto-fix all issues</div></div>
          <div class="command-card"><code>ccc-heal</code><div class="desc">Run healing check</div></div>
          <div class="command-card"><code>ccc-bootstrap</code><div class="desc">Reload everything</div></div>
          <div class="command-card"><code>ccc-watchdog-log</code><div class="desc">Watch live healing</div></div>
          <div class="command-card"><code>/ccc-heal</code><div class="desc">Invoke skill</div></div>
        </div>
      </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê Tab 16: Autonomy Streaks ‚ïê‚ïê‚ïê -->
    <div id="autonomy" class="tab-content">
      <!-- Hero: Record Streak -->
      <div class="stats-row">
        <div class="stat-card" style="background: linear-gradient(135deg, #0d1117 0%, #1a0a2e 100%); border: 2px solid #a855f7; flex: 2;">
          <div class="stat-value" style="font-size: 2.8rem; color: #a855f7;" id="autonomyRecord">--:--:--</div>
          <div class="stat-label">Record Uninterrupted Streak</div>
          <div style="color: #8b949e; font-size: 0.75rem; margin-top: 4px;" id="autonomyRecordMeta"></div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-value" id="autonomyTotalStreaks">--</div>
          <div class="stat-label">Total Streaks</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="autonomyAvgDuration">--</div>
          <div class="stat-label">Avg Duration</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="autonomyAvgGap">--</div>
          <div class="stat-label">Avg Gap (seconds)</div>
        </div>
        <div class="stat-card magenta">
          <div class="stat-value" id="autonomyPermEvents">0</div>
          <div class="stat-label">Permission Events</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
        <div class="card">
          <div class="card-header"><h3>Daily Longest Streak (Last 30 Days)</h3></div>
          <div style="padding: 16px;">
            <canvas id="autonomyDailyChart" height="200"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Streak Duration Distribution</h3></div>
          <div style="padding: 16px;">
            <canvas id="autonomyDistChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card" style="margin-top: 16px;">
        <div class="card-header"><h3>Top 10 Autonomous Streaks</h3></div>
        <div style="padding: 16px; overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
              <tr style="border-bottom: 1px solid #30363d; color: #8b949e;">
                <th style="padding: 8px; text-align: left;">#</th>
                <th style="padding: 8px; text-align: left;">Duration</th>
                <th style="padding: 8px; text-align: left;">Date</th>
                <th style="padding: 8px; text-align: right;">Tools</th>
                <th style="padding: 8px; text-align: right;">Avg Gap</th>
                <th style="padding: 8px; text-align: left;">Projects</th>
                <th style="padding: 8px; text-align: left;">Top Tools</th>
              </tr>
            </thead>
            <tbody id="autonomyLeaderboard"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Tab 17: VAAC Velocity Field ‚ïê‚ïê‚ïê -->
    <div id="velocity" class="tab-content">
      <div class="stats-row" id="velocityStatsRow">
        <div class="stat-card" style="flex:2;">
          <div class="stat-value" style="font-size:2.4rem;" id="velocityComposite">‚Äî</div>
          <div class="stat-label">Composite Velocity</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="velocityLevel">‚Äî</div>
          <div class="stat-label">Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="velocityAgents">‚Äî</div>
          <div class="stat-label">Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="velocityParallelism">‚Äî</div>
          <div class="stat-label">Parallelism</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="velocityEffort">‚Äî</div>
          <div class="stat-label">Effort</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="velocityTrend">‚Äî</div>
          <div class="stat-label">Trend</div>
        </div>
      </div>

      <!-- 10D Velocity Field -->
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <h3>10-Dimensional Velocity Field</h3>
          <span class="card-badge" id="velocityFieldTime">‚Äî</span>
        </div>
        <div style="padding:1rem;" id="velocityFieldBars">
          <div style="color:var(--text-muted);text-align:center;padding:2rem;">Loading velocity field...</div>
        </div>
      </div>

      <!-- Team Composition + VAAC Signals -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
        <div class="card">
          <div class="card-header">
            <h3>Team Composition</h3>
            <span class="card-badge">Heterogeneous</span>
          </div>
          <div style="padding:1rem;" id="velocityTeamMix">
            <div style="color:var(--text-muted);text-align:center;padding:2rem;">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>VAAC 3-Signal Breakdown</h3>
            <span class="card-badge">Fused</span>
          </div>
          <div style="padding:1rem;" id="velocitySignals">
            <div style="color:var(--text-muted);text-align:center;padding:2rem;">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Velocity History Chart -->
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <h3>Velocity History</h3>
          <span class="card-badge">Last 50</span>
        </div>
        <div style="padding:16px;">
          <canvas id="velocityHistoryChart" height="200"></canvas>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer">
    <kbd>1</kbd>-<kbd>9</kbd> tabs 1-9 ¬∑ <kbd>0</kbd>/<kbd>T</kbd> Tools ¬∑ <kbd>O</kbd> Outcomes ¬∑ <kbd>P</kbd> Productivity ¬∑ <kbd>S</kbd> Supermem ¬∑ <kbd>C</kbd> Cognitive ¬∑ <kbd>I</kbd> Infra ¬∑ <kbd>A</kbd> Autonomy ¬∑ <kbd>V</kbd> Velocity ¬∑ <kbd>R</kbd> Refresh
  </footer>

  <script>
    // Tab switching
    document.querySelectorAll('.nav-tab').forEach((tab, i) => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    function switchTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
      if (!tabBtn) return;
      tabBtn.classList.add('active');
      document.getElementById(tabId)?.classList.add('active');
      tabBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      history.replaceState(null, '', '#' + tabId);
    }

    // Restore tab from URL hash on load
    (function() {
      const hash = window.location.hash.slice(1);
      if (hash && document.getElementById(hash)) {
        switchTab(hash);
      }
    })();

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      const tabs = ['overview', 'memory', 'activity', 'cost', 'projects', 'commands', 'routing', 'coevo', 'context-efficiency', 'session-outcomes', 'productivity'];
      if (e.key >= '1' && e.key <= '9') switchTab(tabs[parseInt(e.key) - 1]);
      if (e.key === '0') switchTab('tool-analytics');
      if (e.key.toLowerCase() === 'o') switchTab('session-outcomes');
      if (e.key.toLowerCase() === 'p') switchTab('productivity');
      if (e.key.toLowerCase() === 't') switchTab('tool-analytics');
      if (e.key.toLowerCase() === 's') switchTab('supermemory');
      if (e.key.toLowerCase() === 'c') switchTab('cognitive');
      if (e.key.toLowerCase() === 'i') switchTab('infrastructure');
      if (e.key.toLowerCase() === 'a') switchTab('autonomy');
      if (e.key.toLowerCase() === 'v') switchTab('velocity');
      if (e.key.toLowerCase() === 'r') location.reload();
    });

    // Data injection
    const STATS_DATA = __STATS_DATA__;
    const MEMORY_DATA = __MEMORY_DATA__;
    const ACTIVITY_DATA = __ACTIVITY_DATA__;
    const PROJECTS_DATA = __PROJECTS_DATA__;
    const PROACTIVE_DATA = __PROACTIVE_DATA__;
    const COEVO_DATA = __COEVO_DATA__;
    const PATTERN_TRENDS_DATA = __PATTERN_TRENDS_DATA__;
    const SUBSCRIPTION_DATA = __SUBSCRIPTION_DATA__;
    const ROUTING_DATA = __ROUTING_DATA__;
    const OBSERVATORY_DATA = __OBSERVATORY_DATA__;
    const SESSION_OUTCOMES_DATA = __SESSION_OUTCOMES_DATA__;
    const PACK_DATA = __PACK_DATA__;
    const SESSION_WINDOW_DATA = __SESSION_WINDOW_DATA__;
    const FILE_ACTIVITY_DATA = __FILE_ACTIVITY_DATA__;
    const PRICING_DATA = __PRICING_DATA__;
    const SUPERMEMORY_DATA = __SUPERMEMORY_DATA__;
    const COGNITIVE_DATA = __COGNITIVE_DATA__;
    const RECOVERY_DATA = __RECOVERY_DATA__;
    const COORDINATOR_DATA = __COORDINATOR_DATA__;
    const SESSIONS_DATA = __SESSIONS_DATA__;
    const INFRASTRUCTURE_DATA = __INFRASTRUCTURE_DATA__;
    const AUTONOMY_DATA = __AUTONOMY_DATA__;
    const DAILY_ACTIVITY_DATA = __DAILY_ACTIVITY_DATA__;
    const TOOL_USAGE_DATA = __TOOL_USAGE_DATA__;
    const GIT_ACTIVITY_DATA = __GIT_ACTIVITY_DATA__;

    function formatNumber(n) {
      if (n >= 1000000000) return (n / 1000000000).toFixed(1) + 'B';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n?.toString() || '0';
    }

    function formatCost(n) {
      if (n >= 1000) return '$' + (n / 1000).toFixed(1) + 'K';
      if (n >= 1) return '$' + n.toFixed(2);
      return '$' + n.toFixed(4);
    }

    // Proactive suggestion executor
    function executeSuggestion(type, value) {
      const msg = `Suggestion: ${type} - ${value}\n\nTo use this suggestion:\n`;
      switch(type) {
        case 'skill':
          alert(msg + `Run this in Claude: ${value}`);
          break;
        case 'command':
          alert(msg + `Run in terminal: ${value}`);
          break;
        case 'model':
          alert(msg + `Switch to ${value} model for this task`);
          break;
        case 'memory':
          alert(msg + `Query memory for: ${value}`);
          break;
        default:
          alert(msg + value);
      }
    }

    function init() {
      // Stats row
      const days = STATS_DATA.dailyActivity?.length || 1;
      const totalTools = STATS_DATA.dailyActivity?.reduce((s, d) => s + d.toolCallCount, 0) || 0;
      const avgPerDay = Math.round((STATS_DATA.totalMessages || 0) / days);

      // Calculate week-over-week trends from dailyActivity
      const calculateWeekTrend = (metric) => {
        const daily = STATS_DATA.dailyActivity || [];
        if (daily.length < 8) return null;

        // Last 7 days vs previous 7 days
        const thisWeek = daily.slice(-7);
        const lastWeek = daily.slice(-14, -7);

        if (lastWeek.length < 7) return null;

        const thisSum = thisWeek.reduce((s, d) => s + (d[metric] || 0), 0);
        const lastSum = lastWeek.reduce((s, d) => s + (d[metric] || 0), 0);

        if (lastSum === 0) return { value: null, label: '' };
        const change = ((thisSum - lastSum) / lastSum * 100);
        return {
          value: change >= 0 ? `+${change.toFixed(0)}%` : `${change.toFixed(0)}%`,
          label: 'vs last wk',
          up: change >= 0
        };
      };

      const roiMultiplier = SUBSCRIPTION_DATA?.multiplier || 0;
      const sessionTrend = calculateWeekTrend('sessionCount');
      const messageTrend = calculateWeekTrend('messageCount');
      const toolTrend = calculateWeekTrend('toolCallCount');

      // Get longest session info
      const longest = STATS_DATA.longestSession || {};
      const longestLabel = longest.messageCount > 0 ? `${longest.messageCount} msgs` : '‚Äî';

      const stats = [
        { icon: 'üìä', value: STATS_DATA.totalSessions || 0, label: 'Sessions', trend: sessionTrend?.value, trendLabel: sessionTrend?.label, up: sessionTrend?.up },
        { icon: 'üí¨', value: STATS_DATA.totalMessages || 0, label: 'Messages', trend: messageTrend?.value, trendLabel: messageTrend?.label, up: messageTrend?.up },
        { icon: 'üîß', value: totalTools, label: 'Tool Calls', trend: toolTrend?.value, trendLabel: toolTrend?.label, up: toolTrend?.up },
        { icon: 'üìà', value: avgPerDay, label: 'Avg/Day', trend: null },
        { icon: 'üí∞', value: roiMultiplier + 'x', label: 'ROI', trend: roiMultiplier > 50 ? 'üî•' : null, up: true, raw: true },
        { icon: '‚è±Ô∏è', value: longestLabel, label: 'Longest Session', trend: null, raw: true },
      ];

      document.getElementById('statsRow').innerHTML = stats.map(s => `
        <div class="stat-card">
          <div class="icon">${s.icon}</div>
          <div class="value">${s.raw ? s.value : formatNumber(s.value)}</div>
          <div class="label">${s.label}</div>
          ${s.trend ? `<div class="trend ${s.up ? 'up' : 'down'}">${s.trend}${s.trendLabel ? ` <span style="font-size:0.7em;opacity:0.7">${s.trendLabel}</span>` : ''}</div>` : ''}
        </div>
      `).join('');

      // Proactive suggestions (Phase 4 - ProactiveVA)
      if (PROACTIVE_DATA.hasContext && PROACTIVE_DATA.suggestions?.length > 0) {
        const panel = document.getElementById('proactivePanel');
        const pattern = PROACTIVE_DATA.topPattern || {};

        document.getElementById('proactiveIcon').textContent = pattern.icon || 'üéØ';
        document.getElementById('proactiveTitle').textContent = 'Proactive Suggestions';
        document.getElementById('proactivePattern').textContent = pattern.name || 'Pattern Detected';
        document.getElementById('proactiveContext').textContent =
          `Based on your recent activity, you appear to be in a ${pattern.name || 'focused'} session.`;

        document.getElementById('proactiveSuggestions').innerHTML =
          PROACTIVE_DATA.suggestions.slice(0, 4).map(s => `
            <div class="suggestion-item" onclick="executeSuggestion('${s.type}', '${s.value}')">
              <div class="suggestion-type">${s.type}</div>
              <div class="suggestion-label">${s.label}</div>
              <div class="suggestion-desc">${s.desc}</div>
            </div>
          `).join('');

        panel.style.display = 'block';
      }

      // Session Window Panel
      if (SESSION_WINDOW_DATA) {
        const sw = SESSION_WINDOW_DATA;
        const position = sw.window?.positionPercent || 0;
        const remaining = sw.window?.remainingMinutes || 0;
        const tier = sw.capacity?.tier || 'UNKNOWN';
        const capacity = sw.capacity?.remaining || {};
        const budget = sw.budget?.utilizationPercent || 0;
        const queueCount = sw.queue?.pending || 0;

        // Update progress bar
        document.getElementById('sessionProgressFill').style.width = position + '%';
        document.getElementById('sessionPosition').textContent = position + '%';

        // Update remaining time
        const hours = Math.floor(remaining / 60);
        const mins = remaining % 60;
        document.getElementById('sessionRemaining').textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

        // Update capacity stats
        document.getElementById('sessionOpus').textContent = capacity.opus || 0;
        document.getElementById('sessionSonnet').textContent = capacity.sonnet || 0;
        document.getElementById('sessionHaiku').textContent = capacity.haiku || 0;
        document.getElementById('sessionBudget').textContent = budget + '%';
        document.getElementById('sessionQueue').textContent = queueCount;

        // Update tier badge
        const tierBadge = document.getElementById('sessionTierBadge');
        tierBadge.textContent = tier;
        tierBadge.className = 'card-badge tier-' + tier.toLowerCase();

        // Update recommendations
        const recs = sw.recommendations || [];
        if (recs.length > 0) {
          document.getElementById('sessionRecommendations').innerHTML = recs.slice(0, 3).map(r =>
            `<span class="session-rec">${r}</span>`
          ).join('');
        }
      }

      // Token breakdown
      const modelData = Object.values(STATS_DATA.modelUsage || {})[0] || {};
      const tokens = [
        { label: 'Output', value: modelData.outputTokens || 0, color: 'var(--accent-red)' },
        { label: 'Input', value: modelData.inputTokens || 0, color: 'var(--accent-orange)' },
        { label: 'Cache Read', value: modelData.cacheReadInputTokens || 0, color: 'var(--accent-yellow)' },
        { label: 'Cache Create', value: modelData.cacheCreationInputTokens || 0, color: 'var(--accent-cyan)' }
      ];
      document.getElementById('tokenBreakdown').innerHTML = tokens.map(t => `
        <div class="token-item">
          <div class="value" style="color: ${t.color}">${formatNumber(t.value)}</div>
          <div class="label">${t.label}</div>
        </div>
      `).join('');

      // Charts
      Chart.defaults.color = '#888';
      Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
      Chart.defaults.font.family = 'Inter';
      Chart.defaults.interaction = { mode: 'index', intersect: false };
      Chart.defaults.plugins.tooltip = {
        ...Chart.defaults.plugins.tooltip,
        backgroundColor: 'rgba(10, 12, 22, 0.95)',
        borderColor: 'rgba(0, 217, 255, 0.3)',
        borderWidth: 1,
        titleFont: { family: 'JetBrains Mono', size: 11 },
        bodyFont: { family: 'Inter', size: 12 },
        padding: 10,
        cornerRadius: 8,
        displayColors: true,
        boxPadding: 4,
      };

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: { left: 10, right: 10, top: 10, bottom: 10 }
        },
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { maxRotation: 0, autoSkip: true } },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              padding: 8,
              callback: function(value) {
                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                return value;
              }
            }
          }
        }
      };

      if (STATS_DATA.dailyActivity?.length) {
        const labels = STATS_DATA.dailyActivity.map(d => d.date.slice(5));

        // Message chart with gradient bars
        const msgCtx = document.getElementById('messagesChart').getContext('2d');
        const msgGrad = msgCtx.createLinearGradient(0, 0, 0, 280);
        msgGrad.addColorStop(0, 'rgba(233,69,96,0.9)');
        msgGrad.addColorStop(1, 'rgba(233,69,96,0.3)');

        new Chart(msgCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              data: STATS_DATA.dailyActivity.map(d => d.messageCount),
              backgroundColor: msgGrad,
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: chartOptions
        });

        // Tool chart with gradient bars
        const toolCtx = document.getElementById('toolsChart').getContext('2d');
        const toolGrad = toolCtx.createLinearGradient(0, 0, 0, 280);
        toolGrad.addColorStop(0, 'rgba(254,202,87,0.9)');
        toolGrad.addColorStop(1, 'rgba(254,202,87,0.3)');

        new Chart(toolCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              data: STATS_DATA.dailyActivity.map(d => d.toolCallCount),
              backgroundColor: toolGrad,
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: chartOptions
        });
      }

      if (STATS_DATA.dailyModelTokens?.length) {
        const tokenLabels = STATS_DATA.dailyModelTokens.map(d => d.date.slice(5));
        new Chart(document.getElementById('tokensChart'), {
          type: 'line',
          data: {
            labels: tokenLabels,
            datasets: [
              {
                label: 'Opus',
                data: STATS_DATA.dailyModelTokens.map(d => d.tokensByModel?.opus || 0),
                borderColor: 'rgba(233,69,96,1)',
                backgroundColor: 'rgba(233,69,96,0.15)',
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: 'rgba(233,69,96,1)'
              },
              {
                label: 'Sonnet',
                data: STATS_DATA.dailyModelTokens.map(d => d.tokensByModel?.sonnet || 0),
                borderColor: 'rgba(72,219,251,1)',
                backgroundColor: 'rgba(72,219,251,0.15)',
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: 'rgba(72,219,251,1)'
              },
              {
                label: 'Haiku',
                data: STATS_DATA.dailyModelTokens.map(d => d.tokensByModel?.haiku || 0),
                borderColor: 'rgba(254,202,87,1)',
                backgroundColor: 'rgba(254,202,87,0.15)',
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: 'rgba(254,202,87,1)'
              }
            ]
          },
          options: {
            ...chartOptions,
            plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
            scales: {
              ...chartOptions.scales,
              y: { ...chartOptions.scales.y, stacked: true },
              x: { ...chartOptions.scales.x, stacked: true }
            }
          }
        });
      }

      // Hour chart
      const hourData = Array(24).fill(0);
      Object.entries(STATS_DATA.hourCounts || {}).forEach(([h, c]) => hourData[parseInt(h)] = c);
      const maxHour = Math.max(...hourData);

      new Chart(document.getElementById('hourChart'), {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => i + 'h'),
          datasets: [{
            data: hourData,
            backgroundColor: hourData.map(v => `rgba(233,69,96,${0.2 + (v/maxHour)*0.8})`),
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: chartOptions
      });

      // Memory tab
      {
        const facts = MEMORY_DATA.facts || [];
        const decisions = MEMORY_DATA.decisions || [];
        const patterns = MEMORY_DATA.patterns || [];
        const memProjects = MEMORY_DATA.projects || {};
        const allItems = [...facts, ...decisions, ...patterns];

        // Stat cards
        const nFacts = facts.length, nDec = decisions.length, nPat = patterns.length, nProj = Object.keys(memProjects).length;
        document.getElementById('memTotalItems').textContent = (nFacts + nDec + nPat).toLocaleString();
        document.getElementById('memFactCount').textContent = nFacts;
        document.getElementById('memDecisionCount').textContent = nDec;
        document.getElementById('memPatternCount').textContent = nPat;
        document.getElementById('memProjectCount').textContent = nProj;

        // Compute all tags
        const tagCounts = {};
        const tagsByType = { facts: {}, decisions: {}, patterns: {} };
        const countTags = (items, type) => {
          items.forEach(item => {
            (item.tags || []).forEach(t => {
              tagCounts[t] = (tagCounts[t] || 0) + 1;
              tagsByType[type][t] = (tagsByType[type][t] || 0) + 1;
            });
          });
        };
        countTags(facts, 'facts');
        countTags(decisions, 'decisions');
        countTags(patterns, 'patterns');
        const uniqueTags = Object.keys(tagCounts).length;
        document.getElementById('memTagCount').textContent = uniqueTags;

        // --- Chart 1: Knowledge Distribution (doughnut) ---
        if (nFacts + nDec + nPat > 0) {
          new Chart(document.getElementById('memDistChart'), {
            type: 'doughnut',
            data: {
              labels: ['Facts', 'Decisions', 'Patterns'],
              datasets: [{
                data: [nFacts, nDec, nPat],
                backgroundColor: ['rgba(72,219,251,0.8)', 'rgba(177,78,255,0.8)', 'rgba(255,204,0,0.8)'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } },
                tooltip: { callbacks: { label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  return ` ${ctx.label}: ${ctx.raw} (${(ctx.raw / total * 100).toFixed(1)}%)`;
                }}}
              }
            }
          });
          document.getElementById('memDistBadge').textContent = (nFacts + nDec + nPat) + ' items';
        }

        // --- Chart 2: Top Tags (horizontal bar) ---
        const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 12);
        if (sortedTags.length > 0) {
          const tagColors = ['rgba(72,219,251,0.7)', 'rgba(0,255,136,0.7)', 'rgba(177,78,255,0.7)', 'rgba(255,204,0,0.7)', 'rgba(233,69,96,0.7)', 'rgba(255,152,0,0.7)', 'rgba(100,181,246,0.7)', 'rgba(174,213,129,0.7)', 'rgba(255,112,67,0.7)', 'rgba(77,208,225,0.7)', 'rgba(156,39,176,0.7)', 'rgba(139,195,74,0.7)'];
          new Chart(document.getElementById('memTagChart'), {
            type: 'bar',
            data: {
              labels: sortedTags.map(([t]) => t),
              datasets: [{
                label: 'Count',
                data: sortedTags.map(([, c]) => c),
                backgroundColor: sortedTags.map((_, i) => tagColors[i % tagColors.length]),
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)', stepSize: 5 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }, grid: { display: false } }
              }
            }
          });
          document.getElementById('memTagBadge').textContent = uniqueTags + ' unique';
        }

        // --- Chart 3: Knowledge Growth (grouped bar by month) ---
        const monthlyGrowth = {};
        const addToMonth = (items, type) => {
          items.forEach(item => {
            const m = (item.timestamp || '').substring(0, 7);
            if (m) {
              if (!monthlyGrowth[m]) monthlyGrowth[m] = { facts: 0, decisions: 0, patterns: 0 };
              monthlyGrowth[m][type]++;
            }
          });
        };
        addToMonth(facts, 'facts');
        addToMonth(decisions, 'decisions');
        addToMonth(patterns, 'patterns');
        const months = Object.keys(monthlyGrowth).sort();
        if (months.length > 0) {
          new Chart(document.getElementById('memGrowthChart'), {
            type: 'bar',
            data: {
              labels: months,
              datasets: [
                { label: 'Facts', data: months.map(m => monthlyGrowth[m].facts), backgroundColor: 'rgba(72,219,251,0.8)' },
                { label: 'Decisions', data: months.map(m => monthlyGrowth[m].decisions), backgroundColor: 'rgba(177,78,255,0.8)' },
                { label: 'Patterns', data: months.map(m => monthlyGrowth[m].patterns), backgroundColor: 'rgba(255,204,0,0.8)' }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              scales: {
                x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
              },
              plugins: { legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } } }
            }
          });
          document.getElementById('memGrowthBadge').textContent = months.length + ' months';
        }

        // --- Chart 4: Tags by Knowledge Type (stacked horizontal bar) ---
        const topTagNames = sortedTags.slice(0, 8).map(([t]) => t);
        if (topTagNames.length > 0) {
          new Chart(document.getElementById('memTagTypeChart'), {
            type: 'bar',
            data: {
              labels: topTagNames,
              datasets: [
                { label: 'Facts', data: topTagNames.map(t => tagsByType.facts[t] || 0), backgroundColor: 'rgba(72,219,251,0.8)' },
                { label: 'Decisions', data: topTagNames.map(t => tagsByType.decisions[t] || 0), backgroundColor: 'rgba(177,78,255,0.8)' },
                { label: 'Patterns', data: topTagNames.map(t => tagsByType.patterns[t] || 0), backgroundColor: 'rgba(255,204,0,0.8)' }
              ]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              scales: {
                x: { stacked: true, beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)', stepSize: 5 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { stacked: true, ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }, grid: { display: false } }
              },
              plugins: { legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } } }
            }
          });
        }

        // --- Render item lists (enhanced with tag colors) ---
        const tagColorMap = { usage: '#48dbfb', patterns: '#ffcc00', history: '#b14eff', research: '#00ff88', ucw: '#ff6b6b', architecture: '#ff9f43', infrastructure: '#a29bfe', dashboard: '#ffeaa7', workflow: '#55efc4', data: '#74b9ff' };
        const renderMemoryItems = (items, containerId, countId, typeColor) => {
          const container = document.getElementById(containerId);
          document.getElementById(countId).textContent = items?.length || 0;
          if (!items?.length) { container.innerHTML = '<p style="color:var(--text-muted);padding:1rem;">No items yet</p>'; return; }
          const sorted = [...items].sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
          container.innerHTML = sorted.map(item => `
            <div class="memory-item" style="border-left:3px solid ${typeColor};padding:0.75rem;margin-bottom:0.5rem;background:var(--bg-glass);border-radius:6px;">
              <div class="content" style="color:var(--text-primary);font-size:0.85rem;line-height:1.4;">${item.content}</div>
              <div class="meta" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.4rem;">
                <span class="time" style="color:var(--text-muted);font-size:0.7rem;">${item.timestamp ? new Date(item.timestamp).toLocaleDateString() : ''}</span>
                <div class="tags" style="display:flex;gap:4px;flex-wrap:wrap;">
                  ${(item.tags || []).map(t => `<span style="background:${(tagColorMap[t] || '#888')}22;color:${tagColorMap[t] || '#888'};padding:1px 6px;border-radius:3px;font-size:0.65rem;">${t}</span>`).join('')}
                </div>
              </div>
            </div>
          `).join('');
        };

        renderMemoryItems(decisions, 'memoryDecisions', 'decisionCount', '#b14eff');
        renderMemoryItems(facts, 'memoryFacts', 'factCount', '#48dbfb');
        renderMemoryItems(patterns, 'memoryPatterns', 'patternCount', '#ffcc00');

        // Project context
        document.getElementById('projectMemCount').textContent = nProj;
        const projectsContainer = document.getElementById('memoryProjects');
        if (nProj > 0) {
          projectsContainer.innerHTML = Object.entries(memProjects).map(([key, val]) => `
            <div class="memory-item" style="border-left:3px solid #00ff88;padding:0.75rem;margin-bottom:0.5rem;background:var(--bg-glass);border-radius:6px;">
              <div class="content" style="color:var(--text-primary);font-size:0.85rem;line-height:1.4;"><strong style="color:#00ff88;">${key}:</strong> ${val.content}</div>
              <div class="meta" style="display:flex;justify-content:space-between;align-items:center;margin-top:0.4rem;">
                <span style="color:var(--text-muted);font-size:0.7rem;">${val.timestamp ? new Date(val.timestamp).toLocaleDateString() : ''}</span>
                <div style="display:flex;gap:4px;flex-wrap:wrap;">
                  ${(val.tags || []).map(t => `<span style="background:${(tagColorMap[t] || '#888')}22;color:${tagColorMap[t] || '#888'};padding:1px 6px;border-radius:3px;font-size:0.65rem;">${t}</span>`).join('')}
                </div>
              </div>
            </div>
          `).join('');
        } else {
          projectsContainer.innerHTML = '<p style="color:var(--text-muted);padding:1rem;">No project context yet</p>';
        }

        // Memory filter search
        document.getElementById('memorySearch').addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          document.querySelectorAll('.memory-item').forEach(item => {
            const content = item.textContent.toLowerCase();
            item.style.display = content.includes(query) ? '' : 'none';
          });
        });

        // --- Interactive Memory Chat ---
        const memChatMessages = document.getElementById('memChatMessages');
        const memChatInput = document.getElementById('memChatInput');
        const memChatSend = document.getElementById('memChatSend');
        const memChatSource = document.getElementById('memChatSource');

        // Update badge with total searchable count
        fetch('http://localhost:8766/api/memory/stats')
          .then(r => r.json())
          .then(stats => {
            const total = stats.total_searchable || 0;
            document.getElementById('memChatBadge').textContent = total.toLocaleString() + ' searchable';
          })
          .catch(() => {});

        const srcColors = {
          knowledge: '#48dbfb', supermemory: '#a29bfe',
          sessions: '#00ff88', error_pattern: '#ff6b6b'
        };
        const catColors = {
          facts: '#48dbfb', decisions: '#b14eff', patterns: '#ffcc00',
          learning: '#55efc4', memory: '#a29bfe', error_pattern: '#ff6b6b',
          session: '#00ff88', routing: '#ff9f43'
        };

        function addChatMessage(type, content) {
          const div = document.createElement('div');
          div.style.cssText = type === 'user'
            ? 'align-self:flex-end;background:rgba(108,92,231,0.2);border:1px solid rgba(108,92,231,0.3);border-radius:12px 12px 2px 12px;padding:0.6rem 0.8rem;max-width:80%;font-size:0.85rem;color:var(--text-primary);'
            : 'align-self:flex-start;max-width:100%;';
          div.innerHTML = content;
          memChatMessages.appendChild(div);
          memChatMessages.scrollTop = memChatMessages.scrollHeight;
          return div;
        }

        function renderResults(data) {
          const results = data.results || [];
          const summary = data.summary || {};
          if (results.length === 0) {
            return '<div style="color:var(--text-muted);font-size:0.85rem;padding:0.5rem;">No results found. Try different keywords or broader terms.</div>';
          }

          let html = '<div style="display:flex;gap:0.4rem;margin-bottom:0.5rem;flex-wrap:wrap;">';
          html += `<span style="background:rgba(255,255,255,0.06);color:var(--text-muted);padding:2px 8px;border-radius:4px;font-size:0.7rem;">${summary.total || results.length} results</span>`;
          for (const [src, cnt] of Object.entries(summary.by_source || {})) {
            if (cnt > 0) {
              html += `<span style="background:${(srcColors[src] || '#888')}22;color:${srcColors[src] || '#888'};padding:2px 8px;border-radius:4px;font-size:0.7rem;">${src}: ${cnt}</span>`;
            }
          }
          html += '</div>';

          html += '<div style="display:flex;flex-direction:column;gap:0.4rem;">';
          for (const r of results) {
            const srcColor = srcColors[r.source] || '#888';
            const catColor = catColors[r.category] || srcColor;
            const sim = r.similarity ? (r.similarity * 100).toFixed(0) + '%' : '';
            const content = (r.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const tags = Array.isArray(r.tags) ? r.tags : [];
            const tagHtml = tags.map(t => `<span style="background:${(tagColorMap[t] || '#888')}22;color:${tagColorMap[t] || '#888'};padding:1px 5px;border-radius:3px;font-size:0.6rem;">${t}</span>`).join('');

            html += `<div style="border-left:3px solid ${catColor};padding:0.5rem 0.6rem;background:var(--bg-glass);border-radius:4px;font-size:0.8rem;">`;
            html += `<div style="display:flex;gap:0.3rem;margin-bottom:0.3rem;align-items:center;">`;
            html += `<span style="background:${srcColor}22;color:${srcColor};padding:1px 6px;border-radius:3px;font-size:0.65rem;font-weight:600;">${r.source}</span>`;
            html += `<span style="background:${catColor}22;color:${catColor};padding:1px 6px;border-radius:3px;font-size:0.65rem;">${r.category}</span>`;
            if (sim) html += `<span style="color:var(--text-muted);font-size:0.65rem;margin-left:auto;">${sim} ${r.search_type || ''}</span>`;
            html += '</div>';
            html += `<div style="color:var(--text-primary);line-height:1.4;">${content}</div>`;
            if (tagHtml) html += `<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:0.3rem;">${tagHtml}</div>`;
            html += '</div>';
          }
          html += '</div>';
          return html;
        }

        async function sendMemoryQuery() {
          const query = memChatInput.value.trim();
          if (!query) return;

          memChatInput.value = '';
          addChatMessage('user', query.replace(/</g, '&lt;'));

          const loadingDiv = addChatMessage('system', '<div style="color:var(--text-muted);font-size:0.8rem;padding:0.4rem;">Searching...</div>');

          try {
            const source = memChatSource.value;
            const resp = await fetch('http://localhost:8766/api/memory/query', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query, source, limit: 10 })
            });
            const data = await resp.json();
            loadingDiv.innerHTML = renderResults(data);
          } catch (err) {
            loadingDiv.innerHTML = `<div style="color:#ff6b6b;font-size:0.8rem;padding:0.4rem;">API unavailable. Start the server: <code style="background:rgba(255,255,255,0.06);padding:2px 6px;border-radius:3px;">python3 ~/.claude/scripts/ccc-api-server.py</code></div>`;
          }
          memChatMessages.scrollTop = memChatMessages.scrollHeight;
        }

        memChatSend.addEventListener('click', sendMemoryQuery);
        memChatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMemoryQuery(); }
        });
      }

      // Activity tab
      const activityLog = document.getElementById('activityLog');
      document.getElementById('activityCount').textContent = ACTIVITY_DATA.length + ' entries';

      activityLog.innerHTML = ACTIVITY_DATA.slice().reverse().map(line => {
        if (line.includes('SESSION')) {
          return `<div class="activity-item"><span class="type session">SESSION</span><span class="detail">${line}</span></div>`;
        }
        const match = line.match(/^(\d{2}:\d{2}:\d{2})\s+(\w+)\s*(.*)?$/);
        if (match) {
          const [, time, type, detail] = match;
          return `<div class="activity-item">
            <span class="time">${time}</span>
            <span class="type ${type.toLowerCase()}">${type}</span>
            <span class="detail">${detail || ''}</span>
          </div>`;
        }
        return `<div class="activity-item"><span class="detail">${line}</span></div>`;
      }).join('');

      // Activity stats ‚Äî all-time from SQLite tool_events
      const dailyAct = DAILY_ACTIVITY_DATA || {};
      const allTime = dailyAct.allTime || {};
      document.getElementById('todayActions').textContent = formatNumber(allTime.total || 0);
      document.getElementById('todayWrites').textContent = formatNumber(allTime.writes || 0);
      document.getElementById('todayEdits').textContent = formatNumber(allTime.edits || 0);
      document.getElementById('todayBash').textContent = formatNumber(allTime.bash || 0);

      // Daily Tool Activity Chart (stacked bar ‚Äî Bash, Write, Edit, Read over time)
      const dailyToolData = dailyAct.daily || [];
      if (dailyToolData.length) {
        document.getElementById('toolDaysCount').textContent = dailyToolData.length + ' days';
        new Chart(document.getElementById('dailyToolActivityChart'), {
          type: 'bar',
          data: {
            labels: dailyToolData.map(d => d.date.slice(5)),
            datasets: [
              { label: 'Bash', data: dailyToolData.map(d => d.bash), backgroundColor: 'rgba(233,69,96,0.8)', borderRadius: 2 },
              { label: 'Read', data: dailyToolData.map(d => d.reads), backgroundColor: 'rgba(72,219,251,0.8)', borderRadius: 2 },
              { label: 'Edit', data: dailyToolData.map(d => d.edits), backgroundColor: 'rgba(254,202,87,0.8)', borderRadius: 2 },
              { label: 'Write', data: dailyToolData.map(d => d.writes), backgroundColor: 'rgba(0,230,118,0.8)', borderRadius: 2 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
            scales: {
              x: { stacked: true, ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } },
              y: { stacked: true, ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      }

      // Tool Breakdown Chart (horizontal bar ‚Äî top tools)
      const toolUsage = TOOL_USAGE_DATA || {};
      const byTool = toolUsage.byTool || {};
      const toolNames = Object.keys(byTool).slice(0, 12);
      const toolCounts = toolNames.map(t => byTool[t]);
      if (toolNames.length) {
        document.getElementById('toolTotalCount').textContent = formatNumber(toolUsage.total || 0) + ' total';
        new Chart(document.getElementById('toolBreakdownChart'), {
          type: 'bar',
          data: {
            labels: toolNames,
            datasets: [{
              data: toolCounts,
              backgroundColor: toolNames.map((_, i) => {
                const colors = ['rgba(233,69,96,0.8)','rgba(72,219,251,0.8)','rgba(254,202,87,0.8)','rgba(0,230,118,0.8)','rgba(155,89,182,0.8)','rgba(243,156,18,0.8)','rgba(46,204,113,0.8)','rgba(52,152,219,0.8)','rgba(231,76,60,0.8)','rgba(26,188,156,0.8)','rgba(241,196,15,0.8)','rgba(230,126,34,0.8)'];
                return colors[i % colors.length];
              }),
              borderRadius: 4
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: '#888', font: { size: 11 } }, grid: { display: false } }
            }
          }
        });
      }

      // Heatmap
      const heatmapGrid = document.getElementById('heatmapGrid');
      heatmapGrid.innerHTML = Array.from({length: 24}, (_, i) => {
        const intensity = hourData[i] / maxHour;
        const color = `rgba(233,69,96,${0.1 + intensity * 0.9})`;
        return `<div class="heatmap-cell" style="background:${color}" data-hour="${i}h" title="${hourData[i]} sessions at ${i}:00"></div>`;
      }).join('');

      // Cost tab ‚Äî aggregate ALL models
      const mu = STATS_DATA.modelUsage || {};
      const allCacheRead = Object.values(mu).reduce((s, m) => s + (m.cacheReadInputTokens || 0), 0);
      const allInputTokens = Object.values(mu).reduce((s, m) => s + (m.inputTokens || 0), 0);
      const allOutputTokens = Object.values(mu).reduce((s, m) => s + (m.outputTokens || 0), 0);

      // Per-model API pricing from pricing.json (per million tokens)
      const _pr = typeof PRICING_DATA !== 'undefined' ? PRICING_DATA.models || {} : {};
      const pricing = {
        opus: { input: _pr.opus?.input || 5, output: _pr.opus?.output || 25, cacheRead: _pr.opus?.cache_read || 0.50 },
        sonnet: { input: _pr.sonnet?.input || 3, output: _pr.sonnet?.output || 15, cacheRead: _pr.sonnet?.cache_read || 0.30 },
        haiku: { input: _pr.haiku?.input || 1, output: _pr.haiku?.output || 5, cacheRead: _pr.haiku?.cache_read || 0.10 }
      };

      // Calculate per-model costs (API value = what you'd pay at API rates)
      const modelCosts = {};
      let totalApiValue = 0;
      let totalCacheSavings = 0;
      for (const [model, data] of Object.entries(mu)) {
        const p = pricing[model] || pricing.opus;
        const inputCost = ((data.inputTokens || 0) * p.input) / 1e6;
        const outputCost = ((data.outputTokens || 0) * p.output) / 1e6;
        const cacheReadCost = ((data.cacheReadInputTokens || 0) * p.cacheRead) / 1e6;
        // Cache savings = difference between full input price and discounted cache read price
        const cacheSaving = ((data.cacheReadInputTokens || 0) * (p.input - p.cacheRead)) / 1e6;
        modelCosts[model] = inputCost + outputCost + cacheReadCost;
        totalApiValue += inputCost + outputCost + cacheReadCost;
        totalCacheSavings += cacheSaving;
      }

      const monthlyRate = SUBSCRIPTION_DATA?.rate || 200;
      const subscriptionCost = days * (monthlyRate / 30); // monthly rate / 30 days
      const roiMultiplierVal = totalApiValue / Math.max(subscriptionCost, 1);

      // Hero cards
      document.getElementById('costApiValue').textContent = formatCost(totalApiValue);
      document.getElementById('costSubscription').textContent = formatCost(subscriptionCost);
      document.getElementById('costRoi').textContent = roiMultiplierVal.toFixed(1) + 'x';
      document.getElementById('costSaved').textContent = formatCost(totalCacheSavings);

      // Per-model breakdown cards
      for (const model of ['opus', 'sonnet', 'haiku']) {
        const cost = modelCosts[model] || 0;
        const pct = totalApiValue > 0 ? ((cost / totalApiValue) * 100).toFixed(1) : '0';
        document.getElementById('cost' + model.charAt(0).toUpperCase() + model.slice(1)).textContent = formatCost(cost);
        document.getElementById('cost' + model.charAt(0).toUpperCase() + model.slice(1) + 'Pct').textContent = pct + '% of total';
      }
      document.getElementById('costAvgDay').textContent = formatCost(totalApiValue / Math.max(days, 1));
      document.getElementById('costDaysCount').textContent = days + ' days tracked';

      // Cache efficiency
      const efficiency = allCacheRead / (allCacheRead + allInputTokens) * 100 || 0;
      document.getElementById('efficiencyPercent').textContent = efficiency.toFixed(1) + '%';
      document.getElementById('efficiencyFill').style.width = efficiency + '%';
      document.getElementById('cacheMissLabel').textContent = (100 - efficiency).toFixed(1) + '% Cache Miss (Paid)';
      document.getElementById('cacheHitLabel').textContent = efficiency.toFixed(1) + '% Cache Hit (Free)';
      document.getElementById('inputTokensDisplay').textContent = formatNumber(allInputTokens);
      document.getElementById('outputTokensDisplay').textContent = formatNumber(allOutputTokens);
      document.getElementById('cacheReadDisplay').textContent = formatNumber(allCacheRead);

      // Charts
      if (STATS_DATA.dailyModelTokens?.length) {
        const dmt = STATS_DATA.dailyModelTokens;
        const costLabels = dmt.map(d => d.date.slice(5));

        // Real per-token pricing from pricing.json
        const pr = typeof PRICING_DATA !== 'undefined' ? PRICING_DATA.models || {} : {};
        const opusIn = (pr.opus?.input || 5) / 1e6, opusOut = (pr.opus?.output || 25) / 1e6, opusCache = (pr.opus?.cache_read || 0.5) / 1e6;
        const sonIn = (pr.sonnet?.input || 3) / 1e6, sonOut = (pr.sonnet?.output || 15) / 1e6, sonCache = (pr.sonnet?.cache_read || 0.3) / 1e6;
        const haiIn = (pr.haiku?.input || 1) / 1e6, haiOut = (pr.haiku?.output || 5) / 1e6, haiCache = (pr.haiku?.cache_read || 0.1) / 1e6;
        const dailySubRate = monthlyRate / 30;

        // Daily API Cost vs subscription line (uses real per-token pricing)
        const dailyCosts = dmt.map(d => {
          const tok = d.tokensByModel || {};
          const dtl = d.tokenDetail || {};
          if (dtl.opus_in !== undefined) {
            return +((dtl.opus_in || 0) * opusIn + (dtl.opus_out || 0) * opusOut + (dtl.opus_cache || 0) * opusCache
                    + (dtl.sonnet_in || 0) * sonIn + (dtl.sonnet_out || 0) * sonOut + (dtl.sonnet_cache || 0) * sonCache
                    + (dtl.haiku_in || 0) * haiIn + (dtl.haiku_out || 0) * haiOut + (dtl.haiku_cache || 0) * haiCache).toFixed(2);
          }
          // Fallback: blended cache-weighted rates
          return +((tok.opus || 0) * opusCache + (tok.sonnet || 0) * sonCache + (tok.haiku || 0) * haiCache).toFixed(2);
        });

        new Chart(document.getElementById('costChart'), {
          type: 'bar',
          data: {
            labels: costLabels,
            datasets: [
              {
                label: 'API Value',
                data: dailyCosts,
                backgroundColor: 'rgba(233,69,96,0.8)',
                borderRadius: 4,
                order: 2
              },
              {
                label: '$' + monthlyRate + '/mo Subscription',
                data: Array(dmt.length).fill(+(monthlyRate / 30).toFixed(2)),
                type: 'line',
                borderColor: 'rgba(0,230,118,0.8)',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                order: 1
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
            scales: {
              y: { ticks: { color: '#666', callback: v => '$' + v }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } }
            }
          }
        });

        // Stacked cost by model per day (uses real per-token pricing when available)
        new Chart(document.getElementById('modelCostChart'), {
          type: 'bar',
          data: {
            labels: costLabels,
            datasets: [
              {
                label: 'Opus',
                data: dmt.map(d => {
                  const dtl = d.tokenDetail || {};
                  if (dtl.opus_in !== undefined) {
                    return +((dtl.opus_in || 0) * opusIn + (dtl.opus_out || 0) * opusOut + (dtl.opus_cache || 0) * opusCache).toFixed(2);
                  }
                  return +((d.tokensByModel?.opus || 0) * opusCache).toFixed(2);
                }),
                backgroundColor: 'rgba(233,69,96,0.8)',
                borderRadius: 2
              },
              {
                label: 'Sonnet',
                data: dmt.map(d => {
                  const dtl = d.tokenDetail || {};
                  if (dtl.sonnet_in !== undefined) {
                    return +((dtl.sonnet_in || 0) * sonIn + (dtl.sonnet_out || 0) * sonOut + (dtl.sonnet_cache || 0) * sonCache).toFixed(2);
                  }
                  return +((d.tokensByModel?.sonnet || 0) * sonCache).toFixed(2);
                }),
                backgroundColor: 'rgba(72,219,251,0.8)',
                borderRadius: 2
              },
              {
                label: 'Haiku',
                data: dmt.map(d => {
                  const dtl = d.tokenDetail || {};
                  if (dtl.haiku_in !== undefined) {
                    return +((dtl.haiku_in || 0) * haiIn + (dtl.haiku_out || 0) * haiOut + (dtl.haiku_cache || 0) * haiCache).toFixed(2);
                  }
                  return +((d.tokensByModel?.haiku || 0) * haiCache).toFixed(2);
                }),
                backgroundColor: 'rgba(254,202,87,0.8)',
                borderRadius: 2
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
            scales: {
              x: { stacked: true, ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } },
              y: { stacked: true, ticks: { color: '#666', callback: v => '$' + v }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });

        // Token distribution doughnut ‚Äî all models
        new Chart(document.getElementById('efficiencyChart'), {
          type: 'doughnut',
          data: {
            labels: ['Cache Hit', 'Input (Paid)', 'Output'],
            datasets: [{
              data: [allCacheRead, allInputTokens, allOutputTokens],
              backgroundColor: ['rgba(74,222,128,0.8)', 'rgba(233,69,96,0.8)', 'rgba(254,202,87,0.8)'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#888' } },
              tooltip: { callbacks: { label: ctx => ctx.label + ': ' + formatNumber(ctx.raw) + ' tokens' } }
            }
          }
        });

        // Cumulative ROI chart (real token-level pricing from pricing.json)
        let cumApi = 0, cumSub = 0;
        const roiData = dmt.map(d => {
          const tok = d.tokensByModel || {};
          const dtl = d.tokenDetail || {};
          // Use per-model token detail if available, otherwise estimate from total tokens
          if (dtl.opus_in !== undefined) {
            cumApi += (dtl.opus_in || 0) * opusIn + (dtl.opus_out || 0) * opusOut + (dtl.opus_cache || 0) * opusCache
                    + (dtl.sonnet_in || 0) * sonIn + (dtl.sonnet_out || 0) * sonOut + (dtl.sonnet_cache || 0) * sonCache
                    + (dtl.haiku_in || 0) * haiIn + (dtl.haiku_out || 0) * haiOut + (dtl.haiku_cache || 0) * haiCache;
          } else {
            // Fallback: estimate from blended totals (mostly cache reads)
            cumApi += (tok.opus || 0) * opusCache + (tok.sonnet || 0) * sonCache + (tok.haiku || 0) * haiCache;
          }
          cumSub += dailySubRate;
          return { api: +cumApi.toFixed(0), sub: +cumSub.toFixed(0) };
        });
        document.getElementById('roiBadge').textContent = roiMultiplierVal.toFixed(1) + 'x';

        new Chart(document.getElementById('roiChart'), {
          type: 'line',
          data: {
            labels: costLabels,
            datasets: [
              {
                label: 'API Value',
                data: roiData.map(r => r.api),
                borderColor: 'rgba(233,69,96,1)',
                backgroundColor: 'rgba(233,69,96,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Subscription Cost',
                data: roiData.map(r => r.sub),
                borderColor: 'rgba(0,230,118,1)',
                backgroundColor: 'rgba(0,230,118,0.1)',
                fill: true,
                tension: 0,
                pointRadius: 0,
                borderDash: [5, 5]
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
            scales: {
              y: { ticks: { color: '#666', callback: v => '$' + formatNumber(v) }, grid: { color: 'rgba(255,255,255,0.05)' } },
              x: { ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } }
            }
          }
        });
      }

      // Projects tab
      // --- Projects Tab: Stats + Charts + Enhanced Cards ---
      {
        const projs = PROJECTS_DATA || [];
        const totalProjects = projs.length;
        const totalCommits = projs.reduce((s, p) => s + (parseInt(p.commits) || 0), 0);
        const totalFiles = projs.reduce((s, p) => s + (parseInt(p.files) || 0), 0);
        const totalLines = projs.reduce((s, p) => s + (p.linesRaw || 0), 0);
        const activeRecent = projs.filter(p => (p.recentCommits || 0) > 0).length;
        const totalRecent = projs.reduce((s, p) => s + (p.recentCommits || 0), 0);

        // Stat cards
        document.getElementById('projectsStatsRow').innerHTML = [
          { icon: 'üìÇ', value: totalProjects, label: 'Repositories' },
          { icon: 'üìù', value: totalCommits.toLocaleString(), label: 'Total Commits' },
          { icon: 'üìÑ', value: totalFiles.toLocaleString(), label: 'Code Files' },
          { icon: 'üìè', value: totalLines > 1000 ? (totalLines/1000).toFixed(1) + 'K' : totalLines, label: 'Lines of Code' },
          { icon: 'üî•', value: activeRecent, label: 'Active (7d)' },
          { icon: '‚ö°', value: totalRecent, label: 'Recent Commits' },
        ].map(s => `
          <div class="stat-card">
            <div class="stat-value">${s.value}</div>
            <div class="stat-label">${s.label}</div>
          </div>
        `).join('');

        // Color palette for projects
        const projColors = ['rgba(233,69,96,0.8)', 'rgba(72,219,251,0.8)', 'rgba(177,78,255,0.8)', 'rgba(255,204,0,0.8)', 'rgba(0,255,136,0.8)', 'rgba(255,152,0,0.8)', 'rgba(100,181,246,0.8)', 'rgba(174,213,129,0.8)', 'rgba(255,112,67,0.8)', 'rgba(77,208,225,0.8)', 'rgba(156,39,176,0.8)', 'rgba(139,195,74,0.8)', 'rgba(255,183,77,0.8)', 'rgba(100,200,200,0.8)', 'rgba(239,83,80,0.8)', 'rgba(129,212,250,0.8)', 'rgba(186,104,200,0.8)', 'rgba(255,241,118,0.8)', 'rgba(165,214,167,0.8)', 'rgba(255,138,101,0.8)', 'rgba(128,203,196,0.8)'];

        // Chart 1: Lines of Code by Project (horizontal bar, top 10)
        const byLines = [...projs].filter(p => p.linesRaw > 0).sort((a, b) => b.linesRaw - a.linesRaw).slice(0, 10);
        if (byLines.length > 0) {
          new Chart(document.getElementById('projLinesChart'), {
            type: 'bar',
            data: {
              labels: byLines.map(p => p.name),
              datasets: [{
                data: byLines.map(p => p.linesRaw),
                backgroundColor: byLines.map((_, i) => projColors[i % projColors.length]),
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.raw.toLocaleString() + ' lines' } } },
              scales: {
                x: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)', callback: v => v >= 1000 ? (v/1000).toFixed(0)+'K' : v }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }, grid: { display: false } }
              }
            }
          });
          document.getElementById('projLinesBadge').textContent = byLines.length + ' projects';
        }

        // Chart 2: File Type Distribution (doughnut, aggregated)
        const allFileTypes = {};
        projs.forEach(p => {
          Object.entries(p.fileTypes || {}).forEach(([ext, cnt]) => {
            allFileTypes[ext] = (allFileTypes[ext] || 0) + cnt;
          });
        });
        const ftSorted = Object.entries(allFileTypes).sort((a, b) => b[1] - a[1]);
        if (ftSorted.length > 0) {
          const ftColors = ['rgba(72,219,251,0.8)', 'rgba(233,69,96,0.8)', 'rgba(177,78,255,0.8)', 'rgba(255,204,0,0.8)', 'rgba(0,255,136,0.8)', 'rgba(255,152,0,0.8)', 'rgba(100,181,246,0.8)', 'rgba(174,213,129,0.8)', 'rgba(255,112,67,0.8)', 'rgba(77,208,225,0.8)'];
          new Chart(document.getElementById('projFilesChart'), {
            type: 'doughnut',
            data: {
              labels: ftSorted.map(([ext]) => '.' + ext),
              datasets: [{
                data: ftSorted.map(([, c]) => c),
                backgroundColor: ftSorted.map((_, i) => ftColors[i % ftColors.length]),
                borderWidth: 0
              }]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 10, font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => ` .${ftSorted[ctx.dataIndex][0]}: ${ctx.raw} files` } }
              }
            }
          });
          document.getElementById('projFilesBadge').textContent = totalFiles + ' files';
        }

        // Chart 3: Recent Activity (horizontal bar, projects with commits in 7d)
        const recentActive = projs.filter(p => (p.recentCommits || 0) > 0).sort((a, b) => b.recentCommits - a.recentCommits);
        if (recentActive.length > 0) {
          new Chart(document.getElementById('projActivityChart'), {
            type: 'bar',
            data: {
              labels: recentActive.map(p => p.name),
              datasets: [{
                data: recentActive.map(p => p.recentCommits),
                backgroundColor: 'rgba(0,255,136,0.7)',
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }, grid: { display: false } }
              }
            }
          });
        }

        // Chart 4: Total Commits by Project (horizontal bar, top 10)
        const byCommits = [...projs].sort((a, b) => (parseInt(b.commits)||0) - (parseInt(a.commits)||0)).slice(0, 10);
        if (byCommits.length > 0) {
          new Chart(document.getElementById('projCommitsChart'), {
            type: 'bar',
            data: {
              labels: byCommits.map(p => p.name),
              datasets: [{
                data: byCommits.map(p => parseInt(p.commits) || 0),
                backgroundColor: 'rgba(177,78,255,0.7)',
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } }, grid: { display: false } }
              }
            }
          });
          document.getElementById('projCommitsBadge').textContent = totalCommits.toLocaleString() + ' total';
        }

        // Enhanced project cards
        document.getElementById('projectsList').innerHTML = projs.map((p, i) => {
          const recentBadge = (p.recentCommits || 0) > 0
            ? `<span style="background:rgba(0,255,136,0.15);color:#00ff88;padding:2px 6px;border-radius:4px;font-size:0.65rem;">${p.recentCommits} commits (7d)</span>`
            : '';
          const branchBadge = p.branch
            ? `<span style="background:rgba(177,78,255,0.15);color:#b14eff;padding:2px 6px;border-radius:4px;font-size:0.65rem;">${p.branch}</span>`
            : '';
          return `
          <div class="project-card ${p.class || ''}" style="border-left:3px solid ${projColors[i % projColors.length]};">
            <div class="project-header">
              <div class="project-name">${p.name}</div>
              <div class="project-status ${p.status}">${p.status}</div>
            </div>
            <div class="project-stack">${p.stack}</div>
            <div style="display:flex;gap:4px;margin:0.4rem 0;flex-wrap:wrap;">
              ${branchBadge}${recentBadge}
              ${p.lastCommit ? `<span style="color:var(--text-muted);font-size:0.65rem;">Last: ${p.lastCommit}</span>` : ''}
            </div>
            <div class="project-stats">
              <div class="project-stat">
                <div class="value">${p.files || '‚Äî'}</div>
                <div class="label">Files</div>
              </div>
              <div class="project-stat">
                <div class="value">${p.commits || '‚Äî'}</div>
                <div class="label">Commits</div>
              </div>
              <div class="project-stat">
                <div class="value">${p.lines || '‚Äî'}</div>
                <div class="label">Lines</div>
              </div>
            </div>
          </div>`;
        }).join('');
      }

      // --- Commands Tab: Stats + Search ---
      {
        const cmdSections = document.querySelectorAll('#commands .commands-section');
        const cmdCards = document.querySelectorAll('#commands .command-card');
        const totalCmds = cmdCards.length;
        const totalSections = cmdSections.length;

        // Stat cards
        document.getElementById('commandsStatsRow').innerHTML = [
          { icon: '‚å®Ô∏è', value: totalCmds, label: 'Total Commands' },
          { icon: 'üìë', value: totalSections, label: 'Categories' },
          { icon: 'ü§ñ', value: '3', label: 'Model Aliases' },
          { icon: 'üîç', value: 'Active', label: 'Search' },
        ].map(s => `
          <div class="stat-card">
            <div class="stat-value">${s.value}</div>
            <div class="stat-label">${s.label}</div>
          </div>
        `).join('');

        // Search filter
        document.getElementById('commandSearch').addEventListener('input', (e) => {
          const q = e.target.value.toLowerCase();
          cmdCards.forEach(card => {
            const text = card.textContent.toLowerCase();
            card.style.display = (!q || text.includes(q)) ? '' : 'none';
          });
          // Hide empty sections
          cmdSections.forEach(sec => {
            const visibleCards = sec.querySelectorAll('.command-card:not([style*="display: none"])');
            sec.style.display = (!q || visibleCards.length > 0) ? '' : 'none';
          });
        });
      }

      // Co-Evolution tab
      if (COEVO_DATA) {
        const patternColors = {
          implementation: 'rgba(168,85,247,0.8)', research: 'rgba(72,219,251,0.8)',
          architecture: 'rgba(254,202,87,0.8)', testing: 'rgba(100,200,200,0.8)',
          review: 'rgba(74,222,128,0.8)', documentation: 'rgba(255,107,107,0.8)',
          debugging: 'rgba(233,69,96,0.8)', optimization: 'rgba(150,100,200,0.8)',
          deployment: 'rgba(100,150,200,0.8)', learning: 'rgba(200,150,100,0.8)',
          coding: 'rgba(168,85,247,0.8)'
        };

        // --- 6 Stat Cards ---
        document.getElementById('coevoCacheEfficiency').textContent = (COEVO_DATA.cacheEfficiency || 0).toFixed(1) + '%';
        document.getElementById('coevoDqScore').textContent = (COEVO_DATA.dqScore || 0).toFixed(3);
        document.getElementById('coevoDominantPattern').textContent = COEVO_DATA.dominantPattern || 'none';
        document.getElementById('coevoModsApplied').textContent = COEVO_DATA.modsApplied || 0;

        const topPatterns = (PATTERN_TRENDS_DATA && PATTERN_TRENDS_DATA.top_patterns) || [];
        const definitions = (PATTERN_TRENDS_DATA && PATTERN_TRENDS_DATA.pattern_definitions) || {};
        const totalSess = (PATTERN_TRENDS_DATA && PATTERN_TRENDS_DATA.total_sessions) || 0;
        document.getElementById('coevoTotalSessions').textContent = totalSess.toLocaleString();
        document.getElementById('coevoTopPct').textContent = topPatterns.length > 0 ? topPatterns[0].percentage + '%' : '‚Äî';

        // --- Meta-Vengine Status ---
        document.getElementById('coevoAutoApply').textContent = COEVO_DATA.autoApply ? 'Enabled' : 'Disabled';
        document.getElementById('coevoAutoApply').style.color = COEVO_DATA.autoApply ? 'var(--accent-green)' : 'var(--accent-yellow)';
        document.getElementById('coevoMinConfidence').textContent = (COEVO_DATA.minConfidence || 0.7).toFixed(2);
        const lastA = COEVO_DATA.lastAnalysis || 'Never';
        document.getElementById('coevoLastAnalysis').textContent = lastA !== 'Never' ? new Date(lastA).toLocaleString('en-US', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Never';

        // Evolution Weights visualization
        const weights = COEVO_DATA.configWeights || {};
        const weightsEl = document.getElementById('coevoWeights');
        if (Object.keys(weights).length > 0) {
          weightsEl.innerHTML = Object.entries(weights).sort((a,b) => b[1] - a[1]).map(([k, v]) => {
            const pct = Math.round(v * 100);
            return `<div style="display:flex;align-items:center;gap:0.5rem;">
              <span style="width:110px;font-size:0.75rem;color:var(--text-secondary);">${k.replace(/([A-Z])/g, ' $1').trim()}</span>
              <div style="flex:1;background:var(--bg-glass);border-radius:3px;height:12px;overflow:hidden;">
                <div style="background:var(--gradient-primary);width:${pct}%;height:100%;border-radius:3px;"></div>
              </div>
              <span style="font-size:0.7rem;color:var(--accent-cyan);width:30px;text-align:right;">${pct}%</span>
            </div>`;
          }).join('');
        }

        // --- Chart 1: Pattern Distribution (doughnut from pattern-trends top_patterns) ---
        let patterns = topPatterns.length > 0 ? topPatterns : [];
        // Fallback to COEVO_DATA.runtimePatterns if no trends data
        if (patterns.length === 0 && COEVO_DATA.runtimePatterns) {
          patterns = Object.entries(COEVO_DATA.runtimePatterns).map(([k, v]) => ({
            id: k, pattern: k, count: v, percentage: 0
          }));
        }

        const patCtx = document.getElementById('patternChart')?.getContext('2d');
        if (patCtx && patterns.length > 0) {
          document.getElementById('patternCount').textContent = patterns.length;
          const topN = patterns.slice(0, 8);
          const totalCount = topN.reduce((s, p) => s + (p.count || 0), 0);
          new Chart(patCtx, {
            type: 'doughnut',
            data: {
              labels: topN.map(p => p.pattern || p.id || 'Unknown'),
              datasets: [{
                data: topN.map(p => p.count || 1),
                backgroundColor: topN.map(p => patternColors[p.pattern || p.id] || 'rgba(128,128,128,0.8)'),
                borderWidth: 0
              }]
            },
            options: {
              responsive: true, maintainAspectRatio: false, cutout: '50%',
              plugins: {
                legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 6, font: { size: 10 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw} sessions (${totalCount > 0 ? Math.round(ctx.raw/totalCount*100) : 0}%)` } }
              }
            }
          });
        }

        // --- Patterns List ---
        const patternsListEl = document.getElementById('patternsList');
        if (patterns.length > 0) {
          patternsListEl.innerHTML = patterns.map(p => {
            const name = p.pattern || p.id || 'Unknown';
            const def = definitions[name] || {};
            const color = patternColors[name] || 'rgba(128,128,128,0.8)';
            const count = p.count || 0;
            const pct = p.percentage || 0;
            return `
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem;border-bottom:1px solid var(--border);">
                <span style="font-size:1.2rem;">${def.icon || 'üìä'}</span>
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--text-primary);font-size:0.85rem;">${def.name || name}</div>
                  <div style="font-size:0.7rem;color:var(--text-secondary);">${count} sessions</div>
                </div>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                  <div style="width:60px;background:var(--bg-glass);border-radius:3px;height:8px;overflow:hidden;">
                    <div style="background:${color};width:${pct}%;height:100%;border-radius:3px;"></div>
                  </div>
                  <span style="font-size:0.8rem;font-weight:600;color:${color};width:40px;text-align:right;">${pct}%</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          patternsListEl.innerHTML = '<p style="color:var(--text-muted);padding:1rem;text-align:center;">No patterns detected. Run meta-analyzer analyze.</p>';
        }
      }

      // Pattern Trends (from backfill)
      if (PATTERN_TRENDS_DATA) {
        const weekly = PATTERN_TRENDS_DATA.weekly || {};
        const weeks = Object.keys(weekly).sort().slice(-8);
        const topPatterns = PATTERN_TRENDS_DATA.top_patterns || [];
        const definitions = PATTERN_TRENDS_DATA.pattern_definitions || {};
        const dailyList = PATTERN_TRENDS_DATA.dailyList || [];

        document.getElementById('patternTrendsWeeks').textContent = weeks.length + ' weeks';
        document.getElementById('patternTotalSessions').textContent = (PATTERN_TRENDS_DATA.total_sessions || 0).toLocaleString() + ' sessions';

        const patternIds = ['implementation', 'research', 'architecture', 'testing', 'review', 'debugging', 'documentation', 'optimization', 'deployment'];
        const patternColors = {
          implementation: 'rgba(168,85,247,0.8)', research: 'rgba(72,219,251,0.8)',
          architecture: 'rgba(254,202,87,0.8)', testing: 'rgba(100,200,200,0.8)',
          review: 'rgba(74,222,128,0.8)', debugging: 'rgba(233,69,96,0.8)',
          documentation: 'rgba(255,107,107,0.8)', optimization: 'rgba(150,100,200,0.8)',
          deployment: 'rgba(100,150,200,0.8)'
        };

        // --- Chart 2: Weekly Pattern Trends (stacked bar) ---
        if (weeks.length > 0) {
          const datasets = patternIds.filter(pid => {
            return weeks.some(w => (weekly[w] || {})[pid] > 0);
          }).map(pid => ({
            label: (definitions[pid] && definitions[pid].name) || pid,
            data: weeks.map(w => (weekly[w] || {})[pid] || 0),
            backgroundColor: patternColors[pid] || 'rgba(128,128,128,0.8)'
          }));

          const wCtx = document.getElementById('patternTrendsChart')?.getContext('2d');
          if (wCtx) {
            new Chart(wCtx, {
              type: 'bar',
              data: { labels: weeks.map(w => w.substring(5)), datasets },
              options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                  x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { display: false } },
                  y: { stacked: true, beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 6, font: { size: 10 } } } }
              }
            });
          }
        }

        // --- Chart 3: Daily Pattern Activity (stacked bar, last 21 days) ---
        if (dailyList.length > 0) {
          document.getElementById('patternDailyBadge').textContent = dailyList.length + ' Days';
          const dLabels = dailyList.map(d => { const p = d.date.split('-'); return p[1] + '/' + p[2]; });
          // Find all patterns present in daily data
          const allDailyPatterns = new Set();
          dailyList.forEach(d => { Object.keys(d).filter(k => k !== 'date').forEach(k => allDailyPatterns.add(k)); });
          const dailyPatternIds = patternIds.filter(p => allDailyPatterns.has(p));

          const dDatasets = dailyPatternIds.map(pid => ({
            label: (definitions[pid] && definitions[pid].name) || pid,
            data: dailyList.map(d => d[pid] || 0),
            backgroundColor: patternColors[pid] || 'rgba(128,128,128,0.8)'
          }));

          const dCtx = document.getElementById('patternDailyChart')?.getContext('2d');
          if (dCtx) {
            new Chart(dCtx, {
              type: 'bar',
              data: { labels: dLabels, datasets: dDatasets },
              options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                  x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 9 } }, grid: { display: false } },
                  y: { stacked: true, beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 6, font: { size: 9 } } } }
              }
            });
          }
        }

        // --- All-time stats grid ---
        if (topPatterns.length > 0) {
          document.getElementById('patternStatsGrid').innerHTML = topPatterns.slice(0, 8).map(p => {
            const def = definitions[p.id || p.pattern] || {};
            const color = ({
              implementation: 'var(--accent-purple)', research: 'var(--accent-cyan)',
              architecture: 'var(--accent-yellow)', testing: 'var(--accent-cyan)',
              review: 'var(--accent-green)', debugging: 'var(--accent-red)',
              documentation: 'var(--accent-orange)', optimization: 'var(--accent-purple)'
            })[p.id || p.pattern] || 'var(--text-primary)';
            return `
              <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:8px;padding:0.75rem;text-align:center;">
                <div style="font-size:1.3rem;">${def.icon || 'üìä'}</div>
                <div style="font-weight:700;color:${color};font-size:1.1rem;">${p.count}</div>
                <div style="font-size:0.75rem;color:var(--text-secondary);">${def.name || p.id || p.pattern}</div>
                <div style="font-size:0.7rem;color:var(--text-muted);">${p.percentage}%</div>
              </div>
            `;
          }).join('');
        }
      }

      // Routing tab
      if (ROUTING_DATA) {
        const rModelColors = { haiku: '#ffcc00', sonnet: '#48dbfb', opus: '#b14eff', flash: '#ff6b6b', local: '#888', 'local-fast': '#aaa' };

        // Stats row
        document.getElementById('routingQueries').textContent = (ROUTING_DATA.totalQueries || 0).toLocaleString();
        document.getElementById('routingDqScore').textContent = (ROUTING_DATA.avgDqScore || 0).toFixed(3);
        document.getElementById('routingCostSavings').textContent = (ROUTING_DATA.costReduction || 0).toFixed(1) + '%';
        document.getElementById('routingAccuracy').textContent = (ROUTING_DATA.accuracy || 0).toFixed(1) + '%';
        const expDomains = ROUTING_DATA.expertiseDomains || [];
        document.getElementById('routingDomains').textContent = expDomains.length;
        const modelCounts = ROUTING_DATA.modelCounts || {};
        document.getElementById('routingModels').textContent = Object.keys(modelCounts).length;

        // DQ Components
        const dqComp = ROUTING_DATA.dqComponents || {};
        document.getElementById('dqValidity').textContent = (dqComp.validity || 0).toFixed(3);
        document.getElementById('dqSpecificity').textContent = (dqComp.specificity || 0).toFixed(3);
        document.getElementById('dqCorrectness').textContent = (dqComp.correctness || 0).toFixed(3);
        const compositeDq = (ROUTING_DATA.avgDqScore || 0);
        document.getElementById('dqComposite').textContent = compositeDq.toFixed(3) + ' / 1.000';
        document.getElementById('dqCompositeBar').style.width = (compositeDq * 100) + '%';
        document.getElementById('dqComponentsBadge').textContent = 'V:40% S:30% C:30%';

        // Performance targets
        const accuracy = ROUTING_DATA.accuracy || 0;
        const costReduction = ROUTING_DATA.costReduction || 0;
        const latency = ROUTING_DATA.routingLatency || 0;
        const dqScore = ROUTING_DATA.avgDqScore || 0;
        const targetAccuracy = ROUTING_DATA.targetAccuracy || 60;
        const targetDq = ROUTING_DATA.targetDataQuality || 0.60;

        document.getElementById('accuracyTarget').textContent = accuracy.toFixed(1) + '% (target: ' + targetAccuracy + '%)';
        document.getElementById('accuracyStatus').textContent = accuracy >= targetAccuracy ? '‚úÖ' : '‚è≥';
        document.getElementById('costTarget').textContent = costReduction.toFixed(1) + '% (target: 20%)';
        document.getElementById('costStatus').textContent = costReduction >= 20 ? '‚úÖ' : '‚è≥';
        if (latency > 0) {
          document.getElementById('latencyTarget').textContent = latency.toFixed(0) + 'ms (target: <50ms)';
          document.getElementById('latencyStatus').textContent = latency < 50 ? '‚úÖ' : '‚è≥';
        } else {
          document.getElementById('latencyTarget').textContent = 'N/A (target: <50ms)';
          document.getElementById('latencyStatus').textContent = '‚è≥';
        }
        document.getElementById('dqTarget').textContent = dqScore.toFixed(3) + ' (target: ' + targetDq.toFixed(2) + ')';
        document.getElementById('dqStatus').textContent = dqScore >= targetDq ? '‚úÖ' : '‚è≥';

        const targetsMet = [
          accuracy >= targetAccuracy, costReduction >= 20,
          latency > 0 && latency < 50, dqScore >= targetDq
        ].filter(Boolean).length;
        document.getElementById('targetsMetBadge').textContent = `${targetsMet}/4`;

        // --- Chart 1: Daily DQ Score & Complexity (dual Y-axis) ---
        const dailyTrend = ROUTING_DATA.dailyTrend || [];
        if (dailyTrend.length > 0) {
          const dqCtx = document.getElementById('routingDqTrendChart')?.getContext('2d');
          if (dqCtx) {
            new Chart(dqCtx, {
              type: 'line',
              data: {
                labels: dailyTrend.map(d => d.date.substring(5)),
                datasets: [
                  {
                    label: 'DQ Score',
                    data: dailyTrend.map(d => d.avgDq),
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0,255,136,0.1)',
                    fill: true, tension: 0.4, yAxisID: 'y',
                    pointRadius: 4, pointBackgroundColor: '#00ff88'
                  },
                  {
                    label: 'Complexity',
                    data: dailyTrend.map(d => d.avgComplexity),
                    borderColor: '#b14eff',
                    backgroundColor: 'rgba(177,78,255,0.1)',
                    fill: true, tension: 0.4, yAxisID: 'y',
                    pointRadius: 4, pointBackgroundColor: '#b14eff',
                    borderDash: [5, 5]
                  }
                ]
              },
              options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                  y: { min: 0, max: 1, ticks: { color: 'rgba(255,255,255,0.6)', callback: v => v.toFixed(1) }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  x: { ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 10 } }, grid: { display: false } }
                },
                plugins: {
                  legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } },
                  annotation: { annotations: {
                    targetLine: { type: 'line', yMin: targetDq, yMax: targetDq, borderColor: 'rgba(255,204,0,0.5)', borderWidth: 1, borderDash: [4,4],
                      label: { display: true, content: 'Target ' + targetDq.toFixed(2), position: 'end', color: '#ffcc00', font: { size: 9 } }
                    }
                  }}
                }
              }
            });
          }
          document.getElementById('routingDqTrendBadge').textContent = dailyTrend.length + ' days';
        }

        // --- Chart 2: Daily Queries by Model (stacked bar) ---
        if (dailyTrend.length > 0) {
          const mCtx = document.getElementById('routingModelTrendChart')?.getContext('2d');
          if (mCtx) {
            new Chart(mCtx, {
              type: 'bar',
              data: {
                labels: dailyTrend.map(d => d.date.substring(5)),
                datasets: [
                  { label: 'Haiku', data: dailyTrend.map(d => d.haiku || 0), backgroundColor: 'rgba(255,204,0,0.8)' },
                  { label: 'Sonnet', data: dailyTrend.map(d => d.sonnet || 0), backgroundColor: 'rgba(72,219,251,0.8)' },
                  { label: 'Opus', data: dailyTrend.map(d => d.opus || 0), backgroundColor: 'rgba(177,78,255,0.8)' }
                ]
              },
              options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                  x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 10 } }, grid: { display: false } },
                  y: { stacked: true, beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.6)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } } }
              }
            });
          }
          document.getElementById('routingModelTrendBadge').textContent = dailyTrend.reduce((s, d) => s + d.queries, 0).toLocaleString() + ' total';
        }

        // --- Chart 3: Model Complexity Ranges (horizontal bar) ---
        const complexityData = ROUTING_DATA.complexityByModel || [];
        if (complexityData.length > 0) {
          const cCtx = document.getElementById('routingComplexityChart')?.getContext('2d');
          if (cCtx) {
            const cLabels = complexityData.map(c => c.model.charAt(0).toUpperCase() + c.model.slice(1));
            new Chart(cCtx, {
              type: 'bar',
              data: {
                labels: cLabels,
                datasets: [
                  { label: 'Min', data: complexityData.map(c => c.min), backgroundColor: 'rgba(0,255,136,0.4)', borderColor: '#00ff88', borderWidth: 1 },
                  { label: 'Average', data: complexityData.map(c => c.avg), backgroundColor: 'rgba(72,219,251,0.6)', borderColor: '#48dbfb', borderWidth: 1 },
                  { label: 'Max', data: complexityData.map(c => c.max), backgroundColor: 'rgba(177,78,255,0.4)', borderColor: '#b14eff', borderWidth: 1 }
                ]
              },
              options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                scales: {
                  x: { min: 0, max: 1, ticks: { color: 'rgba(255,255,255,0.6)', callback: v => v.toFixed(1) }, grid: { color: 'rgba(255,255,255,0.05)' },
                    title: { display: true, text: 'Complexity', color: 'rgba(255,255,255,0.5)', font: { size: 10 } } },
                  y: { ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { display: false } }
                },
                plugins: {
                  legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } },
                  tooltip: { callbacks: { afterLabel: (ctx) => {
                    const item = complexityData[ctx.dataIndex];
                    return item ? `${item.count} queries` : '';
                  }}}
                }
              }
            });
          }
        }

        // --- Chart 4: Expertise Domain Routing (horizontal bar with expertise + complexity) ---
        if (expDomains.length > 0) {
          const eCtx = document.getElementById('routingExpertiseChart')?.getContext('2d');
          if (eCtx) {
            new Chart(eCtx, {
              type: 'bar',
              data: {
                labels: expDomains.map(d => d.domain.charAt(0).toUpperCase() + d.domain.slice(1)),
                datasets: [
                  { label: 'Expertise Level', data: expDomains.map(d => d.avgExpertise), backgroundColor: 'rgba(0,255,136,0.7)', borderWidth: 0 },
                  { label: 'Avg Complexity', data: expDomains.map(d => d.avgComplexity), backgroundColor: 'rgba(177,78,255,0.7)', borderWidth: 0 }
                ]
              },
              options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                scales: {
                  x: { min: 0, max: 1, ticks: { color: 'rgba(255,255,255,0.6)', callback: v => v.toFixed(1) }, grid: { color: 'rgba(255,255,255,0.05)' } },
                  y: { ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { display: false } }
                },
                plugins: {
                  legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } },
                  tooltip: { callbacks: { afterLabel: (ctx) => {
                    const dom = expDomains[ctx.dataIndex];
                    return dom ? `${dom.count} queries | Model: ${dom.primaryModel}` : '';
                  }}}
                }
              }
            });
          }
          document.getElementById('expertiseBadge').textContent = expDomains.length + ' domains';
        }

        // --- Model Distribution Doughnut (by absolute count) ---
        if (Object.keys(modelCounts).length > 0) {
          const mainModels = ['haiku', 'sonnet', 'opus'];
          const otherCount = Object.entries(modelCounts).filter(([k]) => !mainModels.includes(k)).reduce((s, [,v]) => s + v, 0);
          const distLabels = mainModels.filter(m => modelCounts[m]).map(m => m.charAt(0).toUpperCase() + m.slice(1));
          const distValues = mainModels.filter(m => modelCounts[m]).map(m => modelCounts[m]);
          const distColors = mainModels.filter(m => modelCounts[m]).map(m => rModelColors[m]);
          if (otherCount > 0) { distLabels.push('Other'); distValues.push(otherCount); distColors.push('rgba(136,136,136,0.8)'); }

          new Chart(document.getElementById('modelDistChart'), {
            type: 'doughnut',
            data: {
              labels: distLabels,
              datasets: [{ data: distValues, backgroundColor: distColors, borderWidth: 0 }]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12 } },
                tooltip: { callbacks: { label: (ctx) => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  return ` ${ctx.label}: ${ctx.raw} (${(ctx.raw / total * 100).toFixed(1)}%)`;
                }}}
              }
            }
          });
        }

        // --- Model Success Rates ---
        const successRates = ROUTING_DATA.modelSuccessRates || {};
        const successGrid = document.getElementById('modelSuccessGrid');
        if (Object.keys(successRates).length > 0) {
          successGrid.innerHTML = Object.entries(successRates).map(([model, data]) => `
            <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:8px;padding:1rem;text-align:center;">
              <div style="font-size:1.5rem;font-weight:700;color:${rModelColors[model] || '#888'}">${data.success_rate}%</div>
              <div style="font-size:0.85rem;color:var(--text-secondary);text-transform:capitalize;">${model}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);">${data.total} sessions</div>
            </div>
          `).join('');
        } else {
          successGrid.innerHTML = '<p class="empty-state" style="grid-column:span 3;">No session outcomes yet</p>';
        }

        // --- Expertise Domain Detail Grid ---
        if (expDomains.length > 0) {
          document.getElementById('expertiseCountBadge').textContent = expDomains.reduce((s, d) => s + d.count, 0) + ' events';
          document.getElementById('expertiseDetailGrid').innerHTML = expDomains.map(d => {
            const mColor = rModelColors[d.primaryModel] || '#888';
            const expPct = ((d.avgExpertise || 0) * 100).toFixed(0);
            return `
              <div style="background:var(--bg-glass);border:1px solid var(--border);border-radius:10px;padding:1rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                  <span style="font-weight:700;color:var(--text-primary);text-transform:capitalize;">${d.domain}</span>
                  <span style="background:${mColor}22;color:${mColor};padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;text-transform:capitalize;">${d.primaryModel}</span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.8rem;">
                  <div><span style="color:var(--text-muted);">Queries:</span> <span style="color:var(--text-primary);font-weight:600;">${d.count}</span></div>
                  <div><span style="color:var(--text-muted);">Complexity:</span> <span style="color:#b14eff;font-weight:600;">${(d.avgComplexity || 0).toFixed(2)}</span></div>
                </div>
                <div style="margin-top:0.5rem;">
                  <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted);margin-bottom:2px;">
                    <span>Expertise</span><span style="color:#00ff88;">${expPct}%</span>
                  </div>
                  <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;overflow:hidden;">
                    <div style="height:100%;width:${expPct}%;background:linear-gradient(90deg,#00ff88,#48dbfb);border-radius:4px;"></div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Render 10x Power Dashboard
      renderPowerDashboard();

      // Render Observatory Tabs
      renderObservatoryTabs();
    }

    // 10x Power Dashboard Rendering
    function renderPowerDashboard() {
      // Cognitive State - read from actual COGNITIVE_DATA structure
      const cognitive = COGNITIVE_DATA || {};
      const currentState = cognitive.current_state || {};
      const mode = currentState.mode || cognitive.mode || 'unknown';
      const energyLevel = currentState.energy_level || 0.5;
      const recommendedTasks = currentState.recommended_tasks || [];
      const hour = new Date().getHours();

      // Use actual data if available, fallback to time-based calculation
      let displayMode = mode !== 'unknown' ? mode : null;
      let energy = energyLevel > 0.7 ? 'High' : energyLevel > 0.4 ? 'Medium' : 'Low';
      let bestFor = recommendedTasks.length > 0 ? recommendedTasks.slice(0, 2).join(', ') : 'General tasks';

      // Fallback to time-based if no cognitive data
      if (!displayMode) {
        if (hour >= 5 && hour < 9) {
          displayMode = 'morning';
          energy = 'High';
          bestFor = 'Planning, reviews';
        } else if (hour >= 9 && hour < 12) {
          displayMode = 'peak';
          energy = 'Maximum';
          bestFor = 'Complex coding';
        } else if (hour >= 12 && hour < 14) {
          displayMode = 'dip';
          energy = 'Low';
          bestFor = 'Reviews, docs';
        } else if (hour >= 14 && hour < 18) {
          displayMode = 'peak';
          energy = 'High';
          bestFor = 'Implementation';
        } else if (hour >= 18 && hour < 22) {
          displayMode = 'evening';
          energy = 'Medium';
          bestFor = 'Creative work';
        } else {
          displayMode = 'deep_night';
          energy = 'Variable';
          bestFor = 'Deep focus';
        }
      }

      const modeIndicator = document.getElementById('cogModeIndicator');
      const modeLabel = document.getElementById('cogModeLabel');
      const energyEl = document.getElementById('cogEnergy');
      const bestForEl = document.getElementById('cogBestFor');

      if (modeIndicator) {
        modeIndicator.className = 'mode-indicator ' + displayMode;
        modeIndicator.textContent = '‚óè';
      }
      if (modeLabel) modeLabel.textContent = displayMode.replace('_', ' ');
      if (energyEl) energyEl.textContent = energy;
      if (bestForEl) bestForEl.textContent = bestFor;

      // Session Status
      const session = SESSION_WINDOW_DATA || {};
      const position = session.window?.positionPercent || session.window?.position || 0;
      const budget = session.budget?.utilizationPercent || session.budget?.utilization || 0;

      const progressEl = document.getElementById('sessionProgress');
      const positionEl = document.getElementById('sessionPosition');
      const budgetEl = document.getElementById('sessionBudget');

      if (progressEl) progressEl.style.width = position + '%';
      if (positionEl) positionEl.textContent = position + '%';
      if (budgetEl) budgetEl.textContent = budget + '% used';

      // Supermemory Quick Stats (field names from ccc-generator.sh)
      const supermemory = SUPERMEMORY_DATA || {};
      const dueReviews = supermemory.review?.due_count || supermemory.dueReviews || 0;
      const totalMemories = supermemory.totals?.memory_items || supermemory.totalMemories || 0;

      const dueEl = document.getElementById('memoryDue');
      const totalEl = document.getElementById('memoryTotal');

      if (dueEl) dueEl.textContent = dueReviews;
      if (totalEl) totalEl.textContent = totalMemories;

      // Autonomous Agents (check from sessions data)
      const sessions = SESSIONS_DATA || {};
      const activeSessions = sessions.sessions || [];
      const bgAgents = activeSessions.length;
      const ralphRunning = activeSessions.some(s => s.cwd?.includes('ralph') || s.model === 'ralph');

      const ralphIndicator = document.getElementById('ralphIndicator');
      const ralphStatus = document.getElementById('ralphStatus');
      const bgIndicator = document.getElementById('bgIndicator');
      const bgAgentsEl = document.getElementById('bgAgents');

      if (ralphIndicator) {
        ralphIndicator.className = 'agent-indicator ' + (ralphRunning ? 'running' : 'stopped');
        ralphIndicator.textContent = ralphRunning ? '‚óè' : '‚óã';
      }
      if (ralphStatus) ralphStatus.textContent = ralphRunning ? 'Running' : 'Not running';
      if (bgIndicator) {
        bgIndicator.className = 'agent-indicator ' + (bgAgents > 0 ? 'running' : 'stopped');
        bgIndicator.textContent = bgAgents > 0 ? '‚óè' : '‚óã';
      }
      if (bgAgentsEl) bgAgentsEl.textContent = bgAgents + ' active';

      // Recommendations
      const recEl = document.getElementById('recommendationText');
      if (recEl) {
        if (hour >= 9 && hour < 12) {
          recEl.textContent = 'Peak hours - tackle complex architecture';
        } else if (hour >= 20 || hour < 2) {
          recEl.textContent = 'Your peak: 20:00, 02:00 - deep work time';
        } else if (hour >= 12 && hour < 14) {
          recEl.textContent = 'Energy dip - good for reviews and documentation';
        } else {
          recEl.textContent = 'Consider batching small tasks';
        }
      }

      // Power mode buttons - show/hide extended panels
      document.querySelectorAll('.power-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.power-mode-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const mode = btn.dataset.mode;
          const extendedEl = document.getElementById('powerExtended');
          const boostEl = document.getElementById('powerBoost');

          if (mode === 'quick') {
            extendedEl.style.display = 'none';
            boostEl.style.display = 'none';
          } else if (mode === 'full') {
            extendedEl.style.display = 'block';
            boostEl.style.display = 'none';
          } else if (mode === 'boost') {
            extendedEl.style.display = 'block';
            boostEl.style.display = 'block';
          }
        });
      });

      // Populate Full mode panels (Error Prevention, Observatory)
      const recovery = RECOVERY_DATA || {};
      const autoFixRate = document.getElementById('autoFixRate');
      const recentFixes = document.getElementById('recentFixes');
      if (autoFixRate) autoFixRate.textContent = (recovery.stats?.autoFixRate || 0) + '%';
      if (recentFixes) recentFixes.textContent = (recovery.outcomes?.length || 0) + ' recent';

      const observatory = OBSERVATORY_DATA || {};
      const obsSessions = document.getElementById('obsSessions');
      const obsSuccess = document.getElementById('obsSuccess');
      if (obsSessions) obsSessions.textContent = observatory.metrics?.sessions?.total || '--';
      if (obsSuccess) obsSuccess.textContent = (observatory.metrics?.sessions?.success_rate || '--') + '%';

      // Populate Boost mode panels (Context Packs, Model Routing)
      const packs = PACK_DATA || {};
      const activePacks = document.getElementById('activePacks');
      const tokensSaved = document.getElementById('tokensSaved');
      if (activePacks) activePacks.textContent = packs.global?.total_sessions || 0;
      if (tokensSaved) tokensSaved.textContent = '$' + (packs.global?.value_generated || 0).toFixed(0);

      const routing = ROUTING_DATA || {};
      // cognitive already declared above
      const recommendedModel = document.getElementById('recommendedModel');
      const dqScore = document.getElementById('dqScore');
      if (recommendedModel) recommendedModel.textContent = (COGNITIVE_DATA?.routing?.recommended_model) || routing.recommendedModel || 'sonnet';
      if (dqScore) dqScore.textContent = (COEVO_DATA?.dqScore || routing.dataQuality || 0).toFixed(3);
    }

    // Observatory Tabs Rendering
    function renderObservatoryTabs() {
      if (!OBSERVATORY_DATA || !OBSERVATORY_DATA.metrics) {
        console.log('No Observatory data available');
        return;
      }

      const metrics = OBSERVATORY_DATA.metrics;

      // Session Outcomes Tab (Tab 10) - Observatory data supplements embedded data
      if (metrics.sessions) {
        const sessions = metrics.sessions;
        const successRateEl = document.getElementById('sessionSuccessRate');
        if (successRateEl) successRateEl.textContent = ((sessions.success_rate || 0) * 100).toFixed(1) + '%';

        const avgQualityEl = document.getElementById('sessionAvgQuality');
        if (avgQualityEl) avgQualityEl.textContent = (sessions.avg_quality || 0).toFixed(1);

        const totalCountEl = document.getElementById('sessionTotalCount');
        if (totalCountEl) totalCountEl.textContent = sessions.total_sessions || 0;

        const lastQualityEl = document.getElementById('sessionLastQuality');
        if (lastQualityEl) lastQualityEl.textContent = sessions.last_quality ? `‚≠ê ${sessions.last_quality}/5` : '‚Äî';
      }

      // Productivity Tab (Tab 11) ‚Äî powered by DAILY_ACTIVITY_DATA + TOOL_USAGE_DATA from SQLite
      (function renderProductivityTab() {
        const daily = (typeof DAILY_ACTIVITY_DATA !== 'undefined' && DAILY_ACTIVITY_DATA.daily) ? DAILY_ACTIVITY_DATA.daily : [];
        const allTime = (typeof DAILY_ACTIVITY_DATA !== 'undefined' && DAILY_ACTIVITY_DATA.allTime) ? DAILY_ACTIVITY_DATA.allTime : {};
        const toolData = (typeof TOOL_USAGE_DATA !== 'undefined') ? TOOL_USAGE_DATA : {};

        // Filter to days with activity for charts
        const activeDays = daily.filter(d => d.total > 0);

        // Compute all-time stats
        const totalTools = allTime.total || 0;
        const totalReads = allTime.reads || 0;
        const totalEdits = allTime.edits || 0;
        const totalWrites = allTime.writes || 0;
        const totalBash = allTime.bash || 0;
        const totalWriteOps = totalEdits + totalWrites;
        const totalFileOps = totalReads + totalEdits + totalWrites;
        const prodScore = totalFileOps > 0 ? (totalWriteOps / totalFileOps) : 0;
        const searchCount = (toolData.byTool?.Grep || 0) + (toolData.byTool?.Glob || 0);

        // Find peak day
        let peakDay = { date: '‚Äî', total: 0 };
        daily.forEach(d => { if (d.total > peakDay.total) peakDay = d; });

        // Stat cards
        const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
        el('prodTotalTools', formatNumber(totalTools));
        el('prodScore', (prodScore * 100).toFixed(1) + '%');
        el('prodWriteOps', formatNumber(totalWriteOps));
        el('prodReadOps', formatNumber(totalReads));
        el('prodPeakDay', peakDay.date !== '‚Äî' ? peakDay.date.slice(5) + ' (' + formatNumber(peakDay.total) + ')' : '‚Äî');
        el('prodActiveDays', activeDays.length);

        // Breakdown cards
        el('prodBashCount', formatNumber(totalBash));
        el('prodBashPct', totalTools > 0 ? ((totalBash / totalTools) * 100).toFixed(1) + '%' : '0%');
        el('prodEditWriteCount', formatNumber(totalWriteOps));
        el('prodEditWritePct', totalTools > 0 ? ((totalWriteOps / totalTools) * 100).toFixed(1) + '%' : '0%');
        el('prodSearchCount', formatNumber(searchCount));
        el('prodSearchPct', totalTools > 0 ? ((searchCount / totalTools) * 100).toFixed(1) + '%' : '0%');

        // Productivity Assessment
        const writeIntensity = totalTools > 0 ? ((totalWriteOps / totalTools) * 100).toFixed(1) : 0;
        let modeLabel, modeReco;
        if (prodScore > 0.4) {
          modeLabel = 'High Output';
          modeReco = 'Strong write ratio ‚Äî lots of creation and modification';
        } else if (prodScore > 0.25) {
          modeLabel = 'Balanced';
          modeReco = 'Good balance between reading and writing code';
        } else if (prodScore > 0.1) {
          modeLabel = 'Research Heavy';
          modeReco = 'Lots of reading ‚Äî typical during exploration and debugging';
        } else {
          modeLabel = 'Exploration';
          modeReco = 'Mostly reading ‚Äî common when learning a new codebase';
        }
        el('productivityMode', modeLabel);
        el('productivityReco', modeReco);
        el('productivityWriteIntensity', writeIntensity + '% of all tool calls are write operations');
        el('productivityBestDay', peakDay.date !== '‚Äî' ? peakDay.date + ' with ' + formatNumber(peakDay.total) + ' tool calls' : '‚Äî');

        // Shared chart options
        const prodChartOpts = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#999', font: { size: 11 } } } }
        };
        const gridOpts = { color: 'rgba(255,255,255,0.05)' };
        const tickOpts = { color: '#666' };

        // 1. Productivity Score Trend (real data: (edits+writes)/(reads+edits+writes) per day)
        const scoreData = daily.map(d => {
          const fileOps = (d.reads || 0) + (d.edits || 0) + (d.writes || 0);
          return fileOps > 0 ? ((d.edits || 0) + (d.writes || 0)) / fileOps : null;
        });
        // 7-day moving average
        const scoreMA = scoreData.map((v, i) => {
          const window = scoreData.slice(Math.max(0, i - 6), i + 1).filter(x => x !== null);
          return window.length > 0 ? window.reduce((a, b) => a + b, 0) / window.length : null;
        });

        new Chart(document.getElementById('productivityScoreChart'), {
          type: 'line',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Daily Score',
              data: scoreData,
              borderColor: 'rgba(0, 217, 255, 0.5)',
              backgroundColor: 'rgba(0, 217, 255, 0.05)',
              fill: true,
              tension: 0.3,
              pointRadius: 2,
              borderWidth: 1
            }, {
              label: '7-Day Average',
              data: scoreMA,
              borderColor: 'rgba(0, 217, 255, 1)',
              borderWidth: 2.5,
              tension: 0.4,
              pointRadius: 0,
              fill: false
            }]
          },
          options: {
            ...prodChartOpts,
            scales: {
              y: { min: 0, max: 1, ticks: { ...tickOpts, callback: v => (v * 100).toFixed(0) + '%' }, grid: gridOpts },
              x: { ticks: tickOpts, grid: { display: false } }
            },
            plugins: {
              ...prodChartOpts.plugins,
              tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + (ctx.raw * 100).toFixed(1) + '%' } }
            }
          }
        });

        // 2. Read vs Write Over Time (stacked bar: reads, edits, writes per day)
        new Chart(document.getElementById('readWriteChart'), {
          type: 'bar',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [
              { label: 'Read', data: daily.map(d => d.reads || 0), backgroundColor: 'rgba(233, 69, 96, 0.7)', borderRadius: 2 },
              { label: 'Edit', data: daily.map(d => d.edits || 0), backgroundColor: 'rgba(0, 230, 118, 0.7)', borderRadius: 2 },
              { label: 'Write', data: daily.map(d => d.writes || 0), backgroundColor: 'rgba(0, 217, 255, 0.7)', borderRadius: 2 }
            ]
          },
          options: {
            ...prodChartOpts,
            scales: {
              y: { stacked: true, ticks: tickOpts, grid: gridOpts },
              x: { stacked: true, ticks: tickOpts, grid: { display: false } }
            }
          }
        });

        // 3. Daily Tool Volume (bar with 7-day moving average line)
        const dailyTotals = daily.map(d => d.total || 0);
        const volumeMA = dailyTotals.map((v, i) => {
          const window = dailyTotals.slice(Math.max(0, i - 6), i + 1);
          return Math.round(window.reduce((a, b) => a + b, 0) / window.length);
        });

        new Chart(document.getElementById('velocityChart'), {
          type: 'bar',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Tool Calls',
              data: dailyTotals,
              backgroundColor: dailyTotals.map(v => v === peakDay.total ? 'rgba(255, 215, 0, 0.8)' : 'rgba(0, 230, 118, 0.5)'),
              borderRadius: 3,
              order: 2
            }, {
              label: '7-Day Avg',
              data: volumeMA,
              type: 'line',
              borderColor: 'rgba(0, 230, 118, 1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: false,
              order: 1
            }]
          },
          options: {
            ...prodChartOpts,
            scales: {
              y: { ticks: tickOpts, grid: gridOpts },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });

        // 4. Tool Category Mix (doughnut)
        const categories = [
          { label: 'Bash', value: totalBash, color: 'rgba(0, 217, 255, 0.8)' },
          { label: 'Read', value: totalReads, color: 'rgba(233, 69, 96, 0.8)' },
          { label: 'Edit', value: totalEdits, color: 'rgba(0, 230, 118, 0.8)' },
          { label: 'Write', value: totalWrites, color: 'rgba(255, 215, 0, 0.8)' },
          { label: 'Grep', value: toolData.byTool?.Grep || 0, color: 'rgba(156, 39, 176, 0.8)' },
          { label: 'Glob', value: toolData.byTool?.Glob || 0, color: 'rgba(255, 152, 0, 0.8)' },
          { label: 'Other', value: Math.max(0, totalTools - totalBash - totalReads - totalEdits - totalWrites - (toolData.byTool?.Grep || 0) - (toolData.byTool?.Glob || 0)), color: 'rgba(120, 120, 120, 0.6)' }
        ].filter(c => c.value > 0);

        new Chart(document.getElementById('toolMixChart'), {
          type: 'doughnut',
          data: {
            labels: categories.map(c => c.label),
            datasets: [{
              data: categories.map(c => c.value),
              backgroundColor: categories.map(c => c.color),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: '#999', font: { size: 11 }, padding: 12 } },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    const pct = ((ctx.raw / total) * 100).toFixed(1);
                    return ctx.label + ': ' + formatNumber(ctx.raw) + ' (' + pct + '%)';
                  }
                }
              }
            }
          }
        });

        // File Activity (from git ‚Äî kept as-is)
        const fileActivityList = document.getElementById('fileActivityList');
        if (typeof FILE_ACTIVITY_DATA !== 'undefined' && FILE_ACTIVITY_DATA.length > 0) {
          fileActivityList.innerHTML = FILE_ACTIVITY_DATA.map(f => {
            const color = {
              'OS-App': 'var(--accent-cyan)',
              'CareerCoach': 'var(--accent-purple)',
              'ResearchGravity': 'var(--accent-green)'
            }[f.project] || 'var(--text-secondary)';
            return `
              <div class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.file}</div>
                  <div style="font-size: 0.75rem; color: ${color};">${f.project}</div>
                </div>
                <div style="background: var(--bg-hover); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: var(--text-secondary);">${f.count}√ó</div>
              </div>
            `;
          }).join('');
        }
      })();

      // Tool Analytics Tab (Tab 12) ‚Äî powered by TOOL_USAGE_DATA + DAILY_ACTIVITY_DATA + GIT_ACTIVITY_DATA from SQLite
      (function renderToolAnalyticsTab() {
        const toolData = (typeof TOOL_USAGE_DATA !== 'undefined') ? TOOL_USAGE_DATA : {};
        const dailyAct = (typeof DAILY_ACTIVITY_DATA !== 'undefined' && DAILY_ACTIVITY_DATA.daily) ? DAILY_ACTIVITY_DATA.daily : [];
        const gitData = (typeof GIT_ACTIVITY_DATA !== 'undefined') ? GIT_ACTIVITY_DATA : {};
        const byTool = toolData.byTool || {};
        const successRates = toolData.successRates || {};
        const topTools = toolData.topTools || [];
        const dailyVolume = toolData.daily || [];
        const failurePatterns = toolData.failurePatterns || [];
        const totalCalls = toolData.total || 0;

        // Compute categories
        const coreTools = ['Bash', 'Read', 'Edit', 'Write'];
        const searchTools = ['Grep', 'Glob'];
        const coreCount = coreTools.reduce((s, t) => s + (byTool[t] || 0), 0);
        const searchCount = searchTools.reduce((s, t) => s + (byTool[t] || 0), 0);
        const advancedCount = Math.max(0, totalCalls - coreCount - searchCount);
        const uniqueTools = Object.keys(byTool).length;
        const activeDays = dailyVolume.filter(d => d.count > 0).length;
        const avgDaily = activeDays > 0 ? Math.round(totalCalls / activeDays) : 0;

        // Overall success rate
        const allRates = Object.values(successRates);
        const overallSuccess = allRates.length > 0 ? (allRates.reduce((a, b) => a + b, 0) / allRates.length) : 100;

        // Top tool
        const topTool = topTools.length > 0 ? topTools[0] : { tool: '‚Äî', count: 0 };

        const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
        el('taTotalCalls', formatNumber(totalCalls));
        el('taUniqueTools', uniqueTools);
        el('taSuccessRate', overallSuccess.toFixed(1) + '%');
        el('taTotalFailures', formatNumber(toolData.totalFailures || 0));
        el('taAvgDaily', formatNumber(avgDaily));
        el('taTopTool', topTool.tool + ' (' + formatNumber(topTool.count) + ')');

        // Category breakdown
        el('taCoreCount', formatNumber(coreCount));
        el('taCorePct', totalCalls > 0 ? ((coreCount / totalCalls) * 100).toFixed(1) + '%' : '0%');
        el('taSearchCount', formatNumber(searchCount));
        el('taSearchPct', totalCalls > 0 ? ((searchCount / totalCalls) * 100).toFixed(1) + '%' : '0%');
        el('taAdvancedCount', formatNumber(advancedCount));
        el('taAdvancedPct', totalCalls > 0 ? ((advancedCount / totalCalls) * 100).toFixed(1) + '%' : '0%');

        const chartOpts = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#999', font: { size: 11 } } } }
        };
        const gridOpts = { color: 'rgba(255,255,255,0.05)' };
        const tickOpts = { color: '#666' };

        // 1. Tool Usage Distribution (horizontal bar ‚Äî top 12)
        const toolColors = {
          'Bash': 'rgba(0, 217, 255, 0.8)',
          'Read': 'rgba(233, 69, 96, 0.8)',
          'Edit': 'rgba(0, 230, 118, 0.8)',
          'Write': 'rgba(255, 215, 0, 0.8)',
          'Grep': 'rgba(156, 39, 176, 0.8)',
          'Glob': 'rgba(255, 152, 0, 0.8)',
          'TodoWrite': 'rgba(100, 181, 246, 0.8)',
          'Task': 'rgba(255, 112, 67, 0.8)',
          'WebSearch': 'rgba(77, 208, 225, 0.8)',
          'WebFetch': 'rgba(174, 213, 129, 0.8)'
        };
        const top12 = topTools.slice(0, 12);
        new Chart(document.getElementById('commandUsageChart'), {
          type: 'bar',
          data: {
            labels: top12.map(t => t.tool),
            datasets: [{
              label: 'Calls',
              data: top12.map(t => t.count),
              backgroundColor: top12.map(t => toolColors[t.tool] || 'rgba(120, 120, 120, 0.6)'),
              borderRadius: 4
            }]
          },
          options: {
            ...chartOpts,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: tickOpts, grid: gridOpts },
              y: { ticks: { ...tickOpts, font: { size: 11, family: "'JetBrains Mono', monospace" } }, grid: { display: false } }
            }
          }
        });

        // 2. Success Rate by Tool (bar ‚Äî top 10 tools with real rates)
        const successTools = Object.entries(successRates)
          .sort((a, b) => (byTool[b[0]] || 0) - (byTool[a[0]] || 0))
          .slice(0, 10);
        new Chart(document.getElementById('toolSuccessChart'), {
          type: 'bar',
          data: {
            labels: successTools.map(([t]) => t),
            datasets: [{
              label: 'Success Rate',
              data: successTools.map(([, r]) => r),
              backgroundColor: successTools.map(([, r]) => r >= 95 ? 'rgba(0, 230, 118, 0.7)' : r >= 80 ? 'rgba(255, 215, 0, 0.7)' : 'rgba(233, 69, 96, 0.7)'),
              borderRadius: 4
            }]
          },
          options: {
            ...chartOpts,
            plugins: { legend: { display: false } },
            scales: {
              y: { min: 0, max: 100, ticks: { ...tickOpts, callback: v => v + '%' }, grid: gridOpts },
              x: { ticks: { ...tickOpts, font: { size: 10 } }, grid: { display: false } }
            }
          }
        });

        // 3. Daily Tool Volume (bar + 7-day MA line)
        const dailyTotals = dailyVolume.map(d => d.count || 0);
        const volumeMA = dailyTotals.map((v, i) => {
          const w = dailyTotals.slice(Math.max(0, i - 6), i + 1);
          return Math.round(w.reduce((a, b) => a + b, 0) / w.length);
        });
        new Chart(document.getElementById('toolDailyVolumeChart'), {
          type: 'bar',
          data: {
            labels: dailyVolume.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Tool Calls',
              data: dailyTotals,
              backgroundColor: 'rgba(0, 217, 255, 0.5)',
              borderRadius: 3,
              order: 2
            }, {
              label: '7-Day Avg',
              data: volumeMA,
              type: 'line',
              borderColor: 'rgba(0, 217, 255, 1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: false,
              order: 1
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { ticks: tickOpts, grid: gridOpts },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });

        // 4. Tool Category Trend (stacked area from DAILY_ACTIVITY_DATA)
        new Chart(document.getElementById('toolTrendChart'), {
          type: 'line',
          data: {
            labels: dailyAct.map(d => d.date.slice(5)),
            datasets: [
              { label: 'Bash', data: dailyAct.map(d => d.bash || 0), borderColor: 'rgba(0, 217, 255, 1)', backgroundColor: 'rgba(0, 217, 255, 0.3)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
              { label: 'Read', data: dailyAct.map(d => d.reads || 0), borderColor: 'rgba(233, 69, 96, 1)', backgroundColor: 'rgba(233, 69, 96, 0.3)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
              { label: 'Edit', data: dailyAct.map(d => d.edits || 0), borderColor: 'rgba(0, 230, 118, 1)', backgroundColor: 'rgba(0, 230, 118, 0.3)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
              { label: 'Write', data: dailyAct.map(d => d.writes || 0), borderColor: 'rgba(255, 215, 0, 1)', backgroundColor: 'rgba(255, 215, 0, 0.3)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 }
            ]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { stacked: true, ticks: tickOpts, grid: gridOpts },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });

        // 5. Git Commits chart (bar by day)
        const gitByDay = (gitData.byDay || []).reverse();
        if (gitByDay.length > 0) {
          new Chart(document.getElementById('gitCommitsChart'), {
            type: 'bar',
            data: {
              labels: gitByDay.map(d => d.date.slice(5)),
              datasets: [{
                label: 'Commits',
                data: gitByDay.map(d => d.count),
                backgroundColor: 'rgba(0, 230, 118, 0.6)',
                borderRadius: 3
              }]
            },
            options: {
              ...chartOpts,
              plugins: { legend: { display: false } },
              scales: {
                y: { ticks: tickOpts, grid: gridOpts },
                x: { ticks: tickOpts, grid: { display: false } }
              }
            }
          });
        }

        // 6. Git Repos doughnut
        const byRepo = gitData.byRepo || {};
        const repoEntries = Object.entries(byRepo).sort((a, b) => b[1] - a[1]);
        const repoColors = ['rgba(0, 217, 255, 0.8)', 'rgba(0, 230, 118, 0.8)', 'rgba(233, 69, 96, 0.8)', 'rgba(255, 215, 0, 0.8)', 'rgba(156, 39, 176, 0.8)', 'rgba(255, 152, 0, 0.8)', 'rgba(100, 181, 246, 0.8)', 'rgba(174, 213, 129, 0.8)', 'rgba(255, 112, 67, 0.8)', 'rgba(77, 208, 225, 0.8)', 'rgba(149, 117, 205, 0.8)', 'rgba(120, 120, 120, 0.6)'];
        if (repoEntries.length > 0) {
          new Chart(document.getElementById('gitReposChart'), {
            type: 'doughnut',
            data: {
              labels: repoEntries.map(([r]) => r),
              datasets: [{
                data: repoEntries.map(([, c]) => c),
                backgroundColor: repoEntries.map((_, i) => repoColors[i % repoColors.length]),
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'right', labels: { color: '#999', font: { size: 10 }, padding: 8 } },
                tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.raw + ' commits' } }
              }
            }
          });
        }

        // Git stat cards
        const gitStats = gitData.stats || {};
        el('gitCommitCount', gitStats.total || 0);
        el('gitRepoCount', repoEntries.length);
        el('gitInsertions', formatNumber(gitStats.insertions || 0));
        el('gitDeletions', formatNumber(gitStats.deletions || 0));

        // Failure patterns
        if (failurePatterns.length > 0) {
          el('failurePatternsCount', failurePatterns.length);
          document.getElementById('failurePatternsList').innerHTML = failurePatterns.map(fp => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
              <div style="flex: 1; min-width: 0;">
                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent-red);">${fp.tool}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${fp.error}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.85rem; color: var(--text-primary);">${fp.failures}x</div>
                <div style="font-size: 0.7rem; color: var(--text-secondary);">${fp.date}</div>
              </div>
            </div>
          `).join('');
        }
      })();
    }

    function getProductivityMode(reads, writes) {
      if (reads === 0 && writes === 0) {
        return { label: 'No activity', recommendation: 'Start tracking with Observatory commands' };
      }

      const ratio = reads / Math.max(writes, 1);

      if (ratio > 100) {
        return {
          label: 'Read-heavy (exploration mode)',
          recommendation: 'Consider writing more code or documentation'
        };
      } else if (ratio > 20) {
        return {
          label: 'Learning/researching',
          recommendation: 'Good balance for research phase'
        };
      } else if (ratio > 10) {
        return {
          label: 'Balanced productivity',
          recommendation: 'Excellent read/write balance'
        };
      } else {
        return {
          label: 'High productivity mode',
          recommendation: 'Great coding velocity!'
        };
      }
    }

    init();

    // Context Efficiency Tab - Load Pack Metrics
    async function loadPackMetrics() {
      try {
        const packData = PACK_DATA || {};

        if (packData.status === 'not_configured') {
          document.getElementById('totalSessions').textContent = '0';
          document.getElementById('totalTokenSavings').textContent = 'Not configured';
          document.getElementById('totalCostSavings').textContent = '‚Äî';
          document.getElementById('avgReduction').textContent = '‚Äî';
          document.getElementById('topPacksCount').textContent = '0';
          document.getElementById('topPacksList').innerHTML = '<div style="color:var(--text-secondary);padding:20px;text-align:center;"><div style="font-size:2rem;margin-bottom:10px;">üì¶</div><div>Context packs not configured</div><div style="font-size:0.85rem;margin-top:8px;opacity:0.7;">Run: python3 build_packs.py --create</div></div>';
          return;
        }

        const g = packData.global || {};
        const topPacks = packData.top_packs || [];
        const daily = packData.daily_trend || [];
        const inventory = packData.pack_inventory || [];

        // --- 6 Stat Cards ---
        document.getElementById('totalSessions').textContent = (g.total_sessions || 0).toLocaleString();
        const tokenSavings = g.total_token_savings || 0;
        document.getElementById('totalTokenSavings').textContent = tokenSavings >= 1000000 ? (tokenSavings / 1000000).toFixed(1) + 'M' : tokenSavings.toLocaleString();
        document.getElementById('totalCostSavings').textContent = `$${(g.total_cost_savings || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
        document.getElementById('avgReduction').textContent = `${(g.avg_reduction_rate || 0).toFixed(1)}%`;
        document.getElementById('totalPacks').textContent = g.total_packs || inventory.length;
        document.getElementById('totalPackTokens').textContent = (g.total_tokens || 0).toLocaleString();

        // --- Chart 1: Daily Sessions + Cost Savings (dual Y-axis) ---
        const scCtx = document.getElementById('packSessionCostChart')?.getContext('2d');
        if (scCtx && daily.length > 0) {
          document.getElementById('packDaysBadge').textContent = daily.length + ' Days';
          const labels = daily.map(d => { const p = d.date.split('-'); return p[1] + '/' + p[2]; });
          // Peak day highlight
          const maxSessions = Math.max(...daily.map(d => d.sessions));
          new Chart(scCtx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: 'Sessions',
                  data: daily.map(d => d.sessions),
                  backgroundColor: daily.map(d => d.sessions === maxSessions ? 'rgba(255, 215, 0, 0.9)' : 'rgba(168, 85, 247, 0.6)'),
                  borderRadius: 3,
                  yAxisID: 'y'
                },
                {
                  label: 'Cost Savings ($)',
                  data: daily.map(d => d.cost_savings),
                  type: 'line',
                  borderColor: 'rgba(0, 255, 136, 1)',
                  backgroundColor: 'rgba(0, 255, 136, 0.1)',
                  fill: true,
                  tension: 0.3,
                  pointRadius: 2,
                  yAxisID: 'y1'
                }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 8, font: { size: 10 } } } },
              scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 9 } }, grid: { display: false } },
                y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Sessions', color: 'rgba(168,85,247,0.8)', font: { size: 10 } }, ticks: { color: 'rgba(168,85,247,0.7)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Cost ($)', color: 'rgba(0,255,136,0.8)', font: { size: 10 } }, ticks: { color: 'rgba(0,255,136,0.7)', callback: v => '$' + v }, grid: { display: false } }
              }
            }
          });
        }

        // --- Chart 2: Daily Token Savings (bar + 7-day MA) ---
        const tsCtx = document.getElementById('savingsTrendChart')?.getContext('2d');
        if (tsCtx && daily.length > 0) {
          document.getElementById('packTokenTrendBadge').textContent = (tokenSavings >= 1000000 ? (tokenSavings/1000000).toFixed(1) + 'M' : tokenSavings.toLocaleString()) + ' Total';
          const labels = daily.map(d => { const p = d.date.split('-'); return p[1] + '/' + p[2]; });
          const tokenData = daily.map(d => d.token_savings);
          // 7-day moving average
          const ma7 = tokenData.map((v, i) => {
            if (i < 6) return null;
            const slice = tokenData.slice(i - 6, i + 1);
            return slice.reduce((a, b) => a + b, 0) / 7;
          });
          new Chart(tsCtx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Token Savings', data: tokenData, backgroundColor: 'rgba(0, 212, 255, 0.5)', borderRadius: 3 },
                { label: '7-Day MA', data: ma7, type: 'line', borderColor: 'rgba(255, 215, 0, 1)', borderWidth: 2, pointRadius: 0, tension: 0.4, spanGaps: true }
              ]
            },
            options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 8, font: { size: 10 } } } },
              scales: {
                x: { ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 9 } }, grid: { display: false } },
                y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.5)', callback: v => v >= 1000000 ? (v/1000000).toFixed(0) + 'M' : v >= 1000 ? (v/1000).toFixed(0) + 'K' : v }, grid: { color: 'rgba(255,255,255,0.05)' } }
              }
            }
          });
        }

        // --- Chart 3: Pack Inventory by Type (doughnut) ---
        const ptCtx = document.getElementById('packTypeChart')?.getContext('2d');
        if (ptCtx && inventory.length > 0) {
          document.getElementById('packInventoryCount').textContent = inventory.length;
          const typeCounts = {};
          inventory.forEach(p => { typeCounts[p.type] = (typeCounts[p.type] || 0) + 1; });
          const typeEntries = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
          const typeColors = { domain: 'rgba(0, 212, 255, 0.8)', project: 'rgba(168, 85, 247, 0.8)', pattern: 'rgba(255, 215, 0, 0.8)', custom: 'rgba(255, 136, 0, 0.8)' };
          new Chart(ptCtx, {
            type: 'doughnut',
            data: {
              labels: typeEntries.map(e => e[0]),
              datasets: [{ data: typeEntries.map(e => e[1]), backgroundColor: typeEntries.map(e => typeColors[e[0]] || 'rgba(100,200,255,0.8)'), borderWidth: 0 }]
            },
            options: {
              responsive: true, maintainAspectRatio: false, cutout: '55%',
              plugins: {
                legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 8, font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw} pack${ctx.raw > 1 ? 's' : ''}` } }
              }
            }
          });
        }

        // --- Chart 4: Pack Token Sizes (horizontal bar) ---
        const psCtx = document.getElementById('packSizeChart')?.getContext('2d');
        if (psCtx && inventory.length > 0) {
          const sorted = [...inventory].sort((a, b) => (b.tokens || 0) - (a.tokens || 0));
          const typeColors = { domain: 'rgba(0, 212, 255, 0.7)', project: 'rgba(168, 85, 247, 0.7)', pattern: 'rgba(255, 215, 0, 0.7)', custom: 'rgba(255, 136, 0, 0.7)' };
          new Chart(psCtx, {
            type: 'bar',
            data: {
              labels: sorted.map(p => p.name),
              datasets: [{
                label: 'Tokens',
                data: sorted.map(p => p.tokens || 0),
                backgroundColor: sorted.map(p => typeColors[p.type] || 'rgba(100,200,255,0.7)'),
                borderRadius: 4
              }]
            },
            options: {
              indexAxis: 'y', responsive: true, maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => `${ctx.raw} tokens (${sorted[ctx.dataIndex].type})` } }
              },
              scales: {
                x: { beginAtZero: true, title: { display: true, text: 'Tokens', color: 'rgba(255,255,255,0.5)', font: { size: 10 } }, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }, grid: { display: false } }
              }
            }
          });
        }

        // --- Top Packs List ---
        document.getElementById('topPacksCount').textContent = topPacks.length;
        const topPacksList = document.getElementById('topPacksList');
        if (topPacks.length > 0) {
          topPacksList.innerHTML = topPacks.map(pack => {
            const combined = (pack.combined_with || []).map(c => `<span style="padding:2px 6px;border-radius:4px;font-size:0.65rem;background:rgba(0,212,255,0.15);color:var(--accent-cyan);">${c}</span>`).join(' ');
            return `
              <div style="display:flex;align-items:center;gap:1rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;margin-bottom:0.5rem;">
                <div style="flex:1;">
                  <div style="font-weight:600;color:var(--text-primary);font-size:0.9rem;">${pack.name}</div>
                  <div style="font-size:0.7rem;color:var(--text-secondary);margin-top:4px;">Used ${pack.times_selected}x | ${pack.total_tokens_loaded || 0} tokens loaded</div>
                  ${combined ? `<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap;">${combined}</div>` : ''}
                </div>
                <div style="display:flex;gap:1rem;text-align:center;">
                  <div><div style="font-size:1.1rem;font-weight:700;color:var(--accent-green);">${(pack.avg_dq_score || 0).toFixed(2)}</div><div style="font-size:0.65rem;color:var(--text-muted);">DQ</div></div>
                  <div><div style="font-size:1.1rem;font-weight:700;color:var(--accent-cyan);">${(pack.avg_consensus_score || 0).toFixed(2)}</div><div style="font-size:0.65rem;color:var(--text-muted);">Consensus</div></div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          topPacksList.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:1rem;">No pack usage recorded yet</p>';
        }

        // --- Pack Inventory List ---
        const inventoryList = document.getElementById('packInventoryList');
        if (inventory.length > 0) {
          const typeColors = { domain: 'var(--accent-cyan)', project: 'var(--accent-purple)', pattern: 'var(--accent-yellow)' };
          inventoryList.innerHTML = inventory.map(pack => {
            const color = typeColors[pack.type] || 'var(--text-muted)';
            const usedBadge = pack.times_used > 0 ? `<span style="color:var(--accent-green);font-size:0.7rem;">${pack.times_used}x used</span>` : '<span style="color:var(--text-muted);font-size:0.7rem;">unused</span>';
            const dqBadge = pack.avg_dq_score > 0 ? `<span style="color:var(--accent-green);font-size:0.7rem;">DQ: ${pack.avg_dq_score.toFixed(2)}</span>` : '';
            return `
              <div style="display:flex;align-items:center;gap:0.75rem;padding:0.6rem;border-bottom:1px solid var(--border);">
                <span style="padding:2px 8px;border-radius:4px;font-size:0.65rem;background:${color}22;color:${color};font-weight:600;">${pack.type}</span>
                <div style="flex:1;">
                  <div style="font-weight:500;font-size:0.85rem;">${pack.name}</div>
                  <div style="font-size:0.7rem;color:var(--text-secondary);">v${pack.version} | ${pack.tokens || 0} tokens</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  ${dqBadge}
                  ${usedBadge}
                </div>
              </div>
            `;
          }).join('');
        } else {
          inventoryList.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:1rem;">No packs in inventory</p>';
        }

      } catch (error) {
        console.error('Error loading pack metrics:', error);
      }
    }

    // Load pack metrics when tab is accessed
    document.querySelector('[data-tab="context-efficiency"]')?.addEventListener('click', () => {
      setTimeout(loadPackMetrics, 100);
    });

    // Load on page load if tab is active
    if (document.getElementById('context-efficiency')?.classList.contains('active')) {
      loadPackMetrics();
    }

    // ============================================================================
    // SESSION OUTCOMES - CHART-BASED VISUALIZATION
    // ============================================================================

    (function renderSessionOutcomesTab() {
      const data = SESSION_OUTCOMES_DATA || {};
      const totals = data.totals || {};
      const daily = data.daily || [];
      const qDist = data.qualityDist || {};
      const mOutcomes = data.modelOutcomes || {};
      const sizeDist = data.sizeDist || {};
      const recentSessions = data.sessions || [];

      // Stat cards
      const total = totals.total || 0;
      const successRate = total > 0 ? (totals.success / total * 100).toFixed(1) : 0;
      document.getElementById('sessionTotalCount').textContent = formatNumber(total);
      document.getElementById('sessionSuccessRate').textContent = successRate + '%';
      document.getElementById('sessionAvgMessages').textContent = Math.round(totals.avgMessages || 0);
      document.getElementById('sessionMarathon').textContent = formatNumber(totals.marathon || 0);
      document.getElementById('sessionTotalMessages').textContent = formatNumber(totals.totalMessages || 0);

      const chartOpts = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#888', boxWidth: 12 } } },
        scales: {
          x: { ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } },
          y: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } }
        }
      };

      // 1. Outcome Distribution Doughnut
      const outcomeColors = {
        success: 'rgba(0,230,118,0.8)', abandoned: 'rgba(233,69,96,0.8)',
        partial: 'rgba(254,202,87,0.8)', error: 'rgba(231,76,60,0.8)', other: 'rgba(155,89,182,0.8)'
      };
      document.getElementById('outcomeDistBadge').textContent = formatNumber(total) + ' Sessions';
      new Chart(document.getElementById('outcomeDonutChart'), {
        type: 'doughnut',
        data: {
          labels: ['Success', 'Abandoned', 'Partial', 'Error', 'Other'],
          datasets: [{
            data: [totals.success||0, totals.abandoned||0, totals.partial||0, totals.error||0, totals.other||0],
            backgroundColor: [outcomeColors.success, outcomeColors.abandoned, outcomeColors.partial, outcomeColors.error, outcomeColors.other],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#888' } },
            tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.raw + ' (' + (ctx.raw/Math.max(total,1)*100).toFixed(1) + '%)' } }
          }
        }
      });

      // 2. Quality Distribution Bar
      const qualityLabels = ['1', '2', '3', '4', '5'];
      const qualityData = qualityLabels.map(q => qDist[q] || 0);
      const qualityColors = ['rgba(231,76,60,0.8)', 'rgba(233,69,96,0.8)', 'rgba(254,202,87,0.8)', 'rgba(72,219,251,0.8)', 'rgba(0,230,118,0.8)'];
      new Chart(document.getElementById('qualityBarChart'), {
        type: 'bar',
        data: {
          labels: qualityLabels.map(q => q + ' Star'),
          datasets: [{ data: qualityData, backgroundColor: qualityColors, borderRadius: 6 }]
        },
        options: { ...chartOpts, plugins: { legend: { display: false } } }
      });

      // 3. Daily Sessions Line
      if (daily.length) {
        document.getElementById('dailySessionsDays').textContent = daily.length + ' days';
        new Chart(document.getElementById('dailySessionsChart'), {
          type: 'bar',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [
              { label: 'Success', data: daily.map(d => d.success), backgroundColor: outcomeColors.success, borderRadius: 2 },
              { label: 'Abandoned', data: daily.map(d => d.abandoned), backgroundColor: outcomeColors.abandoned, borderRadius: 2 },
              { label: 'Other', data: daily.map(d => d.sessions - d.success - d.abandoned), backgroundColor: outcomeColors.partial, borderRadius: 2 }
            ]
          },
          options: {
            ...chartOpts,
            scales: {
              x: { stacked: true, ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } },
              y: { stacked: true, ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });

        // 4. Success Rate Trend (rolling)
        const successRates = daily.map(d => d.sessions > 0 ? +(d.success / d.sessions * 100).toFixed(1) : 0);
        new Chart(document.getElementById('successRateTrendChart'), {
          type: 'line',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Success %',
              data: successRates,
              borderColor: 'rgba(0,230,118,1)',
              backgroundColor: 'rgba(0,230,118,0.1)',
              fill: true, tension: 0.3, pointRadius: 4,
              pointBackgroundColor: 'rgba(0,230,118,1)'
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              ...chartOpts.scales,
              y: { min: 0, max: 100, ticks: { color: '#666', callback: v => v + '%' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });

        // 5. Sessions by Model (stacked per day)
        new Chart(document.getElementById('modelSessionsChart'), {
          type: 'bar',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [
              { label: 'Opus', data: daily.map(d => d.opus), backgroundColor: 'rgba(233,69,96,0.8)', borderRadius: 2 },
              { label: 'Sonnet', data: daily.map(d => d.sonnet), backgroundColor: 'rgba(72,219,251,0.8)', borderRadius: 2 },
              { label: 'Haiku', data: daily.map(d => d.haiku), backgroundColor: 'rgba(254,202,87,0.8)', borderRadius: 2 }
            ]
          },
          options: {
            ...chartOpts,
            scales: {
              x: { stacked: true, ticks: { color: '#666', maxRotation: 45 }, grid: { display: false } },
              y: { stacked: true, ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });

        // 6. Quality Trend
        const qualityTrend = daily.map(d => d.avgQuality || 0);
        new Chart(document.getElementById('qualityTrendChart'), {
          type: 'line',
          data: {
            labels: daily.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Avg Quality',
              data: qualityTrend,
              borderColor: 'rgba(254,202,87,1)',
              backgroundColor: 'rgba(254,202,87,0.1)',
              fill: true, tension: 0.3, pointRadius: 4,
              pointBackgroundColor: 'rgba(254,202,87,1)'
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              ...chartOpts.scales,
              y: { min: 0, max: 5, ticks: { color: '#666', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      }

      // 7. Session Size Distribution (horizontal bar)
      const sizeOrder = ['empty', 'tiny', 'small', 'medium', 'large', 'marathon'];
      const sizeLabels = ['Empty (0)', 'Tiny (1-5)', 'Small (6-20)', 'Medium (21-50)', 'Large (51-100)', 'Marathon (100+)'];
      const sizeData = sizeOrder.map(s => sizeDist[s] || 0);
      const sizeColors = ['rgba(108,117,125,0.6)', 'rgba(155,89,182,0.8)', 'rgba(72,219,251,0.8)', 'rgba(254,202,87,0.8)', 'rgba(233,69,96,0.8)', 'rgba(0,230,118,0.8)'];
      document.getElementById('sizeTotalBadge').textContent = formatNumber(total) + ' sessions';
      new Chart(document.getElementById('sizeDistChart'), {
        type: 'bar',
        data: {
          labels: sizeLabels,
          datasets: [{ data: sizeData, backgroundColor: sizeColors, borderRadius: 4 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#888', font: { size: 11 } }, grid: { display: false } }
          }
        }
      });

      // 8. Success Rate by Model (grouped bar)
      const modelNames = Object.keys(mOutcomes);
      if (modelNames.length) {
        new Chart(document.getElementById('modelSuccessChart'), {
          type: 'bar',
          data: {
            labels: modelNames.map(m => m.charAt(0).toUpperCase() + m.slice(1)),
            datasets: [
              { label: 'Success', data: modelNames.map(m => mOutcomes[m].success), backgroundColor: outcomeColors.success, borderRadius: 4 },
              { label: 'Abandoned', data: modelNames.map(m => mOutcomes[m].abandoned), backgroundColor: outcomeColors.abandoned, borderRadius: 4 },
              { label: 'Partial', data: modelNames.map(m => mOutcomes[m].partial), backgroundColor: outcomeColors.partial, borderRadius: 4 }
            ]
          },
          options: chartOpts
        });
      }

      // 9. Recent Sessions Table
      document.getElementById('recentSessionsCount').textContent = recentSessions.length + ' recent';
      const outcomeEmojis = { success: '‚úÖ', abandoned: '‚è∏Ô∏è', error: '‚ùå', partial: '‚ö†Ô∏è', completed: '‚úÖ', quick: '‚ö°' };
      const sessionsTable = document.getElementById('recentSessionsTable');
      sessionsTable.innerHTML = recentSessions.map(s => {
        const emoji = outcomeEmojis[s.outcome] || '‚ùì';
        const q = Math.round(s.quality || 0);
        const stars = q > 0 ? '‚òÖ'.repeat(q) : '-';
        const modelColor = { opus: 'var(--accent-red)', sonnet: 'var(--accent-cyan)', haiku: 'var(--accent-yellow)' }[s.model] || 'var(--text-secondary)';
        return `
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 10px; font-size: 0.85rem; color: var(--text-secondary);">${s.date || '-'}</td>
            <td style="padding: 10px; font-size: 0.85rem; color: ${modelColor}; font-weight: 600;">${(s.model || 'opus').charAt(0).toUpperCase() + (s.model || 'opus').slice(1)}</td>
            <td style="padding: 10px; text-transform: capitalize;">${emoji} ${s.outcome || 'unknown'}</td>
            <td style="padding: 10px; text-align: right;">${s.messages || 0}</td>
            <td style="padding: 10px; text-align: right;">${s.tools || 0}</td>
            <td style="padding: 10px; text-align: center; color: var(--accent-yellow);">${stars}</td>
          </tr>
        `;
      }).join('');
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPERMEMORY TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function renderSupermemory() {
      const data = SUPERMEMORY_DATA || {};
      const totals = data.totals || {};
      const sources = data.sources || {};
      const projects = data.projects || {};
      const learningCats = data.learningCategories || {};
      const dailyGrowth = data.dailyGrowth || [];
      const dailyLearnings = data.dailyLearnings || [];
      const reviewData = data.review || {};
      const reviewByCategory = reviewData.byCategory || {};
      const dueCount = reviewData.due_count || 0;
      const upcomingCount = reviewData.upcoming_count || 0;

      const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };

      // Status
      const statusEl = document.getElementById('supermemoryStatus');
      if (data.status === 'active') {
        statusEl.textContent = 'Active';
        statusEl.style.color = 'var(--accent-green)';
      } else {
        statusEl.textContent = 'Offline';
        statusEl.style.color = 'var(--accent-yellow)';
      }

      // Stat cards
      el('smMemoryItems', formatNumber(totals.memory_items || 0));
      el('smLearnings', formatNumber(totals.learnings || 0));
      el('smReviewTotal', formatNumber(totals.review_items || 0));
      el('smErrorPatterns', formatNumber(totals.error_patterns || 0));
      el('smProjects', Object.keys(projects).length);

      const dueEl = document.getElementById('smReviewDue');
      if (dueEl) {
        dueEl.textContent = dueCount;
        if (dueCount > 0) dueEl.style.color = 'var(--accent-yellow)';
      }

      // Source breakdown cards
      el('smSourceDaily', formatNumber(sources.daily || 0));
      el('smSourceOutcome', formatNumber(sources.outcome || 0));
      el('smSourceError', formatNumber(sources.error || 0));

      // Review badges
      el('smReviewBadge', dueCount + ' due / ' + upcomingCount + ' upcoming');
      el('smReviewDueBadge', dueCount + ' due');
      el('smErrorCount', totals.error_patterns || 0);

      const chartOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#999', font: { size: 11 } } } }
      };
      const gridOpts = { color: 'rgba(255,255,255,0.05)' };
      const tickOpts = { color: '#666' };

      // 1. Memory Growth (bar + cumulative line)
      if (dailyGrowth.length > 0) {
        let cumulative = 0;
        const cumulativeData = dailyGrowth.map(d => { cumulative += d.count; return cumulative; });
        new Chart(document.getElementById('smGrowthChart'), {
          type: 'bar',
          data: {
            labels: dailyGrowth.map(d => d.date.slice(5)),
            datasets: [{
              label: 'New Items',
              data: dailyGrowth.map(d => d.count),
              backgroundColor: 'rgba(0, 217, 255, 0.5)',
              borderRadius: 3,
              order: 2
            }, {
              label: 'Cumulative',
              data: cumulativeData,
              type: 'line',
              borderColor: 'rgba(0, 230, 118, 1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: false,
              yAxisID: 'y1',
              order: 1
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { position: 'left', ticks: tickOpts, grid: gridOpts, title: { display: true, text: 'Daily', color: '#666' } },
              y1: { position: 'right', ticks: tickOpts, grid: { display: false }, title: { display: true, text: 'Cumulative', color: '#666' } },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });
      }

      // 2. Project Distribution (doughnut)
      const projectEntries = Object.entries(projects).sort((a, b) => b[1] - a[1]);
      const projColors = ['rgba(0, 217, 255, 0.8)', 'rgba(0, 230, 118, 0.8)', 'rgba(233, 69, 96, 0.8)', 'rgba(255, 215, 0, 0.8)', 'rgba(156, 39, 176, 0.8)', 'rgba(255, 152, 0, 0.8)'];
      if (projectEntries.length > 0) {
        new Chart(document.getElementById('smProjectChart'), {
          type: 'doughnut',
          data: {
            labels: projectEntries.map(([p]) => p),
            datasets: [{
              data: projectEntries.map(([, c]) => c),
              backgroundColor: projectEntries.map((_, i) => projColors[i % projColors.length]),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: '#999', font: { size: 11 }, padding: 10 } },
              tooltip: { callbacks: { label: ctx => ctx.label + ': ' + formatNumber(ctx.raw) + ' items' } }
            }
          }
        });
      }

      // 3. Learning Categories (horizontal bar)
      const catEntries = Object.entries(learningCats).sort((a, b) => b[1] - a[1]).slice(0, 10);
      const catColors = ['rgba(0, 217, 255, 0.7)', 'rgba(0, 230, 118, 0.7)', 'rgba(233, 69, 96, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(156, 39, 176, 0.7)', 'rgba(255, 152, 0, 0.7)', 'rgba(100, 181, 246, 0.7)', 'rgba(174, 213, 129, 0.7)', 'rgba(255, 112, 67, 0.7)', 'rgba(77, 208, 225, 0.7)'];
      if (catEntries.length > 0) {
        new Chart(document.getElementById('smCategoryChart'), {
          type: 'bar',
          data: {
            labels: catEntries.map(([c]) => c),
            datasets: [{
              label: 'Learnings',
              data: catEntries.map(([, c]) => c),
              backgroundColor: catEntries.map((_, i) => catColors[i % catColors.length]),
              borderRadius: 4
            }]
          },
          options: {
            ...chartOpts,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: tickOpts, grid: gridOpts },
              y: { ticks: { ...tickOpts, font: { size: 11 } }, grid: { display: false } }
            }
          }
        });
      }

      // 4. Review Queue by Category (stacked bar: due vs upcoming)
      const revCatEntries = Object.entries(reviewByCategory).sort((a, b) => b[1].total - a[1].total).slice(0, 10);
      if (revCatEntries.length > 0) {
        new Chart(document.getElementById('smReviewChart'), {
          type: 'bar',
          data: {
            labels: revCatEntries.map(([c]) => c),
            datasets: [
              { label: 'Due Now', data: revCatEntries.map(([, v]) => v.due), backgroundColor: 'rgba(255, 215, 0, 0.8)', borderRadius: 3 },
              { label: 'Upcoming', data: revCatEntries.map(([, v]) => v.total - v.due), backgroundColor: 'rgba(0, 217, 255, 0.4)', borderRadius: 3 }
            ]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { stacked: true, ticks: tickOpts, grid: gridOpts },
              x: { stacked: true, ticks: tickOpts, grid: { display: false } }
            }
          }
        });
      }

      // Automations table (kept from v1)
      const automations = data.automations || {};
      const automationRows = [
        { name: 'Session Sync', key: 'session_sync', trigger: 'Session end hook' },
        { name: 'Error Lookup', key: 'error_lookup', trigger: 'Error detection hook' },
        { name: 'Daily Sync', key: 'daily_cron', trigger: 'LaunchD @ 6am' },
        { name: 'Weekly Rollup', key: 'weekly_rollup', trigger: 'Cron @ Sunday 8pm' }
      ];
      const automationsBody = document.getElementById('smAutomationsBody');
      if (automationsBody) {
        automationsBody.innerHTML = automationRows.map(row => {
          const enabled = automations[row.key];
          const statusColor = enabled ? 'var(--accent-green)' : 'var(--accent-red)';
          return `
            <tr style="border-bottom: 1px solid var(--border);">
              <td style="padding: 10px; color: var(--text-primary);">${row.name}</td>
              <td style="padding: 10px; text-align: center; color: ${statusColor};">${enabled ? 'ON' : 'OFF'}</td>
              <td style="padding: 10px; color: var(--text-secondary); font-size: 0.85rem;">${row.trigger}</td>
            </tr>
          `;
        }).join('');
      }

      // Review queue list (enhanced ‚Äî show up to 10)
      const reviewItems = reviewData.items || [];
      const reviewList = document.getElementById('smReviewList');
      if (reviewItems.length > 0) {
        reviewList.innerHTML = reviewItems.map(item => {
          const catColor = { general: 'var(--accent-cyan)', feature: 'var(--accent-green)', architecture: 'var(--accent-purple)', bug_fix: 'var(--accent-red)', devops: 'var(--accent-yellow)' }[item.category] || 'var(--accent-yellow)';
          return `
            <div style="padding: 10px; margin-bottom: 8px; background: var(--bg-hover); border-radius: 6px; border-left: 3px solid ${catColor};">
              <div style="color: var(--text-primary); font-size: 0.85rem; line-height: 1.4;">${(item.content || '').substring(0, 150)}${(item.content || '').length > 150 ? '...' : ''}</div>
              <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                <span style="color: var(--text-secondary); font-size: 0.7rem; background: var(--card-bg); padding: 2px 8px; border-radius: 10px;">${item.category || 'general'}</span>
                <span style="color: var(--text-secondary); font-size: 0.7rem;">Due: ${item.next_review || 'Now'}</span>
              </div>
            </div>
          `;
        }).join('');
      } else if (dueCount === 0) {
        reviewList.innerHTML = '<p style="color: var(--accent-green); text-align: center; padding: 20px;">All caught up! No items due for review.</p>';
      }

      // Recent learnings (kept from v1, enhanced display)
      const learnings = data.recent_learnings || [];
      const learningsList = document.getElementById('smLearningsList');
      if (learnings.length > 0) {
        learningsList.innerHTML = learnings.map(learning => {
          const catBadge = learning.category ? `<span style="background: var(--bg-hover); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: var(--text-secondary);">${learning.category}</span>` : '';
          return `
            <div style="padding: 10px; margin-bottom: 8px; background: var(--bg-hover); border-radius: 6px; border-left: 3px solid var(--accent-cyan);">
              <div style="color: var(--text-primary); font-size: 0.85rem; line-height: 1.4;">${(learning.content || '').substring(0, 200)}${(learning.content || '').length > 200 ? '...' : ''}</div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                ${catBadge}
                <span style="color: var(--text-secondary); font-size: 0.7rem;">${learning.date || ''}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Error patterns (enhanced with solution badge and count formatting)
      const errors = data.error_patterns || [];
      const errorsList = document.getElementById('smErrorsList');
      if (errors.length > 0) {
        errorsList.innerHTML = errors.map(err => `
          <div style="padding: 10px; margin-bottom: 8px; background: var(--bg-hover); border-radius: 6px; border-left: 3px solid rgba(233, 69, 96, 0.8);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span style="color: var(--text-secondary); font-size: 0.75rem; background: var(--card-bg); padding: 2px 8px; border-radius: 10px;">${err.category || 'unknown'}</span>
              ${err.solution ? '<span style="color: var(--accent-green); font-size: 0.7rem;">Has Fix</span>' : '<span style="color: var(--accent-red); font-size: 0.7rem;">No Fix</span>'}
            </div>
            <div style="color: var(--text-primary); font-size: 0.85rem; font-family: 'JetBrains Mono', monospace;">${err.pattern || err.error || err}</div>
            <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 4px;">Occurrences: ${formatNumber(err.count || 1)}</div>
          </div>
        `).join('');
      }
    }

    // Render supermemory on load
    renderSupermemory();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COGNITIVE OS TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function renderCognitive() {
      const data = COGNITIVE_DATA || {};
      const state = data.current_state || {};
      const flow = data.flow || {};
      const fate = data.fate || {};
      const accuracy = data.fate_accuracy || {};
      const fateDist = data.fate_distribution || {};
      const fateDaily = data.fate_daily || [];
      const routingSql = data.routing_sqlite || {};
      const flowHistory = data.flow_history || [];

      const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
      const elStyle = (id, val, color) => { const e = document.getElementById(id); if (e) { e.textContent = val; if (color) e.style.color = color; } };

      // Stat cards
      elStyle('cognitiveMode', state.mode || '‚Äî',
        { peak: 'var(--accent-green)', evening: 'var(--accent-cyan)', deep_night: 'var(--accent-purple)', morning: 'var(--accent-yellow)', dip: 'var(--accent-red)' }[state.mode] || 'var(--text-primary)');
      el('cognitiveEnergy', state.energy_level ? Math.round(state.energy_level * 100) + '%' : '‚Äî');
      elStyle('cognitiveFlow', flow.state || '‚Äî', flow.in_flow ? 'var(--accent-green)' : undefined);
      elStyle('cognitiveFate', fate.predicted_outcome || '‚Äî',
        { success: 'var(--accent-green)', abandon: 'var(--accent-red)', partial: 'var(--accent-yellow)' }[fate.predicted_outcome] || 'var(--text-secondary)');
      const fateTotal = accuracy.total || 0;
      const fateCorrect = accuracy.correct || 0;
      const fateRate = fateTotal > 0 ? Math.round((fateCorrect / fateTotal) * 100) : 0;
      el('cogFateAccuracy', fateRate + '% (' + fateCorrect + '/' + fateTotal + ')');
      el('cogRoutingTotal', formatNumber(routingSql.total || 0));

      // Cognitive brief
      const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
      el('cognitiveDay', today);
      el('cognitiveRecommendedTasks', (state.recommended_tasks || []).slice(0, 3).join(', ') || '‚Äî');
      el('cognitiveRecommendedModel', (data.routing || {}).recommended_model || '‚Äî');
      el('cognitivePeakHours', (data.peak_hours || []).map(h => h + ':00').join(', ') || '20:00, 19:00, 3:00');
      el('cogFlowScore', flow.score ? flow.score.toFixed(2) : '‚Äî');

      // Warnings
      const warnings = state.warnings || [];
      const warningsEl = document.getElementById('cognitiveWarnings');
      if (warningsEl) {
        warningsEl.innerHTML = warnings.length > 0 ? warnings.map(w => `<div style="padding:4px 0;">‚ö† ${w}</div>`).join('') : '';
      }

      // Weekly energy map (kept ‚Äî works well)
      const weekly = data.weekly || {};
      const energyBars = document.getElementById('energyBars');
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      if (energyBars) {
        energyBars.innerHTML = days.map(day => {
          const dayData = weekly[day] || { level: 0.5, energy: 'MED' };
          const level = dayData.level || 0.5;
          const isToday = day === today;
          const color = level >= 0.7 ? 'var(--accent-green)' : level >= 0.5 ? 'var(--accent-yellow)' : 'var(--accent-red)';
          const width = Math.round(level * 100);
          return `
            <div style="display:flex;align-items:center;gap:1rem;${isToday ? 'background:var(--bg-glass);padding:0.5rem;border-radius:6px;' : ''}">
              <span style="width:100px;color:${isToday ? 'var(--accent-cyan)' : 'var(--text-secondary)'};font-size:0.85rem;">${day.slice(0,3)}${isToday ? ' ‚Üê' : ''}</span>
              <div style="flex:1;height:20px;background:var(--bg-secondary);border-radius:4px;overflow:hidden;">
                <div style="width:${width}%;height:100%;background:${color};border-radius:4px;transition:width 0.3s;"></div>
              </div>
              <span style="width:50px;text-align:right;color:var(--text-muted);font-size:0.8rem;">${dayData.energy}</span>
            </div>
          `;
        }).join('');
      }

      const chartOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#999', font: { size: 11 } } } }
      };
      const gridOpts = { color: 'rgba(255,255,255,0.05)' };
      const tickOpts = { color: '#666' };

      // 1. Flow State History (all 200 entries ‚Äî line with in-flow highlights)
      if (flowHistory.length > 0) {
        const scores = flowHistory.map(f => f.flow_score || 0);
        // Moving average
        const flowMA = scores.map((v, i) => {
          const w = scores.slice(Math.max(0, i - 9), i + 1);
          return w.reduce((a, b) => a + b, 0) / w.length;
        });
        new Chart(document.getElementById('flowChart'), {
          type: 'line',
          data: {
            labels: flowHistory.map((f, i) => {
              const ts = f.timestamp || '';
              return ts.length >= 10 ? ts.slice(5, 10) : String(i + 1);
            }),
            datasets: [{
              label: 'Flow Score',
              data: scores,
              borderColor: 'rgba(0, 217, 255, 0.4)',
              backgroundColor: 'rgba(0, 217, 255, 0.05)',
              fill: true,
              tension: 0.3,
              pointRadius: 1.5,
              pointBackgroundColor: flowHistory.map(f => f.in_flow ? 'rgba(0, 255, 136, 1)' : 'rgba(255, 77, 106, 0.6)'),
              borderWidth: 1,
              order: 2
            }, {
              label: '10-pt Average',
              data: flowMA,
              borderColor: 'rgba(0, 217, 255, 1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: false,
              order: 1
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { min: 0, max: 1, ticks: { ...tickOpts, callback: v => (v * 100).toFixed(0) + '%' }, grid: gridOpts },
              x: { ticks: { ...tickOpts, maxTicksLimit: 15 }, grid: { display: false } }
            },
            plugins: {
              ...chartOpts.plugins,
              annotation: {
                annotations: {
                  flowLine: { type: 'line', yMin: 0.75, yMax: 0.75, borderColor: 'rgba(0, 230, 118, 0.5)', borderDash: [5, 5], borderWidth: 1 }
                }
              }
            }
          }
        });
      }

      // 2. Routing Distribution (from SQLite ‚Äî much more balanced)
      const byModel = routingSql.byModel || {};
      const modelEntries = Object.entries(byModel).filter(([, c]) => c > 0).sort((a, b) => b[1] - a[1]);
      const modelColors = {
        haiku: 'rgba(0, 255, 136, 0.8)',
        sonnet: 'rgba(0, 217, 255, 0.8)',
        opus: 'rgba(177, 78, 255, 0.8)',
        flash: 'rgba(255, 215, 0, 0.8)',
        'local-fast': 'rgba(255, 152, 0, 0.8)',
        local: 'rgba(120, 120, 120, 0.6)'
      };
      if (modelEntries.length > 0) {
        new Chart(document.getElementById('cognitiveRoutingChart'), {
          type: 'doughnut',
          data: {
            labels: modelEntries.map(([m]) => m.charAt(0).toUpperCase() + m.slice(1)),
            datasets: [{
              data: modelEntries.map(([, c]) => c),
              backgroundColor: modelEntries.map(([m]) => modelColors[m] || 'rgba(120,120,120,0.6)'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: '#999', font: { size: 11 }, padding: 12 } },
              tooltip: {
                callbacks: {
                  label: ctx => {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    return ctx.label + ': ' + formatNumber(ctx.raw) + ' (' + ((ctx.raw / total) * 100).toFixed(1) + '%)';
                  }
                }
              }
            }
          }
        });
      }

      // 3. Fate Accuracy Trend (daily)
      if (fateDaily.length > 0) {
        new Chart(document.getElementById('fateAccuracyChart'), {
          type: 'line',
          data: {
            labels: fateDaily.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Accuracy %',
              data: fateDaily.map(d => d.accuracy),
              borderColor: 'rgba(0, 230, 118, 1)',
              backgroundColor: 'rgba(0, 230, 118, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 3,
              borderWidth: 2
            }, {
              label: 'Predictions',
              data: fateDaily.map(d => d.total),
              type: 'bar',
              backgroundColor: 'rgba(0, 217, 255, 0.3)',
              borderRadius: 2,
              yAxisID: 'y1',
              order: 2
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { position: 'left', min: 0, max: 100, ticks: { ...tickOpts, callback: v => v + '%' }, grid: gridOpts, title: { display: true, text: 'Accuracy', color: '#666' } },
              y1: { position: 'right', ticks: tickOpts, grid: { display: false }, title: { display: true, text: 'Count', color: '#666' } },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });
      }

      // 4. Daily DQ Score Trend (from SQLite routing)
      const dailyRouting = routingSql.daily || [];
      if (dailyRouting.length > 0) {
        new Chart(document.getElementById('dqScoreTrendChart'), {
          type: 'line',
          data: {
            labels: dailyRouting.map(d => d.date.slice(5)),
            datasets: [{
              label: 'Avg DQ Score',
              data: dailyRouting.map(d => d.avg_dq),
              borderColor: 'rgba(0, 217, 255, 1)',
              backgroundColor: 'rgba(0, 217, 255, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              borderWidth: 2
            }, {
              label: 'Avg Complexity',
              data: dailyRouting.map(d => d.avg_complexity),
              borderColor: 'rgba(255, 215, 0, 0.8)',
              borderWidth: 1.5,
              tension: 0.4,
              pointRadius: 3,
              fill: false,
              borderDash: [4, 4]
            }]
          },
          options: {
            ...chartOpts,
            scales: {
              y: { min: 0, max: 1, ticks: tickOpts, grid: gridOpts },
              x: { ticks: tickOpts, grid: { display: false } }
            }
          }
        });
      }

      // 5. Fate Distribution (doughnut)
      const distEntries = Object.entries(fateDist).filter(([, c]) => c > 0);
      const distColors = { success: 'rgba(0, 230, 118, 0.8)', abandon: 'rgba(233, 69, 96, 0.8)', partial: 'rgba(255, 215, 0, 0.8)', unknown: 'rgba(120, 120, 120, 0.6)' };
      if (distEntries.length > 0) {
        new Chart(document.getElementById('fateDistChart'), {
          type: 'doughnut',
          data: {
            labels: distEntries.map(([k]) => k.charAt(0).toUpperCase() + k.slice(1)),
            datasets: [{
              data: distEntries.map(([, c]) => c),
              backgroundColor: distEntries.map(([k]) => distColors[k] || 'rgba(120,120,120,0.6)'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: '#999', font: { size: 11 }, padding: 12 } },
              tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.raw + ' predictions' } }
            }
          }
        });
      }
    }

    // Render cognitive on load (includes coordinator section)
    renderCognitive();
    renderCoordinator();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RECOVERY TAB RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderRecovery() {
      const data = RECOVERY_DATA || {};
      const stats = data.stats || {};
      const outcomes = data.outcomes || [];
      const matrix = data.matrix || [];

      // Update stat cards
      document.getElementById('recoveryTotal').textContent = stats.total || 0;
      document.getElementById('recoveryAutoFix').textContent =
        stats.autoFix ? `${stats.autoFix} (${stats.autoFixRate || 0}%)` : '0';
      document.getElementById('recoverySuccess').textContent =
        stats.successRate ? `${stats.successRate}%` : '‚Äî';

      // Category distribution chart
      const categories = data.categories || {};
      const categoryCtx = document.getElementById('recoveryCategoryChart')?.getContext('2d');
      if (categoryCtx && Object.keys(categories).length > 0) {
        new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categories),
            datasets: [{
              data: Object.values(categories),
              backgroundColor: [
                'rgba(255, 77, 106, 0.8)',   // git - red
                'rgba(0, 217, 255, 0.8)',    // concurrency - cyan
                'rgba(255, 204, 0, 0.8)',    // permissions - yellow
                'rgba(177, 78, 255, 0.8)',   // quota - purple
                'rgba(255, 123, 84, 0.8)',   // crash - orange
                'rgba(0, 255, 136, 0.8)',    // recursion - green
                'rgba(138, 138, 154, 0.8)'   // syntax - gray
              ],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', padding: 10, font: { size: 11 } } }
            }
          }
        });
      }

      // Auto-fix vs Suggest chart
      const typeCtx = document.getElementById('recoveryTypeChart')?.getContext('2d');
      if (typeCtx) {
        new Chart(typeCtx, {
          type: 'doughnut',
          data: {
            labels: ['Auto-Fixed', 'Suggested'],
            datasets: [{
              data: [stats.autoFix || 0, (stats.total || 0) - (stats.autoFix || 0)],
              backgroundColor: ['rgba(0, 255, 136, 0.8)', 'rgba(255, 204, 0, 0.8)'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', padding: 10 } }
            }
          }
        });
      }

      // Timeline chart (last 7 days)
      const timeline = data.timeline || [];
      const timelineCtx = document.getElementById('recoveryTimelineChart')?.getContext('2d');
      if (timelineCtx && timeline.length > 0) {
        new Chart(timelineCtx, {
          type: 'bar',
          data: {
            labels: timeline.map(t => t.date),
            datasets: [
              {
                label: 'Auto-Fixed',
                data: timeline.map(t => t.autoFix || 0),
                backgroundColor: 'rgba(0, 255, 136, 0.8)'
              },
              {
                label: 'Suggested',
                data: timeline.map(t => t.suggested || 0),
                backgroundColor: 'rgba(255, 204, 0, 0.8)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
              y: { stacked: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } }
            },
            plugins: {
              legend: { position: 'top', labels: { color: 'rgba(255,255,255,0.7)', padding: 10 } }
            }
          }
        });
      }

      // Success by category chart
      const successByCategory = data.successByCategory || {};
      const successCtx = document.getElementById('recoverySuccessChart')?.getContext('2d');
      if (successCtx && Object.keys(successByCategory).length > 0) {
        new Chart(successCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(successByCategory),
            datasets: [{
              label: 'Success Rate %',
              data: Object.values(successByCategory),
              backgroundColor: 'rgba(0, 217, 255, 0.8)'
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)' } },
              y: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.7)' } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // Recovery matrix table
      const matrixBody = document.getElementById('recoveryMatrixBody');
      if (matrixBody && matrix.length > 0) {
        matrixBody.innerHTML = matrix.map(row => `
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">${row.category}</td>
            <td style="padding:0.75rem;text-align:center;">${row.errors}</td>
            <td style="padding:0.75rem;"><span style="color:var(--accent-green);">${row.autoFix || '‚Äî'}</span></td>
            <td style="padding:0.75rem;"><span style="color:var(--accent-yellow);">${row.suggestOnly || '‚Äî'}</span></td>
          </tr>
        `).join('');
      } else if (matrixBody) {
        // Show default matrix
        matrixBody.innerHTML = `
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Git</td><td style="text-align:center;">560</td><td style="color:var(--accent-green);">username, locks</td><td style="color:var(--accent-yellow);">merge conflicts, force push</td></tr>
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Concurrency</td><td style="text-align:center;">55</td><td style="color:var(--accent-green);">stale locks, zombies</td><td style="color:var(--accent-yellow);">parallel sessions</td></tr>
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Permissions</td><td style="text-align:center;">40</td><td style="color:var(--accent-green);">safe paths</td><td style="color:var(--accent-yellow);">system paths</td></tr>
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Quota</td><td style="text-align:center;">25</td><td style="color:var(--accent-green);">cache</td><td style="color:var(--accent-yellow);">model switch</td></tr>
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Crash</td><td style="text-align:center;">15</td><td style="color:var(--accent-green);">corrupt state</td><td style="color:var(--accent-yellow);">restore backup</td></tr>
          <tr style="border-bottom:1px solid var(--border);"><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Recursion</td><td style="text-align:center;">3</td><td style="color:var(--accent-green);">kill runaway</td><td style="color:var(--accent-yellow);">‚Äî</td></tr>
          <tr><td style="padding:0.75rem;font-weight:500;color:var(--accent-cyan);">Syntax</td><td style="text-align:center;">2</td><td style="color:var(--accent-green);">‚Äî</td><td style="color:var(--accent-yellow);">always suggest</td></tr>
        `;
      }

      // Recent recovery list
      const recentList = document.getElementById('recentRecoveryList');
      const recentCount = document.getElementById('recentRecoveryCount');
      if (recentList && outcomes.length > 0) {
        recentCount.textContent = outcomes.length;
        recentList.innerHTML = outcomes.slice(0, 20).map(o => {
          const date = new Date(o.ts * 1000);
          const timeStr = date.toLocaleString();
          const statusIcon = o.success ? '‚úÖ' : '‚ö†Ô∏è';
          const typeTag = o.auto ? '<span style="color:var(--accent-green);font-size:0.7rem;background:rgba(0,255,136,0.1);padding:2px 6px;border-radius:4px;">AUTO</span>' : '<span style="color:var(--accent-yellow);font-size:0.7rem;background:rgba(255,204,0,0.1);padding:2px 6px;border-radius:4px;">SUGGEST</span>';
          return `
            <div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border);">
              <span style="font-size:1.1rem;">${statusIcon}</span>
              <div style="flex:1;">
                <div style="font-weight:500;">${o.action || 'unknown'}</div>
                <div style="font-size:0.75rem;color:var(--text-secondary);">${o.category} ¬∑ ${timeStr}</div>
              </div>
              ${typeTag}
            </div>
          `;
        }).join('');
      }
    }

    // Render recovery on load
    renderRecovery();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COORDINATOR TAB RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderCoordinator() {
      const data = COORDINATOR_DATA || {};
      const registry = data.registry || {};
      const locks = data.locks || {};
      const history = data.history || [];
      const agents = data.agents || [];

      // Update stat cards
      document.getElementById('coordActiveAgents').textContent = registry.active_count || 0;
      document.getElementById('coordCompletedAgents').textContent =
        (registry.by_state?.completed || 0) + (registry.by_state?.failed || 0);
      document.getElementById('coordFileLocks').textContent = locks.total_locks || 0;
      document.getElementById('coordTotalCost').textContent = formatCost(registry.total_cost_estimate || 0);
      document.getElementById('coordRegistryBadge').textContent = `${registry.total_agents || 0} agents`;
      document.getElementById('coordLocksBadge').textContent = `${locks.total_locks || 0} locks`;

      // Agent list
      const agentList = document.getElementById('coordAgentList');
      if (agents.length > 0) {
        agentList.innerHTML = agents.map(a => {
          const stateColors = {
            running: 'cyan', completed: 'green', failed: 'red',
            timeout: 'yellow', pending: 'gray', cancelled: 'gray'
          };
          const color = stateColors[a.state] || 'gray';
          return `
            <div class="item-row">
              <div class="item-main">
                <span class="badge ${color}">${a.state}</span>
                <span>${a.subtask || a.agent_id}</span>
              </div>
              <div class="item-meta">
                <span class="badge">${a.model}</span>
                <span>DQ: ${(a.dq_score || 0).toFixed(2)}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        agentList.innerHTML = '<p class="empty-state">No active agents</p>';
      }

      // By State chart
      const byState = registry.by_state || {};
      const stateCtx = document.getElementById('coordByStateChart')?.getContext('2d');
      if (stateCtx && Object.keys(byState).length > 0) {
        const stateLabels = Object.keys(byState);
        const stateData = Object.values(byState);
        const stateColors = stateLabels.map(s => {
          const colorMap = {
            running: 'rgba(0, 217, 255, 0.8)', completed: 'rgba(0, 255, 136, 0.8)',
            failed: 'rgba(255, 99, 132, 0.8)', timeout: 'rgba(255, 206, 86, 0.8)',
            pending: 'rgba(128, 128, 128, 0.8)', cancelled: 'rgba(100, 100, 100, 0.8)'
          };
          return colorMap[s] || 'rgba(128, 128, 128, 0.8)';
        });

        if (!stateCtx._chartInstance) {
          stateCtx._chartInstance = new Chart(stateCtx, {
            type: 'doughnut',
            data: { labels: stateLabels, datasets: [{ data: stateData, backgroundColor: stateColors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', padding: 10 } } } }
          });
        }
      }

      // By Model chart
      const byModel = registry.by_model || {};
      const modelCtx = document.getElementById('coordByModelChart')?.getContext('2d');
      if (modelCtx && Object.keys(byModel).length > 0) {
        const modelLabels = Object.keys(byModel);
        const modelData = Object.values(byModel);
        const modelColors = modelLabels.map(m => {
          const colorMap = { haiku: 'rgba(0, 255, 136, 0.8)', sonnet: 'rgba(0, 217, 255, 0.8)', opus: 'rgba(177, 78, 255, 0.8)' };
          return colorMap[m] || 'rgba(128, 128, 128, 0.8)';
        });

        if (!modelCtx._chartInstance) {
          modelCtx._chartInstance = new Chart(modelCtx, {
            type: 'doughnut',
            data: { labels: modelLabels, datasets: [{ data: modelData, backgroundColor: modelColors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.7)', padding: 10 } } } }
          });
        }
      }

      // Lock list
      const lockList = document.getElementById('coordLockList');
      const lockData = data.lockDetails || [];
      if (lockData.length > 0) {
        lockList.innerHTML = lockData.map(l => `
          <div class="item-row">
            <div class="item-main">
              <span class="badge ${l.lock_type === 'write' ? 'yellow' : 'cyan'}">${l.lock_type}</span>
              <code>${l.path}</code>
            </div>
            <div class="item-meta">
              <span>${l.agent_id}</span>
            </div>
          </div>
        `).join('');
      } else {
        lockList.innerHTML = '<p class="empty-state">No active file locks</p>';
      }

      // History table
      const historyBody = document.getElementById('coordHistoryBody');
      if (history.length > 0) {
        historyBody.innerHTML = history.slice(0, 20).map(h => {
          const statusColors = { success: 'green', partial: 'yellow', failed: 'red', cancelled: 'gray' };
          const color = statusColors[h.status] || 'gray';
          return `
            <tr>
              <td><code>${h.task_id}</code></td>
              <td>${(h.task || '').substring(0, 40)}${(h.task || '').length > 40 ? '...' : ''}</td>
              <td><span class="badge">${h.strategy}</span></td>
              <td><span class="badge ${color}">${h.status}</span></td>
              <td>${h.duration_seconds?.toFixed(1) || 0}s</td>
              <td>${formatCost(h.total_cost || 0)}</td>
            </tr>
          `;
        }).join('');
      } else {
        historyBody.innerHTML = '<tr><td colspan="6" class="empty-state">No coordination history</td></tr>';
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTIVE SESSIONS RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderSessions() {
      const data = SESSIONS_DATA || {};
      const stats = data.stats || {};
      const sessions = data.sessions || [];

      // Update stat cards
      document.getElementById('sessionsActiveCount').textContent = stats.total || 0;

      // Format total runtime
      const totalMins = stats.total_runtime_minutes || 0;
      let runtimeStr = '0m';
      if (totalMins >= 60) {
        const hours = Math.floor(totalMins / 60);
        const mins = totalMins % 60;
        runtimeStr = hours + 'h ' + mins + 'm';
      } else {
        runtimeStr = totalMins + 'm';
      }
      document.getElementById('sessionsTotalRuntime').textContent = runtimeStr;

      document.getElementById('sessionsOpusCount').textContent = stats.opus || 0;
      document.getElementById('sessionsSonnetCount').textContent = stats.sonnet || 0;

      // Update badge
      document.getElementById('sessionsListBadge').textContent = (sessions.length || 0) + ' sessions';

      // Sessions table
      const tableBody = document.getElementById('sessionsTableBody');
      if (sessions.length > 0) {
        tableBody.innerHTML = sessions.map(s => {
          const modelColors = {
            opus: 'purple',
            sonnet: 'cyan',
            haiku: 'green'
          };
          const color = modelColors[s.model] || 'gray';

          return `
            <tr>
              <td><code>${s.pid}</code></td>
              <td><span class="badge ${color}">${s.model}</span></td>
              <td>${s.runtime}</td>
              <td>${s.cpu}%</td>
              <td>${s.mem}%</td>
              <td title="${s.cwd}"><code>${s.cwd.length > 30 ? '...' + s.cwd.slice(-27) : s.cwd}</code></td>
            </tr>
          `;
        }).join('');
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" class="empty-state">No active Claude sessions</td></tr>';
      }

      // Session History from SESSION_OUTCOMES_DATA
      const historySource = (typeof SESSION_OUTCOMES_DATA !== 'undefined' && SESSION_OUTCOMES_DATA.sessions) ? SESSION_OUTCOMES_DATA.sessions : (Array.isArray(SESSION_OUTCOMES_DATA) ? SESSION_OUTCOMES_DATA : []);
      const historyData = historySource
        .sort((a, b) => (b.date || '').localeCompare(a.date || ''))
        .slice(0, 20);

      document.getElementById('sessionHistoryBadge').textContent = historyData.length + ' recent';

      const historyBody = document.getElementById('sessionHistoryBody');
      if (historyData.length > 0) {
        historyBody.innerHTML = historyData.map(s => {
          const outcomeColors = {
            success: 'green',
            partial: 'yellow',
            abandoned: 'red',
            failed: 'red'
          };
          const outcomeColor = outcomeColors[s.outcome] || 'gray';

          // Get primary model from models_used
          const models = s.models_used || {};
          const primaryModel = Object.keys(models).reduce((a, b) =>
            (models[a] || 0) > (models[b] || 0) ? a : b, Object.keys(models)[0] || 'unknown');
          const modelColors = { opus: 'purple', sonnet: 'cyan', haiku: 'green' };
          const modelColor = modelColors[primaryModel] || 'gray';

          // Truncate title
          const title = (s.title || s.intent || '‚Äî').substring(0, 35);
          const titleFull = s.title || s.intent || '‚Äî';

          return `
            <tr>
              <td>${s.date || '‚Äî'}</td>
              <td title="${titleFull}">${title}${titleFull.length > 35 ? '...' : ''}</td>
              <td>${s.messages || 0}</td>
              <td>${s.tools || 0}</td>
              <td><span class="badge ${modelColor}">${primaryModel}</span></td>
              <td><span class="badge ${outcomeColor}">${s.outcome || '‚Äî'}</span></td>
            </tr>
          `;
        }).join('');
      } else {
        historyBody.innerHTML = '<tr><td colspan="6" class="empty-state">No session history</td></tr>';
      }
    }

    // Render sessions on load
    renderSessions();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INFRASTRUCTURE TAB RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderInfrastructure() {
      const data = INFRASTRUCTURE_DATA || {};
      const daemons = data.daemons || [];
      const status = data.status || 'unknown';
      const heartbeat = data.heartbeat || null;
      const healingEvents = data.healingEvents || [];
      const dataFreshness = data.dataFreshness || [];
      const watchdogDaily = data.watchdogDaily || [];
      const selfHealDaily = data.selfHealDaily || [];
      const daemonHealCounts = data.daemonHealCounts || {};
      const recoveryStats = data.recoveryStats || {};
      const selfHealSummary = data.selfHealSummary || {};

      // --- 6 Stat Cards ---
      const activeDaemons = daemons.filter(d => d.loaded).length;
      const totalDaemons = daemons.length;

      document.getElementById('infraStatus').textContent = status === 'healthy' ? 'HEALTHY' : 'DEGRADED';
      document.getElementById('infraStatus').style.color = status === 'healthy' ? 'var(--accent-green)' : 'var(--accent-orange)';
      document.getElementById('infraDaemons').textContent = `${activeDaemons}/${totalDaemons}`;
      document.getElementById('infraDaemons').style.color = activeDaemons === totalDaemons ? 'var(--accent-green)' : 'var(--accent-orange)';

      if (heartbeat) {
        const hbDate = new Date(heartbeat);
        const diffMins = Math.floor((new Date() - hbDate) / 60000);
        document.getElementById('infraHeartbeat').textContent = diffMins < 2 ? 'Just now' : `${diffMins}m ago`;
        document.getElementById('infraHeartbeat').style.color = diffMins < 5 ? 'var(--accent-green)' : 'var(--accent-yellow)';
      } else {
        document.getElementById('infraHeartbeat').textContent = 'Unknown';
      }

      const healedLast24h = healingEvents.filter(e => (new Date() - new Date(e.timestamp)) < 86400000).length;
      document.getElementById('infraHealed').textContent = healedLast24h;

      document.getElementById('infraSelfHealRuns').textContent = (selfHealSummary.totalRuns || 0).toLocaleString();
      const recTotal = recoveryStats.total || 0;
      const recSuccess = recoveryStats.successful || 0;
      document.getElementById('infraRecoveryRate').textContent = recTotal > 0 ? Math.round((recSuccess / recTotal) * 100) + '%' : '100%';

      // --- Daemon Grid ---
      const daemonGrid = document.getElementById('daemonGrid');
      if (daemons.length > 0) {
        daemonGrid.innerHTML = daemons.map(d => {
          const statusColor = d.loaded ? 'var(--accent-green)' : 'var(--accent-red)';
          const statusIcon = d.loaded ? '‚óè' : '‚óã';
          const runningText = d.pid && d.pid !== '-' ? `PID: ${d.pid}` : (d.loaded ? 'Scheduled' : 'Not loaded');
          const healCount = daemonHealCounts[d.name.replace('com.claude.', '')] || 0;
          return `
            <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-glass);border-radius:8px;border:1px solid ${d.loaded ? 'transparent' : 'var(--accent-red)'};">
              <span style="color:${statusColor};font-size:1.2rem;">${statusIcon}</span>
              <div style="flex:1;">
                <div style="font-weight:600;color:var(--text-primary);font-size:0.85rem;">${d.name.replace('com.claude.', '')}</div>
                <div style="font-size:0.7rem;color:var(--text-secondary);">${d.description || ''}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:0.7rem;color:${statusColor};">${runningText}</div>
                ${healCount > 0 ? `<div style="font-size:0.65rem;color:var(--text-muted);">${healCount} heals</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } else {
        daemonGrid.innerHTML = '<p class="empty-state">No daemon data</p>';
      }

      // --- Protection Layer Status ---
      const findDaemon = (name) => daemons.find(d => d.name.includes(name));
      const watchdog = findDaemon('watchdog');
      const bootstrap = findDaemon('bootstrap');
      const wake = findDaemon('wake-hook');
      const selfHeal = findDaemon('self-heal');
      if (watchdog) document.getElementById('watchdogStatus').style.color = watchdog.loaded ? 'var(--accent-green)' : 'var(--accent-red)';
      if (bootstrap) document.getElementById('bootstrapStatus').style.color = bootstrap.loaded ? 'var(--accent-green)' : 'var(--accent-red)';
      if (wake) document.getElementById('wakeStatus').style.color = wake.loaded ? 'var(--accent-green)' : 'var(--accent-red)';
      if (selfHeal) document.getElementById('selfHealStatus').style.color = selfHeal.loaded ? 'var(--accent-green)' : 'var(--accent-red)';

      // --- Chart 1: Watchdog Activity (stacked bar: down/loaded/healed per day) ---
      const wdCtx = document.getElementById('watchdogActivityChart')?.getContext('2d');
      if (wdCtx && watchdogDaily.length > 0) {
        document.getElementById('watchdogDaysBadge').textContent = watchdogDaily.length + ' Days';
        const wdLabels = watchdogDaily.map(d => { const p = d.date.split('-'); return p[1] + '/' + p[2]; });
        new Chart(wdCtx, {
          type: 'bar',
          data: {
            labels: wdLabels,
            datasets: [
              { label: 'Down', data: watchdogDaily.map(d => d.down), backgroundColor: 'rgba(255, 82, 82, 0.7)', borderRadius: 2 },
              { label: 'Loaded', data: watchdogDaily.map(d => d.loaded), backgroundColor: 'rgba(0, 255, 136, 0.7)', borderRadius: 2 },
              { label: 'Healed', data: watchdogDaily.map(d => d.healed), backgroundColor: 'rgba(0, 212, 255, 0.7)', borderRadius: 2 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 8, font: { size: 10 } } } },
            scales: {
              x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, font: { size: 9 } }, grid: { display: false } },
              y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      }

      // --- Chart 2: Daemon Heal Distribution (doughnut) ---
      const dhCtx = document.getElementById('daemonHealChart')?.getContext('2d');
      const dhEntries = Object.entries(daemonHealCounts).sort((a, b) => b[1] - a[1]);
      if (dhCtx && dhEntries.length > 0) {
        const totalHeals = dhEntries.reduce((s, e) => s + e[1], 0);
        document.getElementById('totalHealsBadge').textContent = totalHeals + ' Total';
        const dhColors = ['rgba(0,255,136,0.8)', 'rgba(0,212,255,0.8)', 'rgba(255,215,0,0.8)', 'rgba(168,85,247,0.8)', 'rgba(255,136,0,0.8)', 'rgba(255,82,82,0.8)', 'rgba(100,200,255,0.8)'];
        new Chart(dhCtx, {
          type: 'doughnut',
          data: {
            labels: dhEntries.map(e => e[0]),
            datasets: [{ data: dhEntries.map(e => e[1]), backgroundColor: dhColors.slice(0, dhEntries.length), borderWidth: 0 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, cutout: '55%',
            plugins: {
              legend: { position: 'right', labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 6, font: { size: 10 } } },
              tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.raw} heals (${Math.round(ctx.raw/totalHeals*100)}%)` } }
            }
          }
        });
      }

      // --- Chart 3: Self-Heal Health Checks (stacked bar: ok/warn/error per day) ---
      const shCtx = document.getElementById('selfHealChart')?.getContext('2d');
      if (shCtx && selfHealDaily.length > 0) {
        document.getElementById('selfHealRunsBadge').textContent = (selfHealSummary.totalRuns || 0).toLocaleString() + ' Runs';
        const shLabels = selfHealDaily.map(d => { const p = d.date.split('-'); return p[1] + '/' + p[2]; });
        new Chart(shCtx, {
          type: 'bar',
          data: {
            labels: shLabels,
            datasets: [
              { label: 'OK', data: selfHealDaily.map(d => d.ok), backgroundColor: 'rgba(0, 255, 136, 0.7)', borderRadius: 2 },
              { label: 'Warnings', data: selfHealDaily.map(d => d.warn), backgroundColor: 'rgba(255, 215, 0, 0.7)', borderRadius: 2 },
              { label: 'Errors', data: selfHealDaily.map(d => d.error), backgroundColor: 'rgba(255, 82, 82, 0.7)', borderRadius: 2 },
              { label: 'Fixed', data: selfHealDaily.map(d => d.fixed), backgroundColor: 'rgba(0, 212, 255, 0.7)', borderRadius: 2, type: 'line', fill: false, borderColor: 'rgba(0, 212, 255, 1)', pointRadius: 3, tension: 0.3, yAxisID: 'y1' }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, padding: 8, font: { size: 10 } } } },
            scales: {
              x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 9 } }, grid: { display: false } },
              y: { stacked: true, beginAtZero: true, position: 'left', title: { display: true, text: 'Checks', color: 'rgba(255,255,255,0.5)', font: { size: 10 } }, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Fixed', color: 'rgba(0,212,255,0.7)', font: { size: 10 } }, ticks: { color: 'rgba(0,212,255,0.7)' }, grid: { display: false } }
            }
          }
        });
      }

      // --- Chart 4: Data Freshness (horizontal bar) ---
      const dfCtx = document.getElementById('dataFreshnessChart')?.getContext('2d');
      if (dfCtx && dataFreshness.length > 0) {
        const dfLabels = dataFreshness.map(f => f.name);
        const dfHours = dataFreshness.map(f => f.hours >= 0 ? f.hours : 48);
        const dfMaxHours = dataFreshness.map(f => f.maxHours || 24);
        const dfColors = dataFreshness.map(f => f.fresh ? 'rgba(0, 255, 136, 0.7)' : 'rgba(255, 215, 0, 0.7)');
        new Chart(dfCtx, {
          type: 'bar',
          data: {
            labels: dfLabels,
            datasets: [
              { label: 'Age (hours)', data: dfHours, backgroundColor: dfColors, borderRadius: 4 },
              { label: 'Max Allowed', data: dfMaxHours, backgroundColor: 'rgba(255,255,255,0.1)', borderColor: 'rgba(255,255,255,0.3)', borderWidth: 1, borderDash: [4, 2], borderRadius: 4 }
            ]
          },
          options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', boxWidth: 12, font: { size: 10 } } },
              tooltip: { callbacks: { label: ctx => ctx.dataset.label === 'Age (hours)' ? `${dataFreshness[ctx.dataIndex].age}` : `Threshold: ${ctx.raw}h` } }
            },
            scales: {
              x: { beginAtZero: true, title: { display: true, text: 'Hours', color: 'rgba(255,255,255,0.5)', font: { size: 10 } }, ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } }, grid: { display: false } }
            }
          }
        });
      }

      // --- Healing Events List ---
      const healingEl = document.getElementById('healingEvents');
      document.getElementById('healingCount').textContent = healingEvents.length;
      if (healingEvents.length > 0) {
        healingEl.innerHTML = healingEvents.slice(0, 25).map(e => {
          const eDate = new Date(e.timestamp);
          const timeStr = eDate.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const actionColors = { reload: 'var(--accent-green)', detected: 'var(--accent-red)', heal: 'var(--accent-cyan)', 'deep-heal': 'var(--accent-purple)' };
          const color = actionColors[e.action] || 'var(--text-muted)';
          const icon = e.success ? '‚úì' : '‚úó';
          return `
            <div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border);">
              <span style="color:${color};font-size:1.1rem;width:20px;text-align:center;">${icon}</span>
              <div style="flex:1;">
                <div style="font-weight:500;font-size:0.85rem;">${(e.daemon || '').replace('com.claude.', '')}</div>
                <div style="font-size:0.7rem;color:var(--text-secondary);">${e.message || ''}</div>
              </div>
              <span style="padding:2px 8px;border-radius:4px;font-size:0.65rem;background:${color}22;color:${color};">${e.action}</span>
              <div style="font-size:0.65rem;color:var(--text-muted);white-space:nowrap;">${timeStr}</div>
            </div>
          `;
        }).join('');
      } else {
        healingEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:1rem;">No healing events yet</p>';
      }

      // --- Daemon Health Bars ---
      const healthBarsEl = document.getElementById('daemonHealthBars');
      if (daemons.length > 0) {
        healthBarsEl.innerHTML = daemons.map(d => {
          const name = d.name.replace('com.claude.', '');
          const color = d.loaded ? 'var(--accent-green)' : 'var(--accent-red)';
          const statusText = d.loaded ? (d.pid !== '-' ? 'Running' : 'Ready') : 'Down';
          const critBadge = d.critical ? '<span style="font-size:0.6rem;color:var(--accent-yellow);margin-left:4px;">CRIT</span>' : '';
          return `
            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;">
              <span style="width:140px;font-size:0.8rem;color:var(--text-secondary);">${name}${critBadge}</span>
              <div style="flex:1;background:var(--bg-glass);border-radius:4px;height:20px;overflow:hidden;position:relative;">
                <div style="background:${color};width:${d.loaded ? '100' : '0'}%;height:100%;transition:width 0.3s;"></div>
                <span style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.7rem;color:var(--text-primary);">${statusText}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // --- Healing Stats ---
      const successfulHeals = healingEvents.filter(e => e.success && e.action === 'reload').length;
      const today = new Date().toDateString();
      const healsToday = healingEvents.filter(e => new Date(e.timestamp).toDateString() === today).length;
      const healsByDay = {};
      healingEvents.forEach(e => { const day = new Date(e.timestamp).toDateString(); healsByDay[day] = (healsByDay[day] || 0) + 1; });
      const days = Object.keys(healsByDay).length || 1;
      const avgPerDay = (healingEvents.length / days).toFixed(1);
      const reloadEvents = healingEvents.filter(e => e.action === 'reload');
      const successRate = reloadEvents.length > 0 ? Math.round((successfulHeals / reloadEvents.length) * 100) : 100;

      document.getElementById('healingTotal').textContent = successfulHeals;
      document.getElementById('healingToday').textContent = healsToday;
      document.getElementById('healingAvgDay').textContent = avgPerDay;
      document.getElementById('healingSuccessRate').textContent = successRate + '%';

      // --- Most Healed Daemons (use pipeline data for full history) ---
      const mostHealedEl = document.getElementById('mostHealedDaemons');
      const dhSorted = Object.entries(daemonHealCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
      if (dhSorted.length > 0) {
        const maxCount = dhSorted[0][1];
        mostHealedEl.innerHTML = dhSorted.map(([name, count]) => {
          const pct = (count / maxCount) * 100;
          return `
            <div style="margin-bottom:0.75rem;">
              <div style="display:flex;justify-content:space-between;margin-bottom:0.25rem;">
                <span style="font-weight:500;font-size:0.85rem;">${name}</span>
                <span style="color:var(--accent-cyan);font-size:0.85rem;">${count}</span>
              </div>
              <div style="background:var(--bg-glass);border-radius:4px;height:8px;overflow:hidden;">
                <div style="background:var(--gradient-primary);width:${pct}%;height:100%;border-radius:4px;"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        mostHealedEl.innerHTML = '<p style="color:var(--text-muted);text-align:center;">No heals recorded yet</p>';
      }
    }

    // Render infrastructure on load
    renderInfrastructure();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Tab 16: Autonomy Streaks
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderAutonomy() {
      const data = AUTONOMY_DATA;
      if (!data || !data.record) return;

      // Record hero
      document.getElementById('autonomyRecord').textContent = data.record.durationFormatted;
      const projects = (data.record.projects || []).map(p => p.split('/').pop()).filter(Boolean).slice(0, 4);
      document.getElementById('autonomyRecordMeta').textContent =
        `${data.record.date} at ${data.record.time} ¬∑ ${data.record.toolCount.toLocaleString()} tool calls ¬∑ ${projects.join(', ')}`;

      // Stat cards
      document.getElementById('autonomyTotalStreaks').textContent = formatNumber(data.stats.totalStreaks);
      const avgMin = Math.floor(data.stats.avgDuration / 60);
      const avgSec = data.stats.avgDuration % 60;
      document.getElementById('autonomyAvgDuration').textContent = avgMin + 'm ' + avgSec + 's';
      document.getElementById('autonomyAvgGap').textContent = data.stats.avgGap + 's';
      document.getElementById('autonomyPermEvents').textContent = data.permissionEvents || '0';

      // Daily trend chart
      if (data.dailyTrend && data.dailyTrend.length > 0) {
        const ctx = document.getElementById('autonomyDailyChart');
        if (ctx) {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.dailyTrend.map(d => d.date.slice(5)),
              datasets: [{
                label: 'Longest Streak (minutes)',
                data: data.dailyTrend.map(d => Math.round(d.longest / 60)),
                backgroundColor: '#a855f799',
                borderColor: '#a855f7',
                borderWidth: 1,
                borderRadius: 3,
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', maxTicksLimit: 15 } },
                y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' }, title: { display: true, text: 'Minutes', color: '#8b949e' } }
              }
            }
          });
        }
      }

      // Distribution chart
      if (data.distribution) {
        const ctx2 = document.getElementById('autonomyDistChart');
        if (ctx2) {
          const labels = Object.keys(data.distribution);
          const values = Object.values(data.distribution);
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: values,
                backgroundColor: ['#30363d', '#238636', '#1f6feb', '#a855f7', '#f0883e', '#f85149'],
                borderWidth: 0,
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'right', labels: { color: '#c9d1d9', font: { size: 11 } } }
              }
            }
          });
        }
      }

      // Leaderboard table
      const tbody = document.getElementById('autonomyLeaderboard');
      if (tbody && data.topStreaks) {
        tbody.innerHTML = data.topStreaks.map((s, i) => {
          const projs = (s.projects || []).map(p => p.split('/').pop()).filter(Boolean).slice(0, 3);
          const tools = Object.entries(s.topTools || {}).slice(0, 3).map(([t, c]) => `${t}(${c})`).join(', ');
          const isRecord = i === 0;
          const rowStyle = isRecord ? 'background: #1a0a2e44; border-left: 3px solid #a855f7;' : '';
          return `<tr style="border-bottom: 1px solid #21262d; ${rowStyle}">
            <td style="padding: 8px; color: ${isRecord ? '#a855f7' : '#c9d1d9'}; font-weight: ${isRecord ? 'bold' : 'normal'};">${isRecord ? '&#9733;' : s.rank}</td>
            <td style="padding: 8px; color: #c9d1d9; font-family: monospace;">${s.durationFormatted}</td>
            <td style="padding: 8px; color: #8b949e;">${s.date} ${s.time}</td>
            <td style="padding: 8px; text-align: right; color: #c9d1d9;">${s.toolCount.toLocaleString()}</td>
            <td style="padding: 8px; text-align: right; color: #8b949e;">${s.avgGap}s</td>
            <td style="padding: 8px; color: #58a6ff;">${projs.join(', ')}</td>
            <td style="padding: 8px; color: #8b949e; font-size: 0.8rem;">${tools}</td>
          </tr>`;
        }).join('');
      }
    }
    renderAutonomy();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VAAC VELOCITY FIELD TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let velocityLoaded = false;
    let velocityChart = null;

    function renderVelocity() {
      if (velocityLoaded) return;
      velocityLoaded = true;

      fetch('/api/velocity')
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            document.getElementById('velocityFieldBars').innerHTML =
              `<div style="color:var(--accent-red);padding:1rem;">Error: ${data.error}</div>`;
            return;
          }
          renderVelocityData(data);
        })
        .catch(err => {
          document.getElementById('velocityFieldBars').innerHTML =
            `<div style="color:var(--accent-red);padding:1rem;">Failed to load: ${err.message}</div>`;
        });
    }

    function renderVelocityData(data) {
      const field = data.field || {};
      const comp = data.composition || {};
      const vaac = data.vaac || {};
      const history = data.history || [];
      const vel = vaac.velocity || {};
      const behavior = vaac.behavior || {};
      const signals = vel.signals || {};

      const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
      const elColor = (id, val, color) => {
        const e = document.getElementById(id);
        if (e) { e.textContent = val; if (color) e.style.color = color; }
      };

      // Level colors
      const levelColors = {
        surge: 'var(--accent-red)',
        active: 'var(--accent-cyan)',
        steady: 'var(--accent-yellow)',
        calm: 'var(--accent-green)'
      };

      const trendIcons = {
        accelerating: '\u2197',
        stable: '\u2192',
        decelerating: '\u2198'
      };

      // Stat cards
      const composite = field.composite || vel.composite_score || 0;
      elColor('velocityComposite', composite.toFixed(3),
        composite >= 0.7 ? 'var(--accent-red)' :
        composite >= 0.4 ? 'var(--accent-cyan)' :
        composite >= 0.2 ? 'var(--accent-yellow)' : 'var(--accent-green)');

      const level = vel.level || 'calm';
      elColor('velocityLevel', level.toUpperCase(), levelColors[level]);
      el('velocityAgents', comp.agents || behavior.agent_count || '‚Äî');
      el('velocityParallelism', comp.parallelism || behavior.parallelism || '‚Äî');
      el('velocityEffort', comp.effort || behavior.effort || '‚Äî');

      const trend = vel.trend || behavior.trend || 'stable';
      elColor('velocityTrend', (trendIcons[trend] || '') + ' ' + trend,
        trend === 'accelerating' ? 'var(--accent-green)' :
        trend === 'decelerating' ? 'var(--accent-red)' : 'var(--text-secondary)');

      // 10D Velocity Field bars
      const dims = field.dimensions || {};
      const dimNames = data.dim_names || Object.keys(dims);
      const barsEl = document.getElementById('velocityFieldBars');
      if (barsEl && Object.keys(dims).length > 0) {
        const dimColors = [
          'var(--accent-cyan)', 'var(--accent-cyan)',    // signal, accel
          'var(--accent-purple)', 'var(--accent-green)',  // relevance, task
          'var(--accent-yellow)', 'var(--accent-orange)', // variance, energy
          'var(--accent-green)', 'var(--accent-cyan)',    // flow, trend
          'var(--accent-purple)', 'var(--accent-red)'     // churn, error
        ];
        barsEl.innerHTML = Object.entries(dims).map(([name, val], i) => {
          const pct = Math.round(val * 100);
          const color = dimColors[i] || 'var(--accent-cyan)';
          return `
            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:6px;">
              <span style="width:160px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;font-size:0.8rem;">${name}</span>
              <div style="flex:1;height:22px;background:var(--bg-secondary);border-radius:4px;overflow:hidden;position:relative;">
                <div style="width:${pct}%;height:100%;background:${color};border-radius:4px;transition:width 0.5s;opacity:0.85;"></div>
              </div>
              <span style="width:50px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:${color};">${val.toFixed(3)}</span>
            </div>`;
        }).join('');

        // Magnitude bar
        const mag = field.magnitude || 0;
        barsEl.innerHTML += `
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:0.75rem;">
            <span style="width:160px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:600;">MAGNITUDE</span>
            <div style="flex:1;height:26px;background:var(--bg-secondary);border-radius:4px;overflow:hidden;">
              <div style="width:${Math.round(mag*100)}%;height:100%;background:var(--gradient-primary);border-radius:4px;"></div>
            </div>
            <span style="width:50px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:0.9rem;font-weight:600;color:var(--text-primary);">${mag.toFixed(3)}</span>
          </div>`;
      }

      // Team composition
      const mixEl = document.getElementById('velocityTeamMix');
      const mix = comp.mix || behavior.team_mix || [];
      if (mixEl && mix.length > 0) {
        const roleColors = {
          scout: { bg: '#1a2332', border: '#58a6ff', icon: '\uD83D\uDD0D' },
          builder: { bg: '#1a2e1a', border: '#3fb950', icon: '\uD83D\uDD28' },
          architect: { bg: '#2e1a2e', border: '#bc8cff', icon: '\uD83C\uDFD7' },
          monitor: { bg: '#2e2e1a', border: '#d29922', icon: '\uD83D\uDCE1' }
        };
        mixEl.innerHTML = mix.map(m => {
          const rc = roleColors[m.role] || { bg: '#1a1a1a', border: '#666', icon: '\u2022' };
          return `
            <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;margin-bottom:8px;background:${rc.bg};border:1px solid ${rc.border};border-radius:8px;">
              <span style="font-size:1.5rem;">${rc.icon}</span>
              <div style="flex:1;">
                <div style="color:${rc.border};font-weight:600;text-transform:uppercase;font-size:0.8rem;letter-spacing:0.05em;">${m.role}</div>
                <div style="color:var(--text-secondary);font-size:0.75rem;">${m.model} \u00D7 ${m.count}</div>
              </div>
              <span style="font-family:'JetBrains Mono',monospace;font-size:1.4rem;color:${rc.border};">${m.count}</span>
            </div>`;
        }).join('');

        // Summary line
        const totalAgents = mix.reduce((s, m) => s + m.count, 0);
        mixEl.innerHTML += `
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;justify-content:space-between;color:var(--text-muted);font-size:0.8rem;">
            <span>Total: ${totalAgents} agents</span>
            <span>Parallelism: ${comp.parallelism_score ? (comp.parallelism_score * 100).toFixed(0) + '%' : comp.parallelism || '‚Äî'}</span>
          </div>`;
      }

      // VAAC 3-signal breakdown
      const sigEl = document.getElementById('velocitySignals');
      if (sigEl && Object.keys(signals).length > 0) {
        const sigConfigs = {
          signal: { label: 'X Signal', color: 'var(--accent-cyan)', weight: '40%', icon: '\uD83D\uDCE1' },
          task: { label: 'Task Velocity', color: 'var(--accent-green)', weight: '35%', icon: '\u26A1' },
          cognitive: { label: 'Cognitive', color: 'var(--accent-purple)', weight: '25%', icon: '\uD83E\uDDE0' }
        };
        sigEl.innerHTML = Object.entries(signals).map(([key, sig]) => {
          const sc = sigConfigs[key] || { label: key, color: 'var(--text-secondary)', weight: '?', icon: '\u2022' };
          const score = sig.score || 0;
          const pct = Math.round(score * 100);
          return `
            <div style="margin-bottom:14px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <span style="color:var(--text-secondary);font-size:0.8rem;">${sc.icon} ${sc.label} (${sc.weight})</span>
                <span style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:${sc.color};">${score.toFixed(3)}</span>
              </div>
              <div style="height:20px;background:var(--bg-secondary);border-radius:4px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:${sc.color};border-radius:4px;opacity:0.8;"></div>
              </div>
              ${sig.source ? `<div style="color:var(--text-muted);font-size:0.7rem;margin-top:3px;">${sig.source}</div>` : ''}
            </div>`;
        }).join('');
      }

      // Velocity history chart
      if (history.length > 0) {
        const ctx = document.getElementById('velocityHistoryChart');
        if (ctx) {
          const labels = history.map(h => {
            const ts = h.timestamp || '';
            return ts.length > 16 ? ts.slice(11, 16) : ts;
          });
          const scores = history.map(h => h.composite_score || 0);

          if (velocityChart) velocityChart.destroy();
          velocityChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Composite Velocity',
                data: scores,
                borderColor: '#00d9ff',
                backgroundColor: 'rgba(0, 217, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 2,
                pointHoverRadius: 5,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  min: 0, max: 1,
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { color: '#666' }
                },
                x: {
                  grid: { color: 'rgba(255,255,255,0.03)' },
                  ticks: { color: '#666', maxRotation: 45 }
                }
              },
              plugins: {
                legend: { labels: { color: '#999' } },
                annotation: {
                  annotations: {
                    surgeLine: { type: 'line', yMin: 0.7, yMax: 0.7, borderColor: 'rgba(255, 77, 106, 0.4)', borderDash: [5, 5], borderWidth: 1 },
                    activeLine: { type: 'line', yMin: 0.4, yMax: 0.4, borderColor: 'rgba(0, 217, 255, 0.3)', borderDash: [5, 5], borderWidth: 1 },
                    steadyLine: { type: 'line', yMin: 0.2, yMax: 0.2, borderColor: 'rgba(255, 204, 0, 0.3)', borderDash: [5, 5], borderWidth: 1 },
                  }
                }
              }
            }
          });
        }
      }

      el('velocityFieldTime', data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '‚Äî');
    }

    // ‚îÄ‚îÄ‚îÄ Live Tool Analytics (fetches from /api/tools) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _liveToolsLoaded = false;
    async function loadLiveToolAnalytics() {
      if (_liveToolsLoaded) return;
      try {
        const r = await fetch('/api/tools?days=30');
        const data = await r.json();
        if (data.error_note) return;
        const t = data.totals || {};
        const usage = data.usage || [];
        const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
        el('taTotalCalls', formatNumber(t.total_events || 0));
        el('taUniqueTools', t.unique_tools || 0);
        el('taSuccessRate', (t.overall_success_rate || 100) + '%');
        el('taTotalFailures', formatNumber(usage.reduce((s, u) => s + (u.failure_count || 0), 0)));
        if (usage.length > 0) el('taTopTool', usage[0].tool_name + ' (' + formatNumber(usage[0].total_calls) + ')');
        el('taAvgDaily', formatNumber(Math.round((t.total_events || 0) / 30)));
        const byTool = {};
        usage.forEach(u => { byTool[u.tool_name] = u.total_calls; });
        const coreCount = ['Bash','Read','Edit','Write'].reduce((s, tn) => s + (byTool[tn] || 0), 0);
        const searchCount = ['Grep','Glob'].reduce((s, tn) => s + (byTool[tn] || 0), 0);
        const advCount = Math.max(0, (t.total_events || 0) - coreCount - searchCount);
        el('taCoreCount', formatNumber(coreCount));
        el('taCorePct', t.total_events > 0 ? ((coreCount / t.total_events) * 100).toFixed(1) + '%' : '0%');
        el('taSearchCount', formatNumber(searchCount));
        el('taSearchPct', t.total_events > 0 ? ((searchCount / t.total_events) * 100).toFixed(1) + '%' : '0%');
        el('taAdvancedCount', formatNumber(advCount));
        el('taAdvancedPct', t.total_events > 0 ? ((advCount / t.total_events) * 100).toFixed(1) + '%' : '0%');
        _liveToolsLoaded = true;
      } catch (e) { console.warn('Live tool analytics fetch failed:', e); }
    }

    // ‚îÄ‚îÄ‚îÄ Expertise Routing Heatmap (fetches from /api/expertise) ‚îÄ
    let _expertiseLoaded = false;
    async function loadExpertiseHeatmap() {
      if (_expertiseLoaded) return;
      try {
        const r = await fetch('/api/expertise');
        const data = await r.json();
        if (data.error) return;
        const heatmap = data.heatmap || [];
        const complexityDist = data.complexity_dist || [];
        const totals = data.totals || {};
        const badge = document.getElementById('taExpertiseBadge');
        if (badge) badge.textContent = (totals.unique_domains || 0) + ' domains';
        const hmEl = document.getElementById('expertiseHeatmap');
        if (hmEl && heatmap.length > 0) {
          const models = [...new Set(heatmap.map(h => h.model))].sort();
          const domainNames = [...new Set(heatmap.map(h => h.domain))];
          const lookup = {};
          heatmap.forEach(h => { lookup[h.domain + '|' + h.model] = h; });
          const maxQ = Math.max(...heatmap.map(h => h.count || 0), 1);
          const mColors = { haiku:{r:0,g:217,b:255}, sonnet:{r:0,g:230,b:118}, opus:{r:233,g:69,b:96}, flash:{r:255,g:215,b:0}, local:{r:156,g:39,b:176}, 'local-fast':{r:255,g:152,b:0} };
          let html = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
          html += '<thead><tr><th style="text-align:left;padding:8px 12px;color:var(--text-secondary);font-weight:500;">Domain</th>';
          models.forEach(m => { html += '<th style="text-align:center;padding:8px 12px;color:var(--text-secondary);font-weight:500;">' + m.charAt(0).toUpperCase() + m.slice(1) + '</th>'; });
          html += '<th style="text-align:center;padding:8px 12px;color:var(--text-secondary);font-weight:500;">Primary</th></tr></thead><tbody>';
          domainNames.forEach(domain => {
            html += '<tr><td style="padding:8px 12px;color:var(--text-primary);font-weight:500;border-bottom:1px solid var(--border);">' + domain.charAt(0).toUpperCase() + domain.slice(1) + '</td>';
            let maxModel = '', maxCount = 0;
            models.forEach(model => {
              const cell = lookup[domain + '|' + model];
              const q = cell ? (cell.count || 0) : 0;
              const mc = mColors[model] || {r:120,g:120,b:120};
              const bg = q > 0 ? 'rgba(' + mc.r + ',' + mc.g + ',' + mc.b + ',' + (0.15 + q / maxQ * 0.7).toFixed(2) + ')' : 'transparent';
              if (q > maxCount) { maxCount = q; maxModel = model; }
              html += '<td style="text-align:center;padding:8px 12px;border-bottom:1px solid var(--border);background:' + bg + ';border-radius:4px;">';
              if (q > 0) {
                html += '<div style="font-weight:600;color:var(--text-primary);">' + formatNumber(q) + '</div>';
                html += '<div style="font-size:0.7rem;color:var(--text-secondary);">exp: ' + (cell.avg_expertise || 0).toFixed(2) + '</div>';
              } else { html += '<span style="color:var(--text-secondary);opacity:0.3;">‚Äî</span>'; }
              html += '</td>';
            });
            const pc = mColors[maxModel] || {r:120,g:120,b:120};
            html += '<td style="text-align:center;padding:8px 12px;border-bottom:1px solid var(--border);">';
            if (maxModel) html += '<span style="background:rgba(' + pc.r + ',' + pc.g + ',' + pc.b + ',0.2);color:rgb(' + pc.r + ',' + pc.g + ',' + pc.b + ');padding:3px 10px;border-radius:12px;font-size:0.8rem;font-weight:600;">' + maxModel + '</span>';
            html += '</td></tr>';
          });
          html += '</tbody></table></div>';
          html += '<div style="margin-top:12px;display:flex;gap:16px;font-size:0.8rem;color:var(--text-secondary);">';
          html += '<span>' + formatNumber(totals.total_events || 0) + ' routing events</span>';
          html += '<span>' + (totals.unique_domains || 0) + ' domains</span>';
          html += '<span>avg expertise: ' + (totals.avg_expertise || 0).toFixed(2) + '</span></div>';
          hmEl.innerHTML = html;
        } else if (hmEl) { hmEl.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:2rem;">No expertise routing data yet</div>'; }
        const cxEl = document.getElementById('expertiseComplexity');
        if (cxEl && complexityDist.length > 0) {
          const byLevel = {};
          complexityDist.forEach(c => { byLevel[c.level || 'unknown'] = (byLevel[c.level || 'unknown'] || 0) + (c.count || 0); });
          const levels = Object.entries(byLevel).sort((a, b) => b[1] - a[1]);
          const maxB = Math.max(...levels.map(function(l) { return l[1]; }), 1);
          const lColors = { low:'rgba(0,217,255,0.7)', medium:'rgba(0,230,118,0.7)', high:'rgba(255,152,0,0.7)', extreme:'rgba(233,69,96,0.7)' };
          let cxHtml = '';
          levels.forEach(function(pair) {
            const level = pair[0], count = pair[1];
            const pct = (count / maxB * 100).toFixed(0);
            const color = lColors[level] || 'rgba(120,120,120,0.7)';
            cxHtml += '<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:4px;"><span style="color:var(--text-primary);font-weight:500;">' + level.charAt(0).toUpperCase() + level.slice(1) + '</span><span style="color:var(--text-secondary);">' + formatNumber(count) + '</span></div><div style="background:var(--bg-hover);border-radius:4px;height:10px;overflow:hidden;"><div style="width:' + pct + '%;height:100%;background:' + color + ';border-radius:4px;transition:width 0.5s;"></div></div></div>';
          });
          cxEl.innerHTML = cxHtml;
        } else if (cxEl) { cxEl.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:2rem;">No complexity data</div>'; }
        _expertiseLoaded = true;
      } catch (e) { console.warn('Expertise heatmap fetch failed:', e); }
    }

    // ‚îÄ‚îÄ‚îÄ Lazy-load on tab switch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const origSwitchTab = switchTab;
    switchTab = function(tabId) {
      origSwitchTab(tabId);
      if (tabId === 'velocity') renderVelocity();
      if (tabId === 'tool-analytics') { loadLiveToolAnalytics(); loadExpertiseHeatmap(); }
    };
    if (window.location.hash === '#velocity') renderVelocity();
    if (window.location.hash === '#tool-analytics') { loadLiveToolAnalytics(); loadExpertiseHeatmap(); }

  </script>
</body>
</html>
